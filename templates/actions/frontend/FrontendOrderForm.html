{strip}

{$wa->globals("wa_order_form", [])}

<div class="wa-order-form-wrapper is-not-ready" id="wa-order-form-wrapper" style="visibility: hidden;">
    <script>
        ( function($) {
            $("#wa-order-form-wrapper").data("ready", $.Deferred());
        })(jQuery);
    </script>

    <div class="wa-form-body">

        {include file="./order/form/auth.html" inline}

        {$_hide_region = false}
        {$_form_globals = $wa->globals("wa_order_form")}
        {if !empty($_form_globals["auth"]["locked"])}
            {$_hide_region = true}
        {/if}

        {include file="./order/form/region.html" _hide_region=$_hide_region inline}

        {include file="./order/form/shipping.html" inline}

        {include file="./order/form/details.html" inline}

        {include file="./order/form/payment.html" inline}

        {$_confirm_locked = false}
        {$_form_globals = $wa->globals("wa_order_form")}
        {if !empty($_form_globals["auth"]["locked"])}
            {$_confirm_locked = true}
        {/if}

        {include file="./order/form/confirm.html" _confirm_locked=$_confirm_locked inline}

    </div>

    <footer class="wa-form-footer js-form-footer">
        {if !empty($config["shipping"]["service_agreement"])}
            <div class="wa-line">
                {$config["shipping"]["service_agreement_hint"]|default:""}
            </div>
        {/if}
    </footer>

    <script>
        ( function($) { "use strict";
            load([
                {
                    id: "wa-order-ui-css",
                    type: "css",
                    uri: "{$wa_app_static_url}css/frontend/order/ui.css?v={$wa->version()}"
                },
                {
                    id: "wa-order-ui-js",
                    type: "js",
                    uri: "{$wa_app_static_url}js/frontend/order/ui.js?v={$wa->version()}"
                },
                {
                    id: "wa-order-jquery-ui-js",
                    type: "js",
                    uri: "{$wa_app_static_url}js/frontend/order/jquery.datepicker.min.js?v={$wa->version()}"
                },
                {
                    id: "wa-order-form-css",
                    type: "css",
                    uri: "{$wa_app_static_url}css/frontend/order/form.css?v={$wa->version()}"
                },
                {
                    id: "wa-order-form-js",
                    type: "js",
                    uri: "{$wa_app_static_url}js/frontend/order/form.js?v={$wa->version()}"
                }
            ]).then(init);

            function load(sources) {
                var deferred = $.Deferred();

                loader(sources).then( function() {
                    deferred.resolve();
                });

                return deferred.promise();

                function loader(sources) {
                    var deferred = $.Deferred(),
                        counter = sources.length;

                    $.each(sources, function(i, source) {
                        switch (source.type) {
                            case "css":
                                loadCSS(source);
                                break;
                            case "js":
                                loadJS(source);
                                break;
                        }
                    });

                    return deferred.promise();

                    /**/

                    function loadCSS(source) {
                        var $link = $("#" + source.id);
                        if ($link.length) {
                            $link.data("promise").then(onLoad);

                        } else {
                            var deferred = $.Deferred(),
                                promise = deferred.promise();

                            $link = $("<link />", {
                                id: source.id,
                                rel: "stylesheet"
                            }).appendTo("head")
                                .data("promise", promise);

                            $link.on("load", function() {
                                onLoad();
                                deferred.resolve();
                            });

                            $link.attr("href", source.uri);
                        }

                        function onLoad() {
                            counter -= 1;
                            watcher();
                        }
                    }

                    function loadJS(source) {
                        var $script = $("#" + source.id);
                        if ($script.length) {
                            $script.data("promise").then(onLoad);

                        } else {
                            var deferred = $.Deferred(),
                                promise = deferred.promise(),
                                script = document.createElement("script");

                            $script = $(script)
                                .attr("id", source.id)
                                .appendTo("head")
                                .data("promise", promise);

                            $script.on("load", function () {
                                onLoad();
                                deferred.resolve();
                            });

                            $script.attr("src", source.uri);
                        }

                        function onLoad() {
                            counter -= 1;
                            watcher();
                        }
                    }

                    function watcher() {
                        if (counter === 0) {
                            deferred.resolve();
                        }
                    }
                }
            }

            function init() {
                window.waOrder.ui.initFormatPrice({$confirm.currency_info|default:""|json_encode});
                window.waOrder.form = new window.waOrder.Form({
                    $wrapper: $("#wa-order-form-wrapper"),
                    outer_options: {$options|json_encode},
                    locales: {
                        invalid: {_w("Validation error")|json_encode},
                        required: {_w("Required field")|json_encode}
                    },
                    urls: {
                        "calculate": {$wa->getUrl('shop/frontendOrder/calculate')|json_encode},
                        "success": {$wa->getUrl('shop/frontend/checkout', ['step'=>'success'])|json_encode},
                        "create": {$wa->getUrl('shop/frontendOrder/create')|json_encode}
                    }
                });
            }
        })(jQuery);
    </script>
</div>

{/strip}