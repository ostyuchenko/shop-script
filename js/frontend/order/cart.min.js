!function(e){"use strict";var t=function(e){function r(t){var r=t;return r.errors&&r.errors.items&&e.each(r.errors.items,function(e,t){r.cart.items&&r.cart.items[e]&&(r.cart.items[e].errors=t)}),r}return t=function(t){var r=this;if(!(t.outer_options&&"string"==typeof t.outer_options.wrapper&&t.outer_options.wrapper.length>0))throw new Error("Checkout wrapper element not specified.");var a=e(t.outer_options.wrapper);if(1!==a.length)throw new Error("Error: Checkout wrapper element must be exactly one on page (found "+a.length+")");r.$outer_wrapper=a,r.$wrapper=t.$wrapper,r.$products=r.$wrapper.find(".wa-products"),r.$coupon_section=r.$wrapper.find(".wa-coupon-section"),r.$affiliate_section=r.$wrapper.find(".wa-affiliate-section"),r.options=t.outer_options,r.templates=t.templates,r.locales=t.locales,r.urls=t.urls,r.add_services_count=0,r.add_services_deferred=e.Deferred().resolve(),r.cart_save_promise=null,r.render_scheduled=!1,r.clear_xhr=null,r.reload_xhr=null,r.update_xhr=null,r.initClass()},t.prototype.initClass=function(){var t=this;t.$wrapper.removeAttr("style").removeClass("is-not-ready"),e(document).on("addProductToCart",function(e,r){t.addProduct(r)}),t.initDeleteProduct(),t.initChangeQuantity(),t.initChangeService(),t.initCoupon(),t.initAffiliate(),t.$outer_wrapper.data("controller",t),t.trigger("ready",t)},t.prototype.DEBUG=function(){var e=this,t=console.log,r={hint:"font-weight: bold; color: #666;",info:"font-weight: bold; font-size: 1.25em; color: blue;",warn:"font-weight: bold; font-size: 1.25em;",error:"font-weight: bold; font-size: 1.25em;"};if(e.options&&e.options.DEBUG){if(r[arguments[1]]){switch(arguments[0]="string"==typeof arguments[0]?"%c"+arguments[0]:arguments[0],arguments[1]){case"info":t=console.info;break;case"error":t=console.error;break;case"warn":t=console.warn}arguments[1]=r[arguments[1]]}return t.apply(console,arguments)}},t.prototype.initDeleteProduct=function(){var t=this;t.$wrapper.on("click",".js-delete-product",function(r){r.preventDefault();var a=e(this).closest(".wa-product");t.deleteProduct(a).then(function(e){a.remove(),t.updateCart(e)})})},t.prototype.initChangeQuantity=function(){function t(e,t){var r=e.find(".js-product-quantity"),a=r.is(":disabled"),i=parseFloat(r.val()),o=i+(t?1:-1);a||(o>0?r.val(o).trigger("change"):n.deleteProduct(e).then(function(t){e.remove(),n.updateCart(t)}))}function r(e){var t=e.closest(".wa-product"),r=function(e){var t=1;e=e.replace(",",".");var r=parseFloat(e);return isNaN(r)||(t=r),t}(e.val());t.data("id");e.val(r).attr("disabled",!0),i(e),r>0?(e.data("before_value",r),n.saveCart().always(function(){e.attr("disabled",!1)}).then(function(e){n.updateCart(e)})):n.deleteProduct(t).then(function(e){t.remove(),n.updateCart(e)},function(t){var r=e.data("before_value");r&&e.val(r)})}function a(t,r){function a(){return e(n.templates.error)}var o=t.closest(".wa-quantity-section"),s=o.closest(".wa-product"),d=s.find(".js-product-price"),c=parseFloat(t.val());if(r.max>0?t.attr("data-max",r.max).data("max",r.max):t.removeAttr("data-max").removeData("max"),0===r.max)t.addClass("wa-error"),d.hide(),a().text(n.locales.quantity_empty).appendTo(o),s.addClass("is-out-of-stock");else if(r.max<c){t.addClass("wa-error"),d.hide();var l=n.locales.quantity_stock_error.replace("%s",r.max);a().text(l).appendTo(o),s.addClass("is-more-than-limit")}else r.errors?r.errors.quantity&&(t.addClass("wa-error"),d.hide(),a().text(r.errors.quantity).appendTo(o),s.addClass("is-more-than-limit")):(c!==r.quantity&&(t.val(r.quantity).data("before_value",r.quantity),i(t)),r.quantity>1?d.show():d.hide(),t.removeClass("wa-error"));!function(){var e=n.locales.quantity_decrease,t=n.locales.quantity_increase;0!==r.max&&1!==c||(e=n.locales.quantity_delete),c>=r.max&&(t=n.locales.quantity_limit),o.find(".js-decrease .wa-tooltip").attr("data-title",e),o.find(".js-increase .wa-tooltip").attr("data-title",t)}()}function i(e){var t=e.closest(".wa-quantity-box"),r=t.find(".js-increase"),a=e.val(),i=e.data("max");i>0&&a>=i?r.addClass(o):r.removeClass(o)}var n=this,o="is-disabled";n.$products.on("click",".js-increase",function(r){r.preventDefault();var a=e(this);if(!a.hasClass(o)){t(a.closest(".wa-product"),!0)}}),n.$products.on("click",".js-decrease",function(r){r.preventDefault();var a=e(this);if(!a.hasClass(o)){t(a.closest(".wa-product"),!1)}}),n.$products.find("input.js-product-quantity").each(function(){var t=e(this);t.data("before_value",t.val()),t.on("change",function(){n.hideErrors(e(this).closest(".wa-quantity-section")),r(e(this))}).on("update",function(t,r){a(e(this),r)})})},t.prototype.initChangeService=function(){function t(){var t=e(this),r=t.closest(".wa-product"),i=t.closest(".wa-service"),n=i.find(".wa-variant select.js-variant-field"),o=t.is(":checked"),s=r.data("id"),d=i.data("service-id"),c=i.find(".js-variant-field:first").val();if(o){var l={"item[parent_id]":s,"item[service_id]":d,"item[service_variant_id]":c};t.attr("disabled",!0).trigger("disabled"),a.addService(l).always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){var t=e.just_added_item.id;i.addClass("is-active").attr("data-id",t).data("id",t).attr("data-enabled","1").data("enabled",1),n.length&&n.attr("disabled",!1).trigger("enabled"),a.DEBUG("Service added.","info",i[0],e),a.cart_save_promise?a.cart_save_promise.then(function(e){a.updateCart(e)}):a.updateCart(e)},function(e,r){a.DEBUG("Add service is aborted.","warn",e,r),t.attr("checked",!1)})}else i.removeClass("is-active").attr("data-enabled","0").data("enabled",0),n.length&&n.attr("disabled",!0).trigger("disabled"),t.attr("disabled",!0).trigger("disabled"),a.saveCart().always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){a.updateCart(e)})}function r(){var t=e(this);t.attr("disabled",!0).trigger("disabled"),a.saveCart().always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){a.DEBUG("Service variant Changed.","info",t[0]),a.updateCart(e)})}var a=this;a.$wrapper.on("change",".wa-service input.js-service-field",t),a.$wrapper.on("change",".wa-service .js-variant-field",r)},t.prototype.initCoupon=function(){function e(){i.attr("data-enabled","1").data("enabled",1),a.saveCart().then(function(e){a.updateCart(e)})}function t(){i.attr("data-enabled","0").data("enabled",0),n.val(""),a.saveCart().then(function(e){a.updateCart(e)})}function r(){i.find(".js-error-text").remove()}var a=this,i=a.$coupon_section;if(!i.length)return!1;var n=i.find("input.js-coupon-code");i.on("click",".js-use-coupon",function(r){r.preventDefault(),n.val().length?e():t()}),i.on("click",".js-cancel-coupon",function(e){e.preventDefault(),t()}),a.$wrapper.on("before_update",r),n.on("focus",r)},t.prototype.initAffiliate=function(){var e=this,t=e.$affiliate_section;if(!t.length)return!1;t.on("click",".js-use-bonus",function(r){r.preventDefault(),t.attr("data-enabled","1").data("enabled",1),e.saveCart().then(function(t){e.updateCart(t)})}),t.on("click",".js-cancel-bonus",function(r){r.preventDefault(),t.attr("data-enabled","0").data("enabled",0),e.saveCart().then(function(t){e.updateCart(t)})})},t.prototype.updateCart=function(e){function t(){r.render_scheduled=setTimeout(function(){r.render_scheduled=!1,r.renderCart(e)},50)}var r=this;if(r.render_scheduled)return void(!0!==r.render_scheduled&&(clearTimeout(r.render_scheduled),t()));t()},t.prototype.renderCart=function(t){function r(){var r=t.cart;e("#wa-cart-subtotal .js-price").html(o.formatPrice(r.subtotal)),e("#wa-cart-total .js-price").html(o.formatPrice(r.total));var a=e("#wa-cart-full-discount");if(a){var i=a.find(".js-price"),n=0;r.discount>0&&(n+=r.discount),t.coupon_discount>0&&(n+=t.coupon_discount),t.affiliate&&t.affiliate.used_affiliate_bonus>0&&(n+=t.affiliate.used_affiliate_bonus),n>0?(a.show(),i.html(o.formatPrice(n))):(a.hide(),i.html(o.formatPrice(0)))}var s=e("#wa-cart-discount");if(s.length){var d=s.find(".js-price");r.discount>0?(s.show(),d.html(o.formatPrice(r.discount))):(s.hide(),d.html(o.formatPrice(0)))}var c=e("#wa-cart-discount-coupon");if(c.length){var l=c.find(".js-price");t.coupon_discount>0?(c.show(),l.html(o.formatPrice(t.coupon_discount))):(c.hide(),l.html(o.formatPrice(0)))}var u=e("#wa-cart-discount-affiliate");if(u.length){var f=u.find(".js-price");t.affiliate&&t.affiliate.used_affiliate_bonus>0?(u.show(),f.html(o.formatPrice(t.affiliate.used_affiliate_bonus))):(u.hide(),f.html(o.formatPrice(0)))}var p=e("#wa-affiliate-order-bonus");p.length&&(t.affiliate&&t.affiliate.add_affiliate_bonus>0?p.html(o.locales.affiliate_bonus.replace("%s",o.formatPrice(t.affiliate.add_affiliate_bonus))).show():p.hide().html(""));var v=e("#wa-affiliate-order-discount");if(v.length){var h=t.affiliate&&t.affiliate.affiliate_discount>0?t.affiliate.affiliate_discount:0;v.html(o.formatPrice(h))}var _=o.$wrapper.find("#wa-cart-weight"),m=function(){var e=!1,t=o.locales.weight_total;return r.count_html&&r.total_weight_html&&(e=t.replace("%s",r.count_html).replace("%s",r.total_weight_html)),e}();m?_.html(m).show():_.hide().html("")}function a(e){o.DEBUG("ERRORS:","warn",e)}function i(){function r(t,r){function i(t){e(o.templates.error).text(t).appendTo(a)}"boolean"!=typeof t&&(t=!a.hasClass("is-active")),t?a.addClass("is-active"):a.removeClass("is-active"),r&&r.length&&e.each(r,function(e,t){i(t)})}var a=o.$coupon_section;if(!a.length)return!1;t.coupon_code&&t.coupon_code.length?t.coupon_discount||t.coupon_free_shipping?r(!0):r(!1,[o.locales.coupon_invalid]):r(!1)}function n(){function e(e){"boolean"!=typeof e&&(e=!r.hasClass("is-active")),e?(r.addClass("is-active"),r.attr("data-enabled","1").data("enabled",1)):(r.removeClass("is-active"),r.attr("data-enabled","0").data("enabled",0))}var r=o.$affiliate_section;if(!r.length)return!1;e(!!t.affiliate.use_affiliate)}var o=this;if(!t)return o.DEBUG("API is required!","error"),!1;o.hideErrors();var s=o.$products.find(".wa-product"),d={};return s.each(function(){var t=e(this),r=t.data("id");d[r]=t}),function(t){function r(t,r){var a=parseFloat(r.quantity);t.find("input.js-product-quantity").trigger("update",{quantity:a,max:parseFloat(r.stock_count),errors:r.errors?r.errors:null});var i=t.find(".js-product-full-price"),n=o.formatPrice(r.full_price);i.html(n);var s=t.find(".js-product-discount");if(s.length){var d=s.find(".js-discount");r.discount>0?(s.show(),d.html(o.formatPrice(r.discount))):(s.hide(),d.html(o.formatPrice(0)))}var c=t.find(".js-product-compare");c.length&&(r.full_compare_price>0?c.show().html(o.formatPrice(r.full_compare_price)):c.hide().html(o.formatPrice(0)));var l=t.find(".wa-service"),u={},f=r.services,p=f?Object.keys(f).length:0;l.length!==p&&o.DEBUG("DOM services !== server services","error",t[0]),l.each(function(){var t=e(this),r=t.data("service-id");r&&(u[r]=t)}),e.each(f,function(e,t){if(u[e]){var r=u[e],a=r.find("input.js-service-field"),i=r.find(".wa-variant select.js-variant-field"),n=t.id,o=!!n;o?(a.attr("checked",!0),r.addClass("is-active").attr("data-id",n).data("id",n).attr("data-enabled","1").data("enabled",1),i.length&&i.attr("disabled",!1).trigger("enabled")):(a.attr("checked",!1),r.removeClass("is-active").attr("data-id","").removeData("id").attr("data-enabled","0").data("enabled",0),i.length&&i.attr("disabled",!0).trigger("disabled"))}})}var a=e.Deferred(),i=Object.keys(t).length;return s.length!==i?a.reject():(e.each(t,function(e,t){var i=t.id,n=d[i];n?r(n,t):a.reject()}),a.resolve()),a.promise()}(t.cart.items).then(function(){i(),n(),r(),t.errors&&a(t.errors),o.DEBUG("UI updated.","info"),o.trigger("rendered",t)},function(){o.DEBUG("UI and Data API distinctions","error"),o.reload()}),!0},t.prototype.saveCart=function(){function t(){a.add_services_deferred.promise().then(function(){var n=a.getCartData();a.trigger("before_update",a),a.update_xhr=e.post(a.urls.save,n,"json").done(function(e){if("ok"===e.status){var t=r(e.data);a.DEBUG("API received:","info"),a.DEBUG(t),a.trigger("updated",t),a.trigger("changed",t),i.resolve(t)}else a.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),i.reject("fail",e)}).fail(function(e,r){"abort"===r?a.add_services_deferred.promise().then(t):(a.DEBUG("Getting API aborted.","error",r),i.reject(r))})})}var a=this;if(a.cart_save_promise)return a.update_xhr&&a.update_xhr.abort(),a.cart_save_promise;var i=e.Deferred();return a.cart_save_promise=i.promise(),a.cart_save_promise.always(function(){a.cart_save_promise=null,a.update_xhr=null}),t(),a.cart_save_promise},t.prototype.getCartData=function(){var t=this,r={items:function(){function r(t){var r=[];return t.find(".wa-service").each(function(){var t=e(this),a=t.data("id");if(a){var i=t.find(".js-variant-field"),n=i.val(),o=1===t.data("enabled")?1:0;r.push({id:a,service_variant_id:n,enabled:o})}}),r}var a=[];return t.$products.find(".wa-product").each(function(){var t=e(this),i=t.data("id"),n=t.find("input.js-product-quantity"),o=parseFloat(n.val());o=o>0?o:0,a.push({id:i,quantity:o,services:r(t)})}),a}(),coupon:function(){var e={enabled:0,code:""};if(t.$coupon_section.length){e.enabled=1===t.$coupon_section.data("enabled")?1:0;var r=t.$coupon_section.find(".js-coupon-code");if(r.length){var a=r.val();a.length&&(e.code=a)}}return e}(),affiliate:function(){var e={enabled:0};return t.$affiliate_section.length&&(e.enabled=1===t.$affiliate_section.data("enabled")?1:0),e}()};return t.DEBUG("Cart data for save:","hint"),t.DEBUG(r),r},t.prototype.hideErrors=function(e){var t=this;e=e&&e.length?e:t.$wrapper;if(e.hasClass("wa-error")?e.removeClass("wa-error"):e.hasClass("js-error-text")?e.remove():(e.find(".wa-error").removeClass("wa-error"),e.find(".js-error-text").remove()),e[0]===t.$wrapper[0]){e.find(".wa-product").removeClass("is-more-than-limit").removeClass("is-out-of-stock")}},t.prototype.trigger=function(e,t){var r=this,a="wa_order_cart_"+e;r.$wrapper.triggerHandler(e,t||null),r.$outer_wrapper.trigger(a,t||null)},t.prototype.formatPrice=function(e,t){var r=e;return window.waOrder.ui.formatPrice&&(r=window.waOrder.ui.formatPrice(e,t)),r},t.prototype.addService=function(t){var a=this;0===a.add_services_count&&(a.add_services_deferred=e.Deferred()),a.add_services_count+=1,a.update_xhr&&a.update_xhr.abort();var i=e.Deferred();return e.post(a.urls.add,t,"json").done(function(e){if("ok"===e.status){var t=r(e.data);a.DEBUG("Service successfully added.","info",t),a.trigger("changed",t),i.resolve(t)}else a.DEBUG("Add service canceled.","warn",e),i.reject("fail",e)}).fail(function(e,t){a.DEBUG("Add service is failed.","error",t),i.reject(t)}).always(function(){a.add_services_count-=1,0===a.add_services_count&&a.add_services_deferred.resolve()}),i.promise()},t.prototype.addProduct=function(t){var r=this,a=e.Deferred();return function(t){var a=e.Deferred(),i=r.urls.add;return e.post(i,t,function(e){"ok"===e.status?a.resolve(e.data):a.reject(e.errors)},"json"),a.promise()}(t).then(function(e){r.reload().then(function(e){a.resolve(e)})}),a.promise()},t.prototype.deleteProduct=function(t){var r=this,a=e.Deferred(),i=t.find("input.js-product-quantity");return function(){var a=e.Deferred(),i=!1,n=r.templates.delete_product_dialog,o=t.find(".wa-details-section .wa-details .wa-name").text();return n=n.replace("%message%",o),new window.waOrder.ui.Dialog({$wrapper:e(n),onOpen:function(e,t){e.on("click",".js-confirm",function(){i=!0,t.close()}),e.on("click",".js-cancel",function(){t.close()})},onClose:function(){i?a.resolve():a.reject()}}),a.promise()}().then(function(){t.data("id");i.val(0).attr("disabled",!0).trigger("disabled"),r.saveCart().always(function(){i.attr("disabled",!1).trigger("enabled")}).then(function(e){var t=0;e&&e.cart&&"object"==typeof e.cart.items&&(t=Object.keys(e.cart.items).length),t>0?a.resolve(e):location.reload()},function(e){a.reject(e)})},function(){parseFloat(i.val())>0||i.val("1"),i.attr("disabled",!1).trigger("enabled"),a.reject("cancel")}),a.promise()},t.prototype.clear=function(t){function a(){var t=i.getCartData();e.each(t.items,function(e,t){t.quantity=0}),t.affiliate&&(t.affiliate.enabled=0),t.coupon&&(t.coupon.code="",t.coupon.enabled=0),i.clear_xhr=e.post(i.urls.save,t,"json").done(function(e){if("ok"===e.status){var t=r(e.data);i.DEBUG("Cart is cleared.","info",e),i.trigger("cleared",t),i.trigger("changed",t),n.resolve(e)}else i.DEBUG("Cart isn't cleared.","error",e.errors?e.errors:"No error description"),n.reject("fail")}).fail(function(e,t){i.DEBUG("Getting API aborted.","error",t),n.reject(t)}).always(function(){i.clear_xhr=null})}var i=this,n=e.Deferred();return t=t||{},i.clear_xhr?n.reject("running"):t.confirm?function(){var t=e.Deferred(),r=!1;return new window.waOrder.ui.Dialog({$wrapper:e(i.templates.clear_cart_dialog),onOpen:function(e,t){e.on("click",".js-confirm",function(){r=!0,t.close()}),e.on("click",".js-cancel",function(){t.close()})},onClose:function(){r?t.resolve():t.reject()}}),t.promise()}().then(function(){a()},function(){n.reject("cancel")}):a(),n.promise()},t.prototype.reload=function(){var t=this,r=e.Deferred(),a=t.urls.refresh,i={opts:t.options};return t.reload_xhr||(t.$wrapper.addClass("is-locked"),t.trigger("before_reload",t),t.reload_xhr=e.post(a,i,function(e){t.$outer_wrapper.one("wa_order_cart_ready",function(){var e=t.$outer_wrapper.data("controller");r.resolve(e)}),t.$wrapper.replaceWith(e),t.trigger("reloaded",t)}).always(function(){t.$wrapper.removeClass("is-locked"),t.reload_xhr=!1})),r.promise()},t}(e);window.waOrder=window.waOrder||{},window.waOrder.Cart=t}(jQuery);
//# sourceMappingURL=cart.min.js.map
