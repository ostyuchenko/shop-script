!function(e){"use strict";var t=function(e){function a(t){var a=t;return a.errors&&a.errors.items&&e.each(a.errors.items,function(e,t){a.cart.items&&a.cart.items[e]&&(a.cart.items[e].errors=t)}),a}return t=function(t){var a=this;if(!(t.outer_options&&"string"==typeof t.outer_options.wrapper&&t.outer_options.wrapper.length>0))throw new Error("Checkout wrapper element not specified.");var r=e(t.outer_options.wrapper);if(1!==r.length)throw new Error("Error: Checkout wrapper element must be exactly one on page (found "+r.length+")");a.$outer_wrapper=r,a.$wrapper=t.$wrapper,a.$products=a.$wrapper.find(".wa-products"),a.$coupon_section=a.$wrapper.find(".wa-coupon-section"),a.$affiliate_section=a.$wrapper.find(".wa-affiliate-section"),a.options=t.outer_options,a.weight_enabled=t.weight_enabled,a.templates=t.templates,a.locales=t.locales,a.urls=t.urls,a.add_services_count=0,a.add_services_deferred=e.Deferred().resolve(),a.cart_save_promise=null,a.render_scheduled=!1,a.clear_xhr=null,a.reload_xhr=null,a.update_xhr=null,a.initClass()},t.prototype.initClass=function(){function t(a,r){e.contains(document,o.$wrapper[0])?o.reload():s.off("wa_order_product_added",t)}function a(){if(e.contains(document,o.$wrapper[0])){var t=o.$wrapper,r=o.$wrapper.find(".wa-error-text");r.length&&(t=r.first()),e("html, body").scrollTop(t.offset().top-40),o.reload()}else s.off("wa_order_cart_invalid",a)}function r(){e.contains(document,o.$wrapper[0])?o.lock(!0):e(document).off("wa_auth_contact_logged",r)}function i(){e.contains(document,o.$wrapper[0])?o.lock(!0):s.off("wa_auth_contact_logout",i)}function n(){e.contains(document,o.$wrapper[0])?o.lock(!0):s.off("wa_order_reload_start",n)}var o=this,s=e(document);o.$wrapper.find(".wa-cart-body > .wa-cart-loader").remove(),o.$wrapper.removeClass("is-not-ready").find(".js-invisible-content").removeAttr("style").removeClass("js-invisible-content"),o.$outer_wrapper.data("controller",o),o.trigger("ready",o),o.initEditProduct(),o.initDeleteProduct(),o.initChangeQuantity(),o.initChangeService(),o.initCoupon(),o.initAffiliate(),s.on("wa_order_product_added",t),s.on("wa_order_cart_invalid",a),s.on("wa_auth_contact_logged",r),s.on("wa_auth_contact_logout",i),s.on("wa_order_reload_start",n)},t.prototype.DEBUG=function(){var e=this,t=console.log,a={hint:"font-weight: bold; color: #666;",info:"font-weight: bold; font-size: 1.25em; color: blue;",warn:"font-weight: bold; font-size: 1.25em;",error:"font-weight: bold; font-size: 1.25em;"};if(e.options&&e.options.DEBUG){if(a[arguments[1]]){switch(arguments[0]="string"==typeof arguments[0]?"%c"+arguments[0]:arguments[0],arguments[1]){case"info":t=console.info;break;case"error":t=console.error;break;case"warn":t=console.warn}arguments[1]=a[arguments[1]]}return t.apply(console,arguments)}},t.prototype.initDeleteProduct=function(){var t=this;t.$wrapper.on("click",".js-delete-product",function(a){a.preventDefault();var r=e(this).closest(".wa-product");t.deleteProduct(r).then(function(e){r.remove(),t.updateCart(e)})})},t.prototype.initEditProduct=function(){function t(t){var a=[],i=t.data("product-id");i?a.push({name:"id",value:i}):r.DEBUG("Product ID required","error");var n=t.data("sku-id");return n&&a.push({name:"sku_id",value:n}),t.find(".wa-service.is-active").each(function(){var t=e(this),r=t.data("service-id"),i=t.find(".js-variant-field"),n=i.val();r&&n&&a.push({name:"service["+r+"]",value:n})}),a}function a(a){var i=t(a),n=a.data("id");r.lock(!0);var o=r.urls.product_edit;e.post(o,i).always(function(){r.lock(!1)}).done(function(t){new window.waOrder.ui.Dialog({$wrapper:e(t),options:{scope:r,item_id:n,$product:a,onSubmit:function(t){var i=e.Deferred();a.data("sku-id",t);var n=r.saveCart();return i.resolve(n),n.then(function(e){r.reload()}),i.promise()}}})})}var r=this;r.$wrapper.on("click",".js-edit-product",function(t){t.preventDefault(),a(e(this).closest(".wa-product"))})},t.prototype.initChangeQuantity=function(){function t(e,t){var a=e.find(".js-product-quantity"),r=a.is(":disabled"),i=parseFloat(a.val()),o=i+(t?1:-1);r||(o>0?a.val(o).trigger("change"):n.deleteProduct(e).then(function(t){e.remove(),n.updateCart(t)}))}function a(e){var t=e.closest(".wa-product"),a=function(e){var t=1;e=e.replace(",",".");var a=parseFloat(e);return isNaN(a)||(t=a),t}(e.val());t.data("id");e.val(a).attr("disabled",!0),i(e),a>0?(e.data("before_value",a),n.saveCart().always(function(){e.attr("disabled",!1)}).then(function(e){n.updateCart(e)})):n.deleteProduct(t).then(function(e){t.remove(),n.updateCart(e)},function(t){var a=e.data("before_value");a&&e.val(a)})}function r(t,a){function r(){return e(n.templates.error)}var o=t.closest(".wa-quantity-section"),s=o.closest(".wa-product"),d=s.find(".js-product-price"),c=parseFloat(t.val());if(a.max>0?t.attr("data-max",a.max).data("max",a.max):t.removeAttr("data-max").removeData("max"),0===a.max)t.addClass("wa-error"),d.hide(),r().text(n.locales.quantity_empty).appendTo(o),s.addClass("is-out-of-stock");else if(a.max<c){t.addClass("wa-error"),d.hide();var l=n.locales.quantity_stock_error.replace("%s",a.max);r().text(l).appendTo(o),s.addClass("is-more-than-limit")}else a.errors?a.errors.quantity&&(t.addClass("wa-error"),d.hide(),r().text(a.errors.quantity).appendTo(o),s.addClass("is-more-than-limit")):(c!==a.quantity&&(t.val(a.quantity).data("before_value",a.quantity),i(t)),a.quantity>1?d.show():d.hide(),t.removeClass("wa-error"));!function(){var e=n.locales.quantity_decrease,t=n.locales.quantity_increase;0!==a.max&&1!==c||(e=n.locales.quantity_delete),c>=a.max&&(t=n.locales.quantity_limit),o.find(".js-decrease .wa-tooltip").attr("data-title",e),o.find(".js-increase .wa-tooltip").attr("data-title",t)}()}function i(e){var t=e.closest(".wa-quantity-box"),a=t.find(".js-increase"),r=e.val(),i=e.data("max");i>0&&r>=i?a.addClass(o):a.removeClass(o)}var n=this,o="is-disabled";n.$products.on("click",".js-increase",function(a){a.preventDefault();var r=e(this);if(!r.hasClass(o)){t(r.closest(".wa-product"),!0)}}),n.$products.on("click",".js-decrease",function(a){a.preventDefault();var r=e(this);if(!r.hasClass(o)){t(r.closest(".wa-product"),!1)}}),n.$products.find("input.js-product-quantity").each(function(){var t=e(this);t.data("before_value",t.val()),t.on("change",function(){n.hideErrors(e(this).closest(".wa-quantity-section")),a(e(this))}).on("update",function(t,a){r(e(this),a)})})},t.prototype.initChangeService=function(){function t(){var t=e(this),a=t.closest(".wa-product"),i=t.closest(".wa-service"),n=i.find(".wa-variant select.js-variant-field"),o=t.is(":checked"),s=a.data("id"),d=i.data("service-id"),c=i.find(".js-variant-field:first").val();if(o){var l={"item[parent_id]":s,"item[service_id]":d,"item[service_variant_id]":c};t.attr("disabled",!0).trigger("disabled"),r.addService(l).always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){if(e.just_added_item){var t=e.just_added_item.id;i.addClass("is-active").attr("data-id",t).data("id",t).attr("data-enabled","1").data("enabled",1),n.length&&n.attr("disabled",!1).trigger("enabled"),r.DEBUG("Service added.","info",i[0],e),r.cart_save_promise?r.cart_save_promise.then(function(e){r.updateCart(e)}):r.updateCart(e)}else r.DEBUG(e.errors,"error"),r.reload()},function(e,a){r.DEBUG("Add service is aborted.","warn",e,a),t.attr("checked",!1)})}else i.removeClass("is-active").attr("data-enabled","0").data("enabled",0),n.length&&n.attr("disabled",!0).trigger("disabled"),t.attr("disabled",!0).trigger("disabled"),r.saveCart().always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){r.updateCart(e)})}function a(){var t=e(this);t.attr("disabled",!0).trigger("disabled"),r.saveCart().always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){r.DEBUG("Service variant Changed.","info",t[0]),r.updateCart(e)})}var r=this;r.$wrapper.on("change",".wa-service input.js-service-field",t),r.$wrapper.on("change",".wa-service .js-variant-field",a)},t.prototype.initCoupon=function(){function e(){i.attr("data-enabled","1").data("enabled",1),r.saveCart().then(function(e){r.updateCart(e)})}function t(){i.attr("data-enabled","0").data("enabled",0),n.val(""),r.saveCart().then(function(e){r.updateCart(e)})}function a(){i.find(".js-error-text").remove()}var r=this,i=r.$coupon_section;if(!i.length)return!1;var n=i.find("input.js-coupon-code");i.on("click",".js-use-coupon",function(a){a.preventDefault(),n.val().length?e():t()}),i.on("click",".js-cancel-coupon",function(e){e.preventDefault(),t()}),r.$wrapper.on("before_update",a),n.on("focus",a)},t.prototype.initAffiliate=function(){var e=this,t=e.$affiliate_section;if(!t.length)return!1;t.on("click",".js-use-bonus",function(a){a.preventDefault(),t.attr("data-enabled","1").data("enabled",1),e.saveCart().then(function(t){e.updateCart(t)})}),t.on("click",".js-cancel-bonus",function(a){a.preventDefault(),t.attr("data-enabled","0").data("enabled",0),e.saveCart().then(function(t){e.updateCart(t)})})},t.prototype.updateCart=function(e){function t(){a.render_scheduled=setTimeout(function(){a.render_scheduled=!1,a.renderCart(e)},50)}var a=this;if(a.render_scheduled)return void(!0!==a.render_scheduled&&(clearTimeout(a.render_scheduled),t()));t()},t.prototype.renderCart=function(t){function a(){var a=t.cart;e("#wa-cart-subtotal .js-price").html(o.formatPrice(a.subtotal)),e("#wa-cart-total .js-price").html(o.formatPrice(a.total));var r=e("#wa-cart-full-discount");if(r){var i=r.find(".js-price");a.discount>0?(r.show(),i.html(o.formatPrice(a.discount))):(r.hide(),i.html(o.formatPrice(0)))}var n=e("#wa-cart-discount");if(n.length){var s=n.find(".js-price");if(a.discount>0){var d=a.discount;t.coupon_discount>0&&(d-=t.coupon_discount),t.affiliate&&t.affiliate.use_affiliate&&t.affiliate.affiliate_discount>0&&(d-=t.affiliate.affiliate_discount),n.show(),s.html(o.formatPrice(d))}else n.hide(),s.html(o.formatPrice(0))}var c=e("#wa-cart-discount-coupon");if(c.length){var l=c.find(".js-price");t.coupon_discount>0?(c.show(),l.html(o.formatPrice(t.coupon_discount))):(c.hide(),l.html(o.formatPrice(0)))}var u=e("#wa-cart-discount-affiliate");if(u.length){var f=u.find(".js-price");t.affiliate&&t.affiliate.use_affiliate&&t.affiliate.affiliate_discount>0?(u.show(),f.html(o.formatPrice(t.affiliate.affiliate_discount))):(u.hide(),f.html(o.formatPrice(0)))}var p=e("#wa-affiliate-order-bonus");p.length&&(t.affiliate&&t.affiliate.add_affiliate_bonus>0?p.html(o.locales.affiliate_bonus.replace("%s",o.formatPrice(t.affiliate.add_affiliate_bonus))).show():p.hide().html(""));var v=e("#wa-affiliate-order-discount");if(v.length){var h=t.affiliate&&t.affiliate.affiliate_discount>0?t.affiliate.affiliate_discount:0;v.html(o.formatPrice(h))}var _=o.$wrapper.find("#wa-cart-weight"),w=function(){var e=!1,t=o.locales.weight_total;return a.count_html&&a.total_weight_html&&(e=t.replace("%s",a.count_html).replace("%s",a.total_weight_html)),e}();o.weight_enabled&&w?_.html(w).show():_.hide().html("")}function r(e){o.DEBUG("ERRORS:","warn",e)}function i(){function a(t,a){function i(t){e(o.templates.error).text(t).appendTo(r)}"boolean"!=typeof t&&(t=!r.hasClass("is-active")),t?r.addClass("is-active"):r.removeClass("is-active"),a&&a.length&&e.each(a,function(e,t){i(t)})}var r=o.$coupon_section;if(!r.length)return!1;t.coupon_code&&t.coupon_code.length?t.coupon_discount||t.coupon_free_shipping?a(!0):a(!1,[o.locales.coupon_invalid]):a(!1)}function n(){function e(e){"boolean"!=typeof e&&(e=!a.hasClass("is-active")),e?(a.addClass("is-active"),a.attr("data-enabled","1").data("enabled",1)):(a.removeClass("is-active"),a.attr("data-enabled","0").data("enabled",0))}var a=o.$affiliate_section;if(!a.length)return!1;e(!!t.affiliate.use_affiliate)}var o=this;if(!t)return o.DEBUG("API is required!","error"),!1;o.hideErrors();var s=o.$products.find(".wa-product"),d={};return s.each(function(){var t=e(this),a=t.data("id");d[a]=t}),function(t){function a(t,a){var r=parseFloat(a.quantity);t.find("input.js-product-quantity").trigger("update",{quantity:r,max:parseFloat(a.stock_count),errors:a.errors?a.errors:null});var i=t.find(".js-product-full-price"),n=a.full_price+(a.discount>0?-a.discount:0);i.html(o.formatPrice(n));var s=t.find(".js-product-discount");if(s.length){var d=s.find(".js-discount");a.discount>0?(s.show(),d.html(o.formatPrice(a.discount))):(s.hide(),d.html(o.formatPrice(0)))}var c=t.find(".js-product-compare");if(c.length){var l=a.discount>0?a.full_price:null;l>0?c.show().html(o.formatPrice(l)):c.hide().html(o.formatPrice(0))}var u=t.find(".wa-service"),f={},p=a.services,v=p?Object.keys(p).length:0;u.length!==v&&o.DEBUG("DOM services !== server services","error",t[0]),u.each(function(){var t=e(this),a=t.data("service-id");a&&(f[a]=t)}),e.each(p,function(e,t){if(f[e]){var a=f[e],r=a.find("input.js-service-field"),i=a.find(".wa-variant select.js-variant-field"),n=t.id,o=!!n;o?(r.attr("checked",!0),a.addClass("is-active").attr("data-id",n).data("id",n).attr("data-enabled","1").data("enabled",1),i.length&&i.attr("disabled",!1).trigger("enabled")):(r.attr("checked",!1),a.removeClass("is-active").attr("data-id","").removeData("id").attr("data-enabled","0").data("enabled",0),i.length&&i.attr("disabled",!0).trigger("disabled"))}})}var r=e.Deferred(),i=Object.keys(t).length;return s.length!==i?r.reject():(e.each(t,function(e,t){var i=t.id,n=d[i];n?a(n,t):r.reject()}),r.resolve()),r.promise()}(t.cart.items).then(function(){i(),n(),a(),t.errors&&r(t.errors),o.DEBUG("UI updated.","info"),o.trigger("rendered",t)},function(){o.DEBUG("UI and Data API distinctions","error"),o.reload()}),!0},t.prototype.saveCart=function(){function t(){r.add_services_deferred.promise().then(function(){var n=r.getCartData();r.trigger("before_update",r),r.update_xhr=e.post(r.urls.save,n,"json").done(function(e){if("ok"===e.status){var t=a(e.data);r.DEBUG("API received:","info"),r.DEBUG(t),r.trigger("updated",t),r.trigger("changed",t),i.resolve(t)}else r.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),i.reject("fail",e)}).fail(function(e,a){"abort"===a?r.add_services_deferred.promise().then(t):(r.DEBUG("Getting API aborted.","error",a),i.reject(a))})})}var r=this;if(r.cart_save_promise)return r.update_xhr&&r.update_xhr.abort(),r.cart_save_promise;var i=e.Deferred();return r.cart_save_promise=i.promise(),r.cart_save_promise.always(function(){r.cart_save_promise=null,r.update_xhr=null}),t(),r.cart_save_promise},t.prototype.getCartData=function(){var t=this,a={items:function(){function a(t){var a=[];return t.find(".wa-service").each(function(){var t=e(this),r=t.data("id");if(r){var i=t.find(".js-variant-field"),n=i.val(),o=1===t.data("enabled")?1:0;a.push({id:r,service_variant_id:n,enabled:o})}}),a}var r=[];return t.$products.find(".wa-product").each(function(){var t=e(this),i=t.data("id"),n=t.data("sku-id"),o=t.find("input.js-product-quantity"),s=parseFloat(o.val());s=s>0?s:0,r.push({id:i,sku_id:n,quantity:s,services:a(t)})}),r}(),coupon:function(){var e={enabled:0,code:""};if(t.$coupon_section.length){e.enabled=1===t.$coupon_section.data("enabled")?1:0;var a=t.$coupon_section.find(".js-coupon-code");if(a.length){var r=a.val();r.length&&(e.code=r)}}return e}(),affiliate:function(){var e={enabled:0};return t.$affiliate_section.length&&(e.enabled=1===t.$affiliate_section.data("enabled")?1:0),e}()};return t.DEBUG("Cart data for save:","info"),t.DEBUG(a),a},t.prototype.hideErrors=function(e){var t=this;e=e&&e.length?e:t.$wrapper;if(e.hasClass("wa-error")?e.removeClass("wa-error"):e.hasClass("js-error-text")?e.remove():(e.find(".wa-error").removeClass("wa-error"),e.find(".js-error-text").remove()),e[0]===t.$wrapper[0]){e.find(".wa-product").removeClass("is-more-than-limit").removeClass("is-out-of-stock")}},t.prototype.trigger=function(e,t){var a=this,r="wa_order_cart_"+e;a.$wrapper.triggerHandler(e,t||null),a.$outer_wrapper.trigger(r,t||null)},t.prototype.formatPrice=function(e,t){var a=e;return window.waOrder.ui.formatPrice&&(a=window.waOrder.ui.formatPrice(e,t)),a},t.prototype.addService=function(t){var r=this;0===r.add_services_count&&(r.add_services_deferred=e.Deferred()),r.add_services_count+=1,r.update_xhr&&r.update_xhr.abort();var i=e.Deferred();return e.post(r.urls.add,t,"json").done(function(e){if("ok"===e.status){var t=a(e.data);r.DEBUG("Service successfully added.","info",t),r.trigger("changed",t),i.resolve(t)}else r.DEBUG("Add service canceled.","warn",e),i.reject("fail",e)}).fail(function(e,t){r.DEBUG("Add service is failed.","error",t),i.reject(t)}).always(function(){r.add_services_count-=1,0===r.add_services_count&&r.add_services_deferred.resolve()}),i.promise()},t.prototype.deleteProduct=function(t){var a=this,r=e.Deferred(),i=t.find("input.js-product-quantity");return function(){var r=e.Deferred(),i=!1,n=a.templates.delete_product_dialog,o=t.find(".wa-details-section .wa-details .wa-name").text();return n=n.replace("%message%",o),new window.waOrder.ui.Dialog({$wrapper:e(n),onOpen:function(e,t){e.on("click",".js-confirm",function(){i=!0,t.close()}),e.on("click",".js-cancel",function(){t.close()})},onClose:function(){i?r.resolve():r.reject()}}),r.promise()}().then(function(){t.data("id");i.val(0).attr("disabled",!0).trigger("disabled"),a.saveCart().always(function(){i.attr("disabled",!1).trigger("enabled")}).then(function(e){var t=0;e&&e.cart&&"object"==typeof e.cart.items&&(t=Object.keys(e.cart.items).length),t>0?r.resolve(e):location.reload()},function(e){r.reject(e)})},function(){parseFloat(i.val())>0||i.val("1"),i.attr("disabled",!1).trigger("enabled"),r.reject("cancel")}),r.promise()},t.prototype.clear=function(t){function r(){var t=i.getCartData();e.each(t.items,function(e,t){t.quantity=0}),t.affiliate&&(t.affiliate.enabled=0),t.coupon&&(t.coupon.code="",t.coupon.enabled=0),i.clear_xhr=e.post(i.urls.save,t,"json").done(function(e){if("ok"===e.status){var t=a(e.data);i.DEBUG("Cart is cleared.","info",e),i.trigger("cleared",t),n.resolve(e)}else i.DEBUG("Cart isn't cleared.","error",e.errors?e.errors:"No error description"),n.reject("fail")}).fail(function(e,t){i.DEBUG("Getting API aborted.","error",t),n.reject(t)}).always(function(){i.clear_xhr=null})}var i=this,n=e.Deferred();return t=t||{},i.clear_xhr?n.reject("running"):t.confirm?function(){var t=e.Deferred(),a=!1;return new window.waOrder.ui.Dialog({$wrapper:e(i.templates.clear_cart_dialog),onOpen:function(e,t){e.on("click",".js-confirm",function(){a=!0,t.close()}),e.on("click",".js-cancel",function(){t.close()})},onClose:function(){a?t.resolve():t.reject()}}),t.promise()}().then(function(){r()},function(){n.reject("cancel")}):r(),n.promise()},t.prototype.reload=function(){var t=this,a=e.Deferred(),r=t.urls.refresh,i={opts:t.options};return t.reload_xhr||(t.lock(!0),t.trigger("before_reload",t),t.reload_xhr=e.post(r,i,function(e){t.$outer_wrapper.one("wa_order_cart_ready",function(){var e=t.$outer_wrapper.data("controller");a.resolve(e)}),t.$wrapper.replaceWith(e),t.trigger("reloaded",t)}).always(function(){t.lock(!1),t.reload_xhr=!1})),a.promise()},t.prototype.lock=function(e){var t=this;e?t.$wrapper.addClass("is-locked"):t.$wrapper.removeClass("is-locked")},t}(e);window.waOrder=window.waOrder||{},window.waOrder.Cart=t}(jQuery);
//# sourceMappingURL=cart.min.js.map
