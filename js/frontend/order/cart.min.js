!function(e){"use strict";var t=function(e){return t=function(e){var t=this;t.$wrapper=e.$wrapper,t.$skus=t.$wrapper.find(".wa-skus-wrapper"),t.$services=t.$wrapper.find(".wa-services-wrapper"),t.$amount=t.$wrapper.find(".js-quantity-field"),t.$price=t.$wrapper.find(".js-product-price"),t.$comparePrice=t.$wrapper.find(".js-product-price-compare"),t.$button=t.$wrapper.find(".js-submit-button"),t.dialog=t.$wrapper.data("dialog"),t.scope=t.dialog.options.scope,t.currency=e.currency,t.services=e.services,t.features=e.features,t.locales=e.locales,t.images=e.images,t.skus=e.skus,t.added_class="is-added",t.amount=parseFloat(t.$amount.val()),t.sku_id=parseFloat(e.sku_id),t.price=parseFloat(e.price),t.compare_price=parseFloat(e.price),t.init()},t.prototype.init=function(){var t=this;t.$wrapper.on("click",".wa-feature-wrapper .wa-variant",function(r){r.preventDefault(),t.changeFeature(e(this))}),t.$skus.on("change",".js-sku-field",function(){var r=e(this),a=r.data("disabled");if("checked"===r.attr("checked")){var i=r.val(),o=t.skus[i];t.changeSKU(o,!a)}}),t.$services.on("change",".js-service-field",function(){t.changeService(e(this))}),t.$services.on("change",".js-variant-select",function(){t.updatePrice()}),t.initSubmit()},t.prototype.initSubmit=function(){var e=this;e.$button.on("click",function(t){t.preventDefault(),e.dialog.options.$product.data("sku-id",e.sku_id),e.dialog.lock(!0),e.scope.saveCart().always(function(){e.dialog.close()}).then(function(t){e.scope.reload()})})},t.prototype.changeSKU=function(t,r){var a=this;t||a.scope.DEBUG("SKU is missing","error"),function(t){var r=e(".js-product-sku"),a=r.closest(".wa-sku-wrapper");t?(r.text(t),a.show()):(r.text(""),a.hide())}(t.sku),function(t){var r=a.images.default;t&&a.images[t]&&(r=a.images[t]),e("img#js-product-image").attr("src",r.uri_200)}(t.image_id),a.updateStocks(t.id),a.updateServices(t.id),a.updatePrice(t.price,t.compare_price),r?a.$button.removeAttr("disabled"):a.$button.attr("disabled",!0),a.sku_id=parseFloat(t.id),a.dialog.resize()},t.prototype.changeFeature=function(t){var r=this,a=t.closest(".wa-feature-wrapper"),i=a.find(".js-feature-field"),o=t.data("variant-id");a.find(".wa-variant.selected").removeClass("selected"),t.addClass("selected"),i.val(o).trigger("change");var n=function(){var t="",a=null;r.$wrapper.find(".wa-feature-wrapper .js-feature-field").each(function(){var r=e(this);t+=r.data("feature-id")+":"+r.val()+";"});var i=r.features[t];return i?a=i:r.scope.DEBUG("Feature error","error"),a}(),s=n.id,c=r.skus[s];c?r.changeSKU(c,n.available):r.scope.DEBUG("SKU id error","error")},t.prototype.changeService=function(e){var t=this,r=e.closest(".wa-service-wrapper"),a=r.find(".js-variant-select");if(a.length){e.is(":checked")?a.removeAttr("disabled"):a.attr("disabled","disabled")}t.updatePrice()},t.prototype.updateServices=function(t){var r=this,a=r.services[t];e.each(a,function(t,a){var i=r.$wrapper.find(".wa-service-wrapper[data-id='"+t+"']");if(!i.length)return r.scope.DEBUG("Service is missing"),!0;if(a)if(i.show().find("input").removeAttr("disabled"),"string"==typeof a)i.find(".js-service-price").html(window.waOrder.ui.formatPrice(a)),i.find(".js-service-field").data("price",a);else{var o=i.find(".js-variant-select"),n=o.val(),s=!1;o.html(""),e.each(a,function(e,t){if(t){e===n&&(s=!0);var r='<option data-price="%price%" value="%value%">%name% (+%formatted_price%)</option>',a=t[0],i=t[1];r=r.replace("%value%",e).replace("%price%",i).replace("%name%",a).replace("%formatted_price%",window.waOrder.ui.formatPrice(i,!0)),o.append(r)}}),s?o.val(n):o[0].selectedIndex=0}else i.hide().find("input, select").attr("disabled",!0).removeAttr("checked")})},t.prototype.updateStocks=function(t){this.$wrapper.find(".wa-stocks-wrapper").find(".wa-stock-wrapper").each(function(){var r=e(this);r.data("sku-id")+""==t+""?r.show():r.hide()})},t.prototype.updatePrice=function(e,t){var r=this;e=parseFloat(e),t=parseFloat(t);var a,i,o=r.$price,n=r.$comparePrice,s=r.amount;e?(r.price=e,o.data("price",e)):e=r.price,t>=0?(r.compare_price=t,n.data("price",t)):t=r.compare_price,a=(e+0)*s,i=(t+0)*s,o.html(window.waOrder.ui.formatPrice(a)),n.html(window.waOrder.ui.formatPrice(i)),t>0?n.removeClass("is-hidden"):n.addClass("is-hidden")},t}(e),r=function(e){function t(t){var r=t;return r.errors&&r.errors.items&&e.each(r.errors.items,function(e,t){r.cart.items&&r.cart.items[e]&&(r.cart.items[e].errors=t)}),r}return r=function(t){var r=this;if(!(t.outer_options&&"string"==typeof t.outer_options.wrapper&&t.outer_options.wrapper.length>0))throw new Error("Checkout wrapper element not specified.");var a=e(t.outer_options.wrapper);if(1!==a.length)throw new Error("Error: Checkout wrapper element must be exactly one on page (found "+a.length+")");r.$outer_wrapper=a,r.$wrapper=t.$wrapper,r.$products=r.$wrapper.find(".wa-products"),r.$coupon_section=r.$wrapper.find(".wa-coupon-section"),r.$affiliate_section=r.$wrapper.find(".wa-affiliate-section"),r.options=t.outer_options,r.templates=t.templates,r.locales=t.locales,r.urls=t.urls,r.add_services_count=0,r.add_services_deferred=e.Deferred().resolve(),r.cart_save_promise=null,r.render_scheduled=!1,r.clear_xhr=null,r.reload_xhr=null,r.update_xhr=null,r.initClass()},r.prototype.initClass=function(){function t(r,a){e.contains(document,n.$wrapper[0])?n.addProduct(a):s.off("wa_order_cart_add_product",t)}function r(){if(e.contains(document,n.$wrapper[0])){var t=n.$wrapper,a=n.$wrapper.find(".wa-error-text");a.length&&(t=a.first()),e("html, body").scrollTop(t.offset().top-40),n.reload()}else s.off("wa_order_cart_invalid",r)}function a(){e.contains(document,n.$wrapper[0])?n.lock(!0):e(document).off("wa_auth_contact_logged",a)}function i(){e.contains(document,n.$wrapper[0])?n.lock(!0):s.off("wa_auth_contact_logout",i)}function o(){e.contains(document,n.$wrapper[0])?n.lock(!0):s.off("wa_order_reload_start",o)}var n=this,s=e(document);n.$wrapper.find(".wa-cart-body > .wa-cart-loader").remove(),n.$wrapper.removeClass("is-not-ready").find(".js-invisible-content").removeAttr("style").removeClass("js-invisible-content"),n.$outer_wrapper.data("controller",n),n.trigger("ready",n),n.initEditProduct(),n.initDeleteProduct(),n.initChangeQuantity(),n.initChangeService(),n.initCoupon(),n.initAffiliate(),s.on("wa_order_cart_add_product",t),s.on("wa_order_cart_invalid",r),s.on("wa_auth_contact_logged",a),s.on("wa_auth_contact_logout",i),s.on("wa_order_reload_start",o)},r.prototype.DEBUG=function(){var e=this,t=console.log,r={hint:"font-weight: bold; color: #666;",info:"font-weight: bold; font-size: 1.25em; color: blue;",warn:"font-weight: bold; font-size: 1.25em;",error:"font-weight: bold; font-size: 1.25em;"};if(e.options&&e.options.DEBUG){if(r[arguments[1]]){switch(arguments[0]="string"==typeof arguments[0]?"%c"+arguments[0]:arguments[0],arguments[1]){case"info":t=console.info;break;case"error":t=console.error;break;case"warn":t=console.warn}arguments[1]=r[arguments[1]]}return t.apply(console,arguments)}},r.prototype.initDeleteProduct=function(){var t=this;t.$wrapper.on("click",".js-delete-product",function(r){r.preventDefault();var a=e(this).closest(".wa-product");t.deleteProduct(a).then(function(e){a.remove(),t.updateCart(e)})})},r.prototype.initEditProduct=function(){function t(t){var r=[],i=t.data("product-id");i?r.push({name:"id",value:i}):a.DEBUG("Product ID required","error");var o=t.data("sku-id");return o&&r.push({name:"sku_id",value:o}),t.find(".wa-service.is-active").each(function(){var t=e(this),a=t.data("service-id"),i=t.find(".js-variant-field"),o=i.val();a&&o&&r.push({name:"service["+a+"]",value:o})}),r}function r(r){var i=t(r),o=r.data("id");a.lock(!0);var n=a.urls.product_edit;e.post(n,i).always(function(){a.lock(!1)}).done(function(t){new window.waOrder.ui.Dialog({$wrapper:e(t),options:{scope:a,item_id:o,$product:r,change:function(){a.reload()}}})})}var a=this;a.$wrapper.on("click",".js-edit-product",function(t){t.preventDefault(),r(e(this).closest(".wa-product"))})},r.prototype.initChangeQuantity=function(){function t(e,t){var r=e.find(".js-product-quantity"),a=r.is(":disabled"),i=parseFloat(r.val()),n=i+(t?1:-1);a||(n>0?r.val(n).trigger("change"):o.deleteProduct(e).then(function(t){e.remove(),o.updateCart(t)}))}function r(e){var t=e.closest(".wa-product"),r=function(e){var t=1;e=e.replace(",",".");var r=parseFloat(e);return isNaN(r)||(t=r),t}(e.val());t.data("id");e.val(r).attr("disabled",!0),i(e),r>0?(e.data("before_value",r),o.saveCart().always(function(){e.attr("disabled",!1)}).then(function(e){o.updateCart(e)})):o.deleteProduct(t).then(function(e){t.remove(),o.updateCart(e)},function(t){var r=e.data("before_value");r&&e.val(r)})}function a(t,r){function a(){return e(o.templates.error)}var n=t.closest(".wa-quantity-section"),s=n.closest(".wa-product"),c=s.find(".js-product-price"),d=parseFloat(t.val());if(r.max>0?t.attr("data-max",r.max).data("max",r.max):t.removeAttr("data-max").removeData("max"),0===r.max)t.addClass("wa-error"),c.hide(),a().text(o.locales.quantity_empty).appendTo(n),s.addClass("is-out-of-stock");else if(r.max<d){t.addClass("wa-error"),c.hide();var l=o.locales.quantity_stock_error.replace("%s",r.max);a().text(l).appendTo(n),s.addClass("is-more-than-limit")}else r.errors?r.errors.quantity&&(t.addClass("wa-error"),c.hide(),a().text(r.errors.quantity).appendTo(n),s.addClass("is-more-than-limit")):(d!==r.quantity&&(t.val(r.quantity).data("before_value",r.quantity),i(t)),r.quantity>1?c.show():c.hide(),t.removeClass("wa-error"));!function(){var e=o.locales.quantity_decrease,t=o.locales.quantity_increase;0!==r.max&&1!==d||(e=o.locales.quantity_delete),d>=r.max&&(t=o.locales.quantity_limit),n.find(".js-decrease .wa-tooltip").attr("data-title",e),n.find(".js-increase .wa-tooltip").attr("data-title",t)}()}function i(e){var t=e.closest(".wa-quantity-box"),r=t.find(".js-increase"),a=e.val(),i=e.data("max");i>0&&a>=i?r.addClass(n):r.removeClass(n)}var o=this,n="is-disabled";o.$products.on("click",".js-increase",function(r){r.preventDefault();var a=e(this);if(!a.hasClass(n)){t(a.closest(".wa-product"),!0)}}),o.$products.on("click",".js-decrease",function(r){r.preventDefault();var a=e(this);if(!a.hasClass(n)){t(a.closest(".wa-product"),!1)}}),o.$products.find("input.js-product-quantity").each(function(){var t=e(this);t.data("before_value",t.val()),t.on("change",function(){o.hideErrors(e(this).closest(".wa-quantity-section")),r(e(this))}).on("update",function(t,r){a(e(this),r)})})},r.prototype.initChangeService=function(){function t(){var t=e(this),r=t.closest(".wa-product"),i=t.closest(".wa-service"),o=i.find(".wa-variant select.js-variant-field"),n=t.is(":checked"),s=r.data("id"),c=i.data("service-id"),d=i.find(".js-variant-field:first").val();if(n){var l={"item[parent_id]":s,"item[service_id]":c,"item[service_variant_id]":d};t.attr("disabled",!0).trigger("disabled"),a.addService(l).always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){if(e.just_added_item){var t=e.just_added_item.id;i.addClass("is-active").attr("data-id",t).data("id",t).attr("data-enabled","1").data("enabled",1),o.length&&o.attr("disabled",!1).trigger("enabled"),a.DEBUG("Service added.","info",i[0],e),a.cart_save_promise?a.cart_save_promise.then(function(e){a.updateCart(e)}):a.updateCart(e)}else a.DEBUG(e.errors,"error"),a.reload()},function(e,r){a.DEBUG("Add service is aborted.","warn",e,r),t.attr("checked",!1)})}else i.removeClass("is-active").attr("data-enabled","0").data("enabled",0),o.length&&o.attr("disabled",!0).trigger("disabled"),t.attr("disabled",!0).trigger("disabled"),a.saveCart().always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){a.updateCart(e)})}function r(){var t=e(this);t.attr("disabled",!0).trigger("disabled"),a.saveCart().always(function(){t.attr("disabled",!1).trigger("enabled")}).then(function(e){a.DEBUG("Service variant Changed.","info",t[0]),a.updateCart(e)})}var a=this;a.$wrapper.on("change",".wa-service input.js-service-field",t),a.$wrapper.on("change",".wa-service .js-variant-field",r)},r.prototype.initCoupon=function(){function e(){i.attr("data-enabled","1").data("enabled",1),a.saveCart().then(function(e){a.updateCart(e)})}function t(){i.attr("data-enabled","0").data("enabled",0),o.val(""),a.saveCart().then(function(e){a.updateCart(e)})}function r(){i.find(".js-error-text").remove()}var a=this,i=a.$coupon_section;if(!i.length)return!1;var o=i.find("input.js-coupon-code");i.on("click",".js-use-coupon",function(r){r.preventDefault(),o.val().length?e():t()}),i.on("click",".js-cancel-coupon",function(e){e.preventDefault(),t()}),a.$wrapper.on("before_update",r),o.on("focus",r)},r.prototype.initAffiliate=function(){var e=this,t=e.$affiliate_section;if(!t.length)return!1;t.on("click",".js-use-bonus",function(r){r.preventDefault(),t.attr("data-enabled","1").data("enabled",1),e.saveCart().then(function(t){e.updateCart(t)})}),t.on("click",".js-cancel-bonus",function(r){r.preventDefault(),t.attr("data-enabled","0").data("enabled",0),e.saveCart().then(function(t){e.updateCart(t)})})},r.prototype.updateCart=function(e){function t(){r.render_scheduled=setTimeout(function(){r.render_scheduled=!1,r.renderCart(e)},50)}var r=this;if(r.render_scheduled)return void(!0!==r.render_scheduled&&(clearTimeout(r.render_scheduled),t()));t()},r.prototype.renderCart=function(t){function r(){var r=t.cart;e("#wa-cart-subtotal .js-price").html(n.formatPrice(r.subtotal)),e("#wa-cart-total .js-price").html(n.formatPrice(r.total));var a=e("#wa-cart-full-discount");if(a){var i=a.find(".js-price");r.discount>0?(a.show(),i.html(n.formatPrice(r.discount))):(a.hide(),i.html(n.formatPrice(0)))}var o=e("#wa-cart-discount");if(o.length){var s=o.find(".js-price");if(r.discount>0){var c=r.discount;t.coupon_discount>0&&(c-=t.coupon_discount),t.affiliate&&t.affiliate.use_affiliate&&t.affiliate.affiliate_discount>0&&(c-=t.affiliate.affiliate_discount),o.show(),s.html(n.formatPrice(c))}else o.hide(),s.html(n.formatPrice(0))}var d=e("#wa-cart-discount-coupon");if(d.length){var l=d.find(".js-price");t.coupon_discount>0?(d.show(),l.html(n.formatPrice(t.coupon_discount))):(d.hide(),l.html(n.formatPrice(0)))}var u=e("#wa-cart-discount-affiliate");if(u.length){var f=u.find(".js-price");t.affiliate&&t.affiliate.use_affiliate&&t.affiliate.affiliate_discount>0?(u.show(),f.html(n.formatPrice(t.affiliate.affiliate_discount))):(u.hide(),f.html(n.formatPrice(0)))}var p=e("#wa-affiliate-order-bonus");p.length&&(t.affiliate&&t.affiliate.add_affiliate_bonus>0?p.html(n.locales.affiliate_bonus.replace("%s",n.formatPrice(t.affiliate.add_affiliate_bonus))).show():p.hide().html(""));var v=e("#wa-affiliate-order-discount");if(v.length){var h=t.affiliate&&t.affiliate.affiliate_discount>0?t.affiliate.affiliate_discount:0;v.html(n.formatPrice(h))}var w=n.$wrapper.find("#wa-cart-weight"),m=function(){var e=!1,t=n.locales.weight_total;return r.count_html&&r.total_weight_html&&(e=t.replace("%s",r.count_html).replace("%s",r.total_weight_html)),e}();m?w.html(m).show():w.hide().html("")}function a(e){n.DEBUG("ERRORS:","warn",e)}function i(){function r(t,r){function i(t){e(n.templates.error).text(t).appendTo(a)}"boolean"!=typeof t&&(t=!a.hasClass("is-active")),t?a.addClass("is-active"):a.removeClass("is-active"),r&&r.length&&e.each(r,function(e,t){i(t)})}var a=n.$coupon_section;if(!a.length)return!1;t.coupon_code&&t.coupon_code.length?t.coupon_discount||t.coupon_free_shipping?r(!0):r(!1,[n.locales.coupon_invalid]):r(!1)}function o(){function e(e){"boolean"!=typeof e&&(e=!r.hasClass("is-active")),e?(r.addClass("is-active"),r.attr("data-enabled","1").data("enabled",1)):(r.removeClass("is-active"),r.attr("data-enabled","0").data("enabled",0))}var r=n.$affiliate_section;if(!r.length)return!1;e(!!t.affiliate.use_affiliate)}var n=this;if(!t)return n.DEBUG("API is required!","error"),!1;n.hideErrors();var s=n.$products.find(".wa-product"),c={};return s.each(function(){var t=e(this),r=t.data("id");c[r]=t}),function(t){function r(t,r){var a=parseFloat(r.quantity);t.find("input.js-product-quantity").trigger("update",{quantity:a,max:parseFloat(r.stock_count),errors:r.errors?r.errors:null});var i=t.find(".js-product-full-price"),o=r.full_price+(r.discount>0?-r.discount:0);i.html(n.formatPrice(o));var s=t.find(".js-product-discount");if(s.length){var c=s.find(".js-discount");r.discount>0?(s.show(),c.html(n.formatPrice(r.discount))):(s.hide(),c.html(n.formatPrice(0)))}var d=t.find(".js-product-compare");if(d.length){var l=r.discount>0?r.full_price:null;l>0?d.show().html(n.formatPrice(l)):d.hide().html(n.formatPrice(0))}var u=t.find(".wa-service"),f={},p=r.services,v=p?Object.keys(p).length:0;u.length!==v&&n.DEBUG("DOM services !== server services","error",t[0]),u.each(function(){var t=e(this),r=t.data("service-id");r&&(f[r]=t)}),e.each(p,function(e,t){if(f[e]){var r=f[e],a=r.find("input.js-service-field"),i=r.find(".wa-variant select.js-variant-field"),o=t.id,n=!!o;n?(a.attr("checked",!0),r.addClass("is-active").attr("data-id",o).data("id",o).attr("data-enabled","1").data("enabled",1),i.length&&i.attr("disabled",!1).trigger("enabled")):(a.attr("checked",!1),r.removeClass("is-active").attr("data-id","").removeData("id").attr("data-enabled","0").data("enabled",0),i.length&&i.attr("disabled",!0).trigger("disabled"))}})}var a=e.Deferred(),i=Object.keys(t).length;return s.length!==i?a.reject():(e.each(t,function(e,t){var i=t.id,o=c[i];o?r(o,t):a.reject()}),a.resolve()),a.promise()}(t.cart.items).then(function(){i(),o(),r(),t.errors&&a(t.errors),n.DEBUG("UI updated.","info"),n.trigger("rendered",t)},function(){n.DEBUG("UI and Data API distinctions","error"),n.reload()}),!0},r.prototype.saveCart=function(){function r(){a.add_services_deferred.promise().then(function(){var o=a.getCartData();a.trigger("before_update",a),a.update_xhr=e.post(a.urls.save,o,"json").done(function(e){if("ok"===e.status){var r=t(e.data);a.DEBUG("API received:","info"),a.DEBUG(r),a.trigger("updated",r),a.trigger("changed",r),i.resolve(r)}else a.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),i.reject("fail",e)}).fail(function(e,t){"abort"===t?a.add_services_deferred.promise().then(r):(a.DEBUG("Getting API aborted.","error",t),i.reject(t))})})}var a=this;if(a.cart_save_promise)return a.update_xhr&&a.update_xhr.abort(),a.cart_save_promise;var i=e.Deferred();return a.cart_save_promise=i.promise(),a.cart_save_promise.always(function(){a.cart_save_promise=null,a.update_xhr=null}),r(),a.cart_save_promise},r.prototype.getCartData=function(){var t=this,r={items:function(){function r(t){var r=[];return t.find(".wa-service").each(function(){var t=e(this),a=t.data("id");if(a){var i=t.find(".js-variant-field"),o=i.val(),n=1===t.data("enabled")?1:0;r.push({id:a,service_variant_id:o,enabled:n})}}),r}var a=[];return t.$products.find(".wa-product").each(function(){var t=e(this),i=t.data("id"),o=t.data("sku-id"),n=t.find("input.js-product-quantity"),s=parseFloat(n.val());s=s>0?s:0,a.push({id:i,sku_id:o,quantity:s,services:r(t)})}),a}(),coupon:function(){var e={enabled:0,code:""};if(t.$coupon_section.length){e.enabled=1===t.$coupon_section.data("enabled")?1:0;var r=t.$coupon_section.find(".js-coupon-code");if(r.length){var a=r.val();a.length&&(e.code=a)}}return e}(),affiliate:function(){var e={enabled:0};return t.$affiliate_section.length&&(e.enabled=1===t.$affiliate_section.data("enabled")?1:0),e}()};return t.DEBUG("Cart data for save:","info"),t.DEBUG(r),r},r.prototype.hideErrors=function(e){var t=this;e=e&&e.length?e:t.$wrapper;if(e.hasClass("wa-error")?e.removeClass("wa-error"):e.hasClass("js-error-text")?e.remove():(e.find(".wa-error").removeClass("wa-error"),e.find(".js-error-text").remove()),e[0]===t.$wrapper[0]){e.find(".wa-product").removeClass("is-more-than-limit").removeClass("is-out-of-stock")}},r.prototype.trigger=function(e,t){var r=this,a="wa_order_cart_"+e;r.$wrapper.triggerHandler(e,t||null),r.$outer_wrapper.trigger(a,t||null)},r.prototype.formatPrice=function(e,t){var r=e;return window.waOrder.ui.formatPrice&&(r=window.waOrder.ui.formatPrice(e,t)),r},r.prototype.addService=function(r){var a=this;0===a.add_services_count&&(a.add_services_deferred=e.Deferred()),a.add_services_count+=1,a.update_xhr&&a.update_xhr.abort();var i=e.Deferred();return e.post(a.urls.add,r,"json").done(function(e){if("ok"===e.status){var r=t(e.data);a.DEBUG("Service successfully added.","info",r),a.trigger("changed",r),i.resolve(r)}else a.DEBUG("Add service canceled.","warn",e),i.reject("fail",e)}).fail(function(e,t){a.DEBUG("Add service is failed.","error",t),i.reject(t)}).always(function(){a.add_services_count-=1,0===a.add_services_count&&a.add_services_deferred.resolve()}),i.promise()},r.prototype.addProduct=function(t){var r=this,a=e.Deferred();return function(t){var a=e.Deferred(),i=r.urls.add;return e.post(i,t,function(e){"ok"===e.status?a.resolve(e.data):a.reject(e.errors)},"json"),a.promise()}(t).then(function(e){r.reload().then(function(e){a.resolve(e)})}),a.promise()},r.prototype.deleteProduct=function(t){var r=this,a=e.Deferred(),i=t.find("input.js-product-quantity");return function(){var a=e.Deferred(),i=!1,o=r.templates.delete_product_dialog,n=t.find(".wa-details-section .wa-details .wa-name").text();return o=o.replace("%message%",n),new window.waOrder.ui.Dialog({$wrapper:e(o),onOpen:function(e,t){e.on("click",".js-confirm",function(){i=!0,t.close()}),e.on("click",".js-cancel",function(){t.close()})},onClose:function(){i?a.resolve():a.reject()}}),a.promise()}().then(function(){t.data("id");i.val(0).attr("disabled",!0).trigger("disabled"),r.saveCart().always(function(){i.attr("disabled",!1).trigger("enabled")}).then(function(e){var t=0;e&&e.cart&&"object"==typeof e.cart.items&&(t=Object.keys(e.cart.items).length),t>0?a.resolve(e):location.reload()},function(e){a.reject(e)})},function(){parseFloat(i.val())>0||i.val("1"),i.attr("disabled",!1).trigger("enabled"),a.reject("cancel")}),a.promise()},r.prototype.clear=function(r){function a(){var r=i.getCartData();e.each(r.items,function(e,t){t.quantity=0}),r.affiliate&&(r.affiliate.enabled=0),r.coupon&&(r.coupon.code="",r.coupon.enabled=0),i.clear_xhr=e.post(i.urls.save,r,"json").done(function(e){if("ok"===e.status){var r=t(e.data);i.DEBUG("Cart is cleared.","info",e),i.trigger("cleared",r),o.resolve(e)}else i.DEBUG("Cart isn't cleared.","error",e.errors?e.errors:"No error description"),o.reject("fail")}).fail(function(e,t){i.DEBUG("Getting API aborted.","error",t),o.reject(t)}).always(function(){i.clear_xhr=null})}var i=this,o=e.Deferred();return r=r||{},i.clear_xhr?o.reject("running"):r.confirm?function(){var t=e.Deferred(),r=!1;return new window.waOrder.ui.Dialog({$wrapper:e(i.templates.clear_cart_dialog),onOpen:function(e,t){e.on("click",".js-confirm",function(){r=!0,t.close()}),e.on("click",".js-cancel",function(){t.close()})},onClose:function(){r?t.resolve():t.reject()}}),t.promise()}().then(function(){a()},function(){o.reject("cancel")}):a(),o.promise()},r.prototype.reload=function(){var t=this,r=e.Deferred(),a=t.urls.refresh,i={opts:t.options};return t.reload_xhr||(t.lock(!0),t.trigger("before_reload",t),t.reload_xhr=e.post(a,i,function(e){t.$outer_wrapper.one("wa_order_cart_ready",function(){var e=t.$outer_wrapper.data("controller");r.resolve(e)}),t.$wrapper.replaceWith(e),t.trigger("reloaded",t)}).always(function(){t.lock(!1),t.reload_xhr=!1})),r.promise()},r.prototype.lock=function(e){var t=this;e?t.$wrapper.addClass("is-locked"):t.$wrapper.removeClass("is-locked")},r}(e);window.waOrder=window.waOrder||{},window.waOrder.Cart=r,window.waOrder.CartProductDialog=t}(jQuery);
//# sourceMappingURL=cart.min.js.map
