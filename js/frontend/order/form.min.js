!function(e){"use strict";function r(){return e(document).width()<=760}var t=function(e){return t=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.templates=e.templates,r.errors=e.errors,r.scope=e.scope,r.contact_id=e.contact_id,r.reload=!1,r.initClass()},t.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(t){var a=e(this),n=!!a.data("affects-rate")||!!a.data("reload"),o=a.closest(".wa-field-wrapper");o.length||(o=a.parent()),r.scope.validate(o,!0).length||n&&r.update({reload:!0})}),r.initType(),r.initAuth(),r.initDatepicker()},t.prototype.initAuth=function(){function r(){e.contains(document,n.$wrapper[0])?i&&i.close():o.off("wa_auth_contact_logged",r)}function t(r,t){r.on("click","a",function(r){var t=e(this),n=t.data("type"),o=["login","signup","forgotpassword","setpassword"];n&&(r.preventDefault(),o.indexOf(n)>=0&&a(n))}),r.on("wa_auth_set_password",function(e,r){a("setpassword",{data:[{name:"hash",value:r}]})}),r.on("wa_auth_resent_password",function(e,r){a("login")}),r.on("wa_auth_contact_signed",function(e,r,t){t.password_sent&&a("login")}),r.on("wa_auth_form_change_view",function(){t.resize()})}function a(r,a){a=a||{};var o=n.scope.urls.auth_dialog,l=[{name:"type",value:r}],p=n.$wrapper.find(".js-type-field");if(p.length){var c=e.trim(p.val());c&&l.push({name:"contact_type",value:c})}return a.data&&(l=l.concat(a.data)),s&&s.abort(),i&&i.lock(!0),s=e.post(o,l,function(r){i&&i.close(),i=new window.waOrder.ui.Dialog({$wrapper:e(r),onOpen:t})}).always(function(){s=null})}var n=this,o=e(document),i=null,s=null;o.on("wa_auth_contact_logged",r),n.contact_id?n.$wrapper.on("click",".js-logout-button",function(r){e(document).trigger("wa_order_reload_start")}):n.$wrapper.on("click",".js-show-login-dialog",function(e){e.preventDefault(),a("login")})},t.prototype.initType=function(){var r=this,t=r.$wrapper.find(".js-type-toggle").first(),a=r.$wrapper.find(".js-type-field");new window.waOrder.ui.Toggle({$wrapper:t,change:function(t,n,o){var i=e(n).data("id");i&&(r.reload=!0,a.val(i),r.scope.update())}})},t.prototype.initDatepicker=function(){this.$wrapper.find(".js-datepicker").each(function(){var r=e(this),t={},a=r.data("alt");if(a){var n=r.closest(".wa-field-wrapper").find(a);n.length&&(t.altField=n,t.altFormat="yy-mm-dd")}r.datepicker(t),r.on("keydown keypress keyup",function(e){13===e.which&&e.preventDefault()})})},t.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"auth[html]",value:1});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"auth[html]",value:1});var n=r.scope.validate(r.$form,a);n.length&&(t.errors=n)}return t},t.prototype.render=function(e){var r=this,t=!1;return e.auth&&e.auth.html&&(r.$wrapper.replaceWith(e.auth.html),t=!0),t},t.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},t.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},t}(e),a=function(e){return a=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.disabled=e.disabled,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},a.prototype.initClass=function(){function r(r,n){r.length&&r.is(":visible")&&(r.on("keydown",function(){t(r)}),r.on("change",function(){n&&n.length&&e.each(n,function(e,r){r.length&&r.attr("disabled",!0)}),a(r)}))}function t(e){clearTimeout(o),o=setTimeout(function(){e.trigger("change")},i)}function a(e){clearTimeout(o),n.scope.trigger("region_change")}var n=this,o=0,i=2e3;"object"==typeof n.errors&&Object.keys(n.errors).length&&n.scope.DEBUG("Errors:","error",n.errors),n.$form.on("submit",function(e){e.preventDefault()});var s=n.$form.find(".js-location-field"),l=n.$form.find(".js-country-field"),p=n.$form.find(".js-region-field"),c=n.$form.find(".js-city-field"),u=n.$form.find(".js-zip-field");r(s,[l,p,c,u]),r(l,[p,c,u]),r(p,[c,u]),r(u),c.length&&c.hasClass("js-city-autocomplete")?function(r){function t(){function t(r){var t=[];return e.each(r,function(e,r){var a=r.city;a&&t.push({label:a,value:a})}),t}var a=e.Deferred(),o=n.scope.urls.order+"addressAutocomplete/",s={};if(l.length){var c=l.val();c&&(s.country=c)}if(p.length){var d=p.val();d&&(s.region=d)}var f=r.val();if(f&&(s.city=f),u.length){var h=u.val();h&&(s.zip=h)}return i&&i.abort(),i=e.post(o,s,"json").always(function(){i=null}).done(function(e){if("ok"===e.status){var r=e.data.result;r=r.length?t(r):[],a.resolve(r)}else a.reject()}).fail(function(){a.reject()}),a.promise()}function o(e){var t=e?0:100;r.trigger("blur"),clearTimeout(s),s=setTimeout(function(){a(r)},t)}var i=null,s=0;r.on("change",function(){o()}),r.autocomplete({source:function(e,r){t().then(function(e){r(e)})},minLength:2,focus:function(){return!1},select:function(e,t){return r.val(t.item.value),o(!0),!1}})}(c):r(c,[u])},a.prototype.getData=function(e){var r=this,t=[];if(r.disabled)t.push({name:"region[html]",value:"only"});else if(e.clean)t.push({name:"region[html]",value:"only"});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"region[html]",value:"only"});var n=r.scope.validate(r.$form,a);n.length&&(t.errors=n)}return t},a.prototype.render=function(e){var r=this,t=!1;return e.region&&e.region.html&&(r.$wrapper.replaceWith(e.region.html),t=!0),t},a.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},a.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},a}(e),n=function(e){function t(r,t){var a={};return t&&e.each(r,function(e,r){r[t]&&(a[r[t]]=r)}),a}var a=function(e){return a=function(e){var r=this;r.$wrapper=e.$wrapper,r.$sidebar=r.$wrapper.find(".wa-sidebar-section"),r.$map_section=r.$wrapper.find(".wa-map-section"),r.$variants=r.$wrapper.find(".wa-variant-wrapper"),r.show_map=e.show_map,r.dialog=e.dialog,r.scope=e.scope,r.data=e.data,r.onSet="function"==typeof e.set?e.set:function(){},r.variants=r.scope.variants,r.active_variant=r.scope.active_variant,r.map=null,r.initClass()},a.prototype.initClass=function(){var e=this;e.show_map?e.map=e.initMap():e.$map_section.hide(),e.initFilters(),e.initDetails(),e.initMobileToggle()},a.prototype.initMap=function(){function t(e){var r=null,t=null;if(!e.lat||!e.lng)return!1;r=e.lat,t=e.lng;var a=new ymaps.Placemark([r,t],{balloonContentBody:e.name});return a.variant_id=e.variant_id,s[e.variant_id]=a,a}function a(r){var t=[55,37],a=[],n=[];e.each(r,function(e,r){r.lat&&r.lng&&(a.push(r.lat),n.push(r.lng))});var o=Math.min.apply(null,a),i=Math.max.apply(null,a),s=Math.min.apply(null,n),l=Math.max.apply(null,n);return t[0]=o+(i-o)/2,t[1]=s+(l-s)/2,t}var n=this,o=e.Deferred(),i=o.promise(),s={},l=null;if(!window.ymaps)return n.scope.scope.DEBUG("Yandex API required","error"),!1;var p=function(){},c=function(){};return ymaps.ready(function(){if(!e("#wa-yandex-map").length)return!1;var i=a(n.variants),u=new ymaps.Map("wa-yandex-map",{center:i,zoom:10,controls:["fullscreenControl","zoomControl","geolocationControl"]}),d=new ymaps.Clusterer;c=function(e){r()||u.setCenter(e.geometry.getCoordinates(),17).then(function(){l=e.balloon;var r=d.getObjectState(e);!r.isClustered&&r.isShown&&(l.isOpen()||l.open())})},p=function(){u.setCenter(i,10),l&&(l.isOpen()&&l.close(),l=null)},function(){function r(){var e=u.controls.get("fullscreenControl");e.state.get("fullscreen")&&e.exitFullscreen()}var a=[];if(e.each(n.variants,function(e,r){var n=t(r);n&&a.push(n)}),d.add(a),u.geoObjects.add(d),d.events.add("click",function(t){var a=t.get("target");if(a.getGeoObjects){var o=a.getGeoObjects();if(u.getZoom()>=17){var i=[];e.each(o,function(e,r){r.variant_id&&i.push(r.variant_id)}),i.length&&(r(),n.$wrapper.trigger("show_variant_details",[i,null]))}}else a.variant_id&&(r(),n.$wrapper.trigger("show_variant_details",[[a.variant_id],null]))}),n.active_variant&&s[n.active_variant]){var o=s[n.active_variant];c(o)}}(),function(){var e=new ymaps.control.SearchControl({options:{noPlacemark:!0}}),r=new ymaps.Collection(null,{});u.controls.add(e),u.geoObjects.add(r),e.events.add("resultselect",function(t){var a=t.get("index");e.getResult(a).then(function(e){e.options.set("preset","islands#redIcon"),r.add(e)})}).add("submit",function(){r.removeAll()})}(),o.resolve(u,d)}),{placemarks:s,refresh:function(r){function t(t,a){var n=[];e.each(r,function(e,r){r&&s[r]&&n.push(s[r])}),a.removeAll(),a.add(n)}i.then(t)},reset:function(){return p()},moveTo:function(e){return c(e)}}},a.prototype.initFilters=function(){function r(e){var r=e.data("id"),t=n.indexOf(r);e.hasClass("is-active")?(e.removeClass("is-active"),t>=0&&n.splice(t,1)):(e.addClass("is-active"),t>=0||n.push(r)),n.length?o.addClass(i):o.removeClass(i)}function t(){var r=[];a.$variants.each(function(){var t=e(this),a=t.data("id"),o=t.data("service-id");!n.length||n.indexOf(o)>=0?(t.show(),r.push(a)):t.hide()}),a.map&&a.map.refresh(r)}var a=this,n=[],o=a.$wrapper.find(".wa-filters-list"),i="is-set";a.$wrapper.on("click",".js-set-filter",function(a){a.preventDefault(),r(e(this)),t()})},a.prototype.initDetails=function(){function t(e){e?(o.onSet(e),o.dialog.close()):o.scope.scope.DEBUG("Variant id is missing.","error")}function a(r){if(r){var t="";if(e.each(r,function(e,r){o.variants[r]?t+=n(o.variants[r]):o.scope.scope.DEBUG("Variant data is missing.","error")}),l.html(t),i.hide(),s.show(),1===r.length&&o.map.placemarks&&o.map.placemarks[r[0]]){var a=o.map.placemarks[r[0]];o.map.moveTo(a)}}else s.hide(),l.html(""),i.show()}function n(e){var r=o.scope.templates.map_details;return r=r.replace("%title%",e.name).replace("%variant_id%",e.variant_id),o.show_map&&(r=r.replace("ymaps-geolink","")),r=e.formatted_price?r.replace("%shipping_cost_style%","").replace("%shipping_cost%",e.formatted_price):r.replace("%shipping_cost_style%","display: none;"),r=e.formatted_date?r.replace("%shipping_time_style%","").replace("%shipping_time%",e.formatted_date):r.replace("%shipping_time_style%","display: none;"),r=e.service?r.replace("%shipping_service_style%","").replace("%shipping_service%",e.service):r.replace("%shipping_service_style%","display: none;"),r=e.storage_days?r.replace("%storage_time_style%","").replace("%storage_time%",e.storage_days):r.replace("%storage_time_style%","display: none;"),r=e.description?r.replace("%address_style%","").replace("%address%",e.description):r.replace("%address_style%","display: none;")}var o=this,i=o.$sidebar.find(".wa-variants-section"),s=o.$sidebar.find(".wa-variant-details-section"),l=s.find("> .wa-section-body");o.$wrapper.on("click",".js-show-variant-details",function(n){n.preventDefault();var o=e(this).data("id");r()?t(o):a([o])}),o.$wrapper.on("show_variant_details",function(e,n){r()?t(n[0]):a(n)}),o.$wrapper.on("click",".js-show-variants-list",function(e){e.preventDefault(),a(!1)}),o.$wrapper.on("click",".js-use-variant",function(r){r.preventDefault(),t(e(this).data("variant-id"))})},a.prototype.initMobileToggle=function(){var r=this,t=r.$wrapper.find(".js-mobile-view-toggle").first();if(!t.length)return!1;if(r.$wrapper.addClass("is-mobile-list-view"),r.show_map){new window.waOrder.ui.Toggle({$wrapper:t,change:function(t,a,n){var o=e(a).data("id");o&&("map"===o?(r.$wrapper.removeClass("is-mobile-list-view"),r.$wrapper.addClass("is-mobile-map-view")):"list"===o&&(r.$wrapper.removeClass("is-mobile-map-view"),r.$wrapper.addClass("is-mobile-list-view")))}})}else t.hide()},a}(jQuery),o=function(e){return o=function(e){var r=this;r.$wrapper=e.$wrapper,r.active_class="is-active",r.onChange="function"==typeof e.onChange?e.onChange:function(){},r.$active=r.$wrapper.find(".wa-type-wrapper."+r.active_class),r.initClass()},o.prototype.initClass=function(){var r=this;r.$wrapper.on("click",".wa-type-wrapper",function(t){t.preventDefault(),r.changeType(e(this))})},o.prototype.changeType=function(e){var r=this;if(e.hasClass(r.active_class))return!1;var t=e.data("id");t&&(r.$active.length&&r.$active.removeClass(r.active_class),r.$active=e.addClass(r.active_class),r.onChange(t))},o}(jQuery);return n=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.map_display=e.map_display,r.templates=e.templates,r.disabled=e.disabled,r.variants_array=e.variants,r.variants=t(e.variants,"variant_id"),r.active_variant=e.active_variant,r.locales=e.locales,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},n.prototype.initClass=function(){function t(r,t){var o=n.templates.map_dialog;new n.scope.ui.Dialog({$wrapper:e(o),onOpen:function(e,o){new a({$wrapper:e,dialog:o,scope:n,show_map:t,set:function(e){if(n.variants[e]){var t=n.variants[e],a='<div class="wa-dropdown-item js-set-dropdown-item" data-id="%variant_id%"><div class="wa-delivery-variant"><div class="wa-name" data-name="%variant_name%"></div></div></div>';a=a.replace("%variant_id%",e).replace("%variant_name%",t.name),r.$menu.append(a);r.$menu.find('.js-set-dropdown-item[data-id="'+e+'"]').trigger("click")}else n.scope.DEBUG("Variants is missing","error",e)}})}})}var n=this;"object"==typeof n.errors&&Object.keys(n.errors).length&&n.scope.DEBUG("Errors:","error",n.errors),n.$form.on("submit",function(e){e.preventDefault()});var i=null,s=null,l=n.$wrapper.find("#js-delivery-types-section");l.length&&(i=l.find(".js-type-field"),new o({$wrapper:l,onChange:function(e){i.val(e),n.scope.DEBUG("Delivery type changed — "+e,"info"),s&&s.val(""),n.update({reload:!0})}}));var p=n.$wrapper.find("#js-delivery-variants-section");if(p.length){s=p.find(".js-variant-field");var c=i?i.val():"",u=new window.waOrder.ui.Dropdown({$wrapper:p.find(".js-variants-select"),hover:!1,change_title:!1,change_selector:".wa-dropdown-item",open:function(a){var o=r(),i=n.variants_array.length;if("always"===n.map_display)return t(a,!0),!1;if("desktop"===n.map_display)return t(a,!o),!1;if(i>5&&"pickup"===c)return t(a,!1),!1;var s=o?55:0;e("html, body").scrollTop(p.offset().top-s)},change:function(r,t,a){var o=e(t),i=o.data("id"),l=o.find(".wa-name").data("name");s.val(i),a.setTitle(l),n.update({reload:!0})}});s.val()||u.$button.trigger("click"),l.on("click",".wa-type-wrapper.is-active",function(){u.$button.trigger("click")})}var d=n.$wrapper.find("#js-delivery-short-variants-section");d.length&&(i=l.find(".js-type-field"),s=d.find(".js-variant-field"),new window.waOrder.ui.Dropdown({$wrapper:d.find(".js-variants-select"),hover:!1,change_title:!1,change_selector:".wa-dropdown-item",open:function(t){var a=r()?55:0;e("html, body").scrollTop(d.offset().top-a)},change:function(r,t,a){var o=e(t),l=o.data("type-id"),p=o.data("variant-id"),c=o.find(".wa-name").data("name");i.val(l),s.val(p),a.setTitle(c),n.update({reload:!0})}}))},n.prototype.getData=function(r){var t=this,a=[];if(t.disabled)a.push({name:"shipping[html]",value:"only"});else if(r.clean)a.push({name:"shipping[html]",value:"only"});else{var n=!1!==r.render_errors;t.$form.length&&(a=t.$form.serializeArray()),!r.only_api&&t.reload&&a.push({name:"shipping[html]",value:"only"});var o=t.scope.validate(t.$form),i=t.$wrapper.find("#js-delivery-types-section");if(i.length){var s=i.find(".wa-types-list"),l=i.find(".js-type-field"),p=e.trim(l.val());if(!p.length&&(o.push({$wrapper:s,id:"type_required",value:t.locales.type_required}),n&&!s.hasClass("wa-error"))){var c=e('<div class="wa-error-text" />').text(t.locales.type_required).insertAfter(s);s.addClass("wa-error").one("change",function(){s.removeClass("wa-error"),c.remove()})}}var u=null,d=t.$wrapper.find("#js-delivery-variants-section");if(d.length){var f=d.find(".js-variants-select"),h=d.find(".js-variant-field");if(u=e.trim(h.val()),!u.length&&(o.push({$wrapper:f,id:"variant_required",value:t.locales.variant_required}),n&&!f.hasClass("wa-error"))){var v=e('<div class="wa-error-text" />').text(t.locales.variant_required).insertAfter(f);f.addClass("wa-error").one("change",function(){f.removeClass("wa-error"),v.remove()})}}var w=t.$wrapper.find("#js-delivery-short-variants-section");if(w.length){var m=w.find(".js-variants-select"),g=w.find(".js-variant-field");if(u=e.trim(g.val()),!u.length&&(o.push({$wrapper:m,id:"variant_required",value:t.locales.variant_required}),n&&!m.hasClass("wa-error"))){var _=e('<div class="wa-error-text" />').text(t.locales.variant_required).insertAfter(m);m.addClass("wa-error").one("change",function(){m.removeClass("wa-error"),_.remove()})}}o.length&&(a.errors=o)}return a},n.prototype.render=function(e){var r=this,t=!1;return e.shipping&&e.shipping.html&&(r.$wrapper.replaceWith(e.shipping.html),t=!0),t},n.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},n.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update({sections:["auth","region","shipping","confirm"]}).always(function(){r.reload=!0})},n}(e),o=function(e){return o=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.templates=e.templates,r.disabled=e.disabled,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},o.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(t){var a=e(this),n=!!a.data("affects-rate")||!!a.data("reload"),o=a.closest(".wa-field-wrapper");o.length||(o=a.parent()),r.scope.validate(o,!0).length||n&&r.update({reload:!0})}),r.initPhotos()},o.prototype.initPhotos=function(){var r=this,t=r.$wrapper.find(".wa-photos-section");if(!t.length)return!1;!function(){var r=function(e){return r=function(e){var r=this;r.$wrapper=e.$wrapper,r.$slides=e.$slides,r.$left_arrow=e.$left_arrow,r.$right_arrow=e.$right_arrow,r.disable_class="is-disabled",r.wrapper_w=null,r.scroll_w=null,r.slide_w=null,r.left=0,r.is_locked=!1,r.initClass()},r.prototype.initClass=function(){function r(){e.contains(document,t.$wrapper[0])?t.wrapper_w!==t.$wrapper.outerWidth()&&t.reset():a.off("resize",r)}var t=this,a=e(window);t.setData(),t.showArrows(),t.$wrapper.on("scroll",function(e){t.left=t.$wrapper.scrollLeft()}),t.$left_arrow.on("click",function(e){e.preventDefault(),t.$left_arrow.hasClass(t.disable_class)||t.move(!1)}),t.$right_arrow.on("click",function(e){e.preventDefault(),t.$right_arrow.hasClass(t.disable_class)||t.move(!0)}),a.on("resize",r)},r.prototype.setData=function(){var e=this;e.wrapper_w=e.$wrapper.outerWidth(),e.scroll_w=e.$wrapper[0].scrollWidth,e.slide_w=e.$slides.first().outerWidth(!0)},r.prototype.showArrows=function(){var e=this,r=e.disable_class;e.left>0?(e.$left_arrow.removeClass(r),e.scroll_w-e.wrapper_w-e.left>0?e.$right_arrow.removeClass(r):e.$right_arrow.addClass(r)):(e.$left_arrow.addClass(r),e.scroll_w-e.wrapper_w>0?e.$right_arrow.removeClass(r):e.$right_arrow.addClass(r))},r.prototype.set=function(e){var r=this;r.is_locked||(r.is_locked=!0,e=e?parseFloat(e):0,e>=0||(e=0),r.$wrapper.animate({scrollLeft:e},200,function(){r.is_locked=!1}),r.left=e)},r.prototype.move=function(e){var r=this,t=4*r.slide_w,a=r.scroll_w-r.wrapper_w,n=0;a>0&&(e?(n=r.left+t,n%r.slide_w>0&&(n=parseInt(r.left/r.slide_w)*r.slide_w),n>a&&(n=a)):(n=r.left-t,n%r.slide_w>0&&(n=parseInt(r.left/r.slide_w)*r.slide_w),n<0&&(n=0))),r.set(n),r.showArrows()},r.prototype.reset=function(){var e=this;e.set(),e.setData(),e.showArrows()},r}(e),a=t.find(".wa-photos-list"),n=a.find(".wa-photo-wrapper");new r({$wrapper:a,$slides:n,$left_arrow:t.find(".js-scroll-prev"),$right_arrow:t.find(".js-scroll-next")})}(),function(){function a(t){function a(r,t){function a(t){if(e.contains(document,r[0])){var n=t.keyCode;37===n?o(!1):39===n&&o(!0)}else e(document).off("keyup",a)}function o(e){u=e?u+1<p.length?u+1:0:u>0?u-1:p.length-1,i(p[u])}function i(r){l.attr("src",r.thumb_uri);var t=e("<img />");t.on("load",function(){l.attr("src")===r.thumb_uri&&(l.attr("src",r.image_uri),c())}),t.attr("src",r.image_uri)}var s=r.find(".wa-photo-body"),l=e("<img />").appendTo(s),p=n(),c=t.onChange||function(){},u=t.index||0;i(p[u]),e(document).on("keyup",a),r.on("click",".js-show-prev",function(e){e.preventDefault(),o(!1)}),r.on("click",".js-show-next",function(e){e.preventDefault(),o(!0)})}var i=r.templates.photo.replace("%title%",o);new r.scope.ui.Dialog({$wrapper:e(i),onOpen:function(e,r){var n=e.find(".js-photo-slider-section");n.length&&a(n,{index:t.index(),onChange:function(){r.resize()}})}})}function n(){var r=[];return t.find(".wa-photo-wrapper").each(function(){var t=e(this),a=t.data("image-uri"),n=t.data("thumb-uri");r.push({image_uri:a,thumb_uri:n})}),r}var o=t.data("name");t.on("click",".js-show-photo",function(r){r.preventDefault(),a(e(this).closest(".wa-photo-wrapper"))})}()},o.prototype.getData=function(e){var r=this,t=[];if(r.disabled)t.push({name:"details[html]",value:"only"});else if(e.clean)t.push({name:"details[html]",value:"only"});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"details[html]",value:"only"});var n=r.scope.validate(r.$form,a);n.length&&(t.errors=n)}return t},o.prototype.render=function(e){var r=this,t=!1;return e.details&&e.details.html&&(r.$wrapper.replaceWith(e.details.html),t=!0),t},o.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},o.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},o}(e),i=function(e){return i=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.disabled=e.disabled,r.locales=e.locales,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},i.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(t){var a=e(this),n=!!a.data("affects-rate")||!!a.data("reload"),o=a.closest(".wa-field-wrapper");o.length||(o=a.parent()),r.scope.validate(o,!0).length||n&&r.update({reload:!0})}),r.initMethods()},i.prototype.initMethods=function(){function r(e){var r=e.find(".js-method-field");o.length&&o.removeClass(n),o=e.addClass(n),r.attr("checked",!0).trigger("change")}var t=this,a=t.$wrapper.find(".js-methods-list");if(!a.length)return!1;var n="is-active",o=a.find(".wa-method-wrapper."+n);a.on("click",".wa-method-wrapper",function(t){t.preventDefault();var a=e(this);o.length?o[0]!==a[0]&&r(a):r(a)})},i.prototype.getData=function(r){var t=this,a=[];if(t.disabled)a.push({name:"payment[html]",value:"only"});else if(r.clean)a.push({name:"payment[html]",value:"only"});else{var n=!1!==r.render_errors;t.$form.length&&(a=t.$form.serializeArray()),!r.only_api&&t.reload&&a.push({name:"payment[html]",value:1});var o=t.scope.validate(t.$wrapper,n),i=t.$wrapper.find(".js-methods-list");if(i.length){var s=i.find(".js-method-field:checked");if(!s.length&&(o.push({$wrapper:i,id:"method_required",value:t.locales.method_required}),n)){if(!i.hasClass("wa-error")){var l=e('<div class="wa-error-text" />').text(t.locales.method_required).insertAfter(i);i.addClass("wa-error").one("change",function(){i.removeClass("wa-error"),l.remove()})}}}o.length&&(a.errors=o)}return a},i.prototype.render=function(e){var r=this,t=!1;return e.payment&&e.payment.html&&(r.$wrapper.replaceWith(e.payment.html),t=!0),t},i.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},i.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},i}(e),s=function(e){return s=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.errors=e.errors,r.scope=e.scope,r.templates=e.templates,r.reload=!0,r.initClass()},s.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&(r.scope.DEBUG("Errors:","error",r.errors),r.renderErrors(r.errors)),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, input, textarea",function(t){var a=e(this),n=a.closest(".wa-field-wrapper");a.data("reload")?r.update({reload:!0}):n.length&&r.scope.validate(n,!0)});var t=r.$wrapper.find(".wa-comment-section");if(t.length){t.on("click"," .js-open-section",function(e){e.preventDefault(),t.toggleClass("is-opened")})}r.$wrapper.on("click",".js-show-terms-dialog",function(t){t.preventDefault(),r.templates.terms_dialog&&new r.scope.ui.Dialog({$wrapper:e(r.templates.terms_dialog)})}),r.$wrapper.on("click",".js-submit-order-button",function(e){e.preventDefault(),r.create()})},s.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"confirm[html]",value:"only"});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"confirm[html]",value:1});var n=r.scope.validate(r.$wrapper,a);n.length&&(t.errors=n)}return t},s.prototype.render=function(e){var r=this,t=!1;return e.confirm&&e.confirm.html&&(r.$wrapper.replaceWith(e.confirm.html),t=!0),t},s.prototype.renderErrors=function(r){var t=this,a=[];return e.each(r,function(e,r){"cart_invalid"===r.id&&t.$wrapper.trigger("wa_order_cart_invalid"),a.push(r)}),a},s.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},s.prototype.create=function(){function r(r){function t(e){var r=0;if(e.is(":visible"))r=e.offset().top;else{var a=e.parent();a.length&&(r=t(a))}return r}var a=0;if(r.$field&&r.$field.length){a=t(r.$field)-40,r.$field.focus()}r.$wrapper&&r.$wrapper.length&&(a=r.$wrapper.offset().top-40),e("html, body").scrollTop(a)}var t=this,a=t.scope.validate(t.scope.$wrapper,!0);a.length?(t.scope.DEBUG("Errors:","error",a),r(a[0])):t.scope.update({create:!0,render_errors:!0}).then(function(e){if(e.order_id){t.scope.trigger("created",e),t.scope.lock(!0);try{location.href=t.scope.urls.success}catch(e){t.scope.DEBUG(e.message,"error")}}else{var a=t.scope.renderErrors(e);a.length&&r(a[0])}},function(e,t){"front_errors"===e&&t.length&&r(t[0])})},s}(e),l=function(e){function r(r){return r.errors&&(Array.isArray(r.errors)||(r.errors=function(r){var t=[];return r&&e.each(r,function(e,r){t.push({name:e,value:r})}),t}(r.errors))),r}return l=function(r){var t=this;if(!(r.outer_options&&"string"==typeof r.outer_options.wrapper&&r.outer_options.wrapper.length>0))throw new Error("Checkout wrapper element not specified.");var a=e(r.outer_options.wrapper);if(1!==a.length)throw new Error("Error: Checkout form wrapper element must be exactly one on page (found "+a.length+")");if(!r.urls.calculate)throw new Error("Must specify url_calculate");if(!r.urls.create)throw new Error("Must specify url_create_order");t.$outer_wrapper=a,t.$wrapper=r.$wrapper,t.options=r.outer_options,t.locales=r.locales,t.urls=r.urls,t.ui=window.waOrder.ui,t.sections={},t.render_scheduled=!1,t.calculate_promise=null,t.create_promise=null,t.calculate_xhr=null,t.reload_xhr=null,t.create_xhr=null,t.initClass()},l.prototype.initClass=function(){function r(){var e=i.getFormData({sections:["auth","region","confirm"]});i.update({data:e}).then()}function t(){e.contains(document,i.$wrapper[0])?i.update().then():s.off("click",t)}function a(){e.contains(document,i.$wrapper[0])?i.reload():s.off("wa_auth_contact_logout",a)}function n(){e.contains(document,i.$wrapper[0])?(s.trigger("wa_order_reload_start"),location.reload()):e(document).off("wa_auth_contact_logged",n)}function o(){e.contains(document,i.$wrapper[0])?i.lock(!0):s.off("wa_order_reload_start",o)}var i=this,s=e(document);i.$wrapper.removeAttr("style").removeClass("is-not-ready"),i.$outer_wrapper.data("controller",i),i.trigger("ready",i),i.$wrapper.data("ready").resolve(i),i.$wrapper.on("region_change",r),s.on("wa_order_cart_changed",t),s.on("wa_auth_contact_logout",a),s.on("wa_auth_contact_logged",n),s.on("wa_order_reload_start",o)},l.prototype.DEBUG=function(){var e=this,r=console.log,t={hint:"font-weight: bold; color: #666;",info:"font-weight: bold; font-size: 1.25em; color: blue;",warn:"font-weight: bold; font-size: 1.25em;",error:"font-weight: bold; font-size: 1.25em;"};if(e.options&&e.options.DEBUG){if(t[arguments[1]]){switch(arguments[0]="string"==typeof arguments[0]?"%c"+arguments[0]:arguments[0],arguments[1]){case"info":r=console.info;break;case"error":r=console.error;break;case"warn":r=console.warn}arguments[1]=t[arguments[1]]}return r.apply(console,arguments)}},l.prototype.initAuth=function(e){var r=this;e.scope=r,r.sections.auth=new t(e),r.DEBUG("Auth initialized","info",r.sections.auth)},l.prototype.initRegion=function(e){var r=this;e.scope=r,r.sections.region=new a(e),r.DEBUG("Region initialized","info",r.sections.region)},l.prototype.initShipping=function(e){var r=this;e.scope=r,r.sections.shipping=new n(e),r.DEBUG("Shipping initialized","info",r.sections.shipping)},l.prototype.initDetails=function(e){var r=this;e.scope=r,r.sections.details=new o(e),r.DEBUG("Details initialized","info",r.sections.details)},l.prototype.initPayment=function(e){var r=this;e.scope=r,r.sections.payment=new i(e),r.DEBUG("Payment initialized","info",r.sections.payment)},l.prototype.initConfirm=function(e){var r=this;e.scope=r,r.sections.confirm=new s(e),r.DEBUG("Confirm initialized","info",r.sections.confirm)},l.prototype.trigger=function(e,r){var t=this,a="wa_order_form_"+e;t.$wrapper.triggerHandler(e,r||null),t.$outer_wrapper.trigger(a,r||null)},l.prototype.validate=function(r,t){function a(r){function t(){o.removeClass(n),a.remove(),o.off("change",t)}var a=e('<div class="wa-error-text" />').text(r.value),n="wa-error";if(r.$field){var o=r.$field;if(!o.hasClass(n)){o.addClass(n);var i=o.closest(".wa-field-wrapper");i.length?i.append(a):a.insertAfter(o),o.on("change keyup",t)}}}var n=this,o=[];return r.find(".wa-input").each(function(){var r=e(this),t=r.attr("name"),a=r.val().trim();if(r.is(":disabled"))return!0;if(a.length){if(!t)return!0;if(r.hasClass("wa-email")){n.ui.validate.email(a)||o.push({$field:r,name:t,value:n.locales.invalid})}else if(r.hasClass("wa-phone")){var i=n.ui.validate.phone(a);i||o.push({$field:r,name:t,value:n.locales.invalid})}else if(r.hasClass("wa-url")){var s=n.ui.validate.url(a);s||o.push({$field:r,name:t,value:n.locales.invalid})}else if(r.hasClass("wa-number")){var l=n.ui.validate.number(a);l||o.push({$field:r,name:t,value:n.locales.invalid})}}else{!!r.attr("required")&&o.push({$field:r,name:t,value:n.locales.required})}}),r.find(".wa-checkbox").each(function(){var r=e(this),t=r.attr("name"),a=r.is(":checked");if(r.is(":disabled"))return!0;if(a){if(!t)return!0}else{!!r.attr("required")&&o.push({$field:r,name:t,value:n.locales.required})}}),r.find(".wa-select, wa-textarea").each(function(){var r=e(this),t=r.attr("name"),a=e.trim(r.val());if(r.is(":disabled"))return!0;if(a.length){if(!t)return!0}else{!!r.attr("required")&&o.push({$field:r,name:t,value:n.locales.required})}}),t&&o.length&&e.each(o,function(e,r){a(r)}),o},l.prototype.renderErrors=function(r){var t=this,a=[];return r.error_step_id&&r.errors&&e.each(t.sections,function(e,t){if(r.error_step_id===e&&"function"==typeof t.renderErrors){var n=t.renderErrors(r.errors);n.length&&(a=a.concat(n))}}),a},l.prototype.getFormData=function(r){r=r||{};var t=this,a=[],n=[],o=!!r.render_errors;return e.each(t.sections,function(e,t){var i=!1;if(r.sections&&Array.isArray(r.sections)&&(r.sections.indexOf(e)>=0||(i=!0)),"function"==typeof t.getData){var s=o&&!n.length,l=t.getData({clean:i,only_api:!!r.only_api,render_errors:s});l.length&&(a=a.concat(l)),l.errors&&(n=n.concat(l.errors))}}),n.length&&(a.errors=n,t.DEBUG("Errors:","warn",n)),a},l.prototype.update=function(r){r=r||{};var t=this,a=e.Deferred(),n=a.promise(),o=[],i=!!r.render_errors,s=!1;if(r.data)o=r.data;else{var l={render_errors:i};r.sections&&(l.sections=r.sections),
o=t.getFormData(l)}if(i&&o.errors)return a.reject("front_errors",o.errors),n;n=r.create?t.create(o):t.calculate(o);var p=["auth","region","shipping","details","payment","confirm"];return e.each(p,function(e,r){var a=null;if(!t.sections[r])return!0;a=t.sections[r],a.$wrapper.addClass("is-locked"),n.always(function(){a.$wrapper.removeClass("is-locked")}).then(function(e){if("function"==typeof a.render){a.render(e)&&(s=!0,t.trigger(r+"_changed",e))}},function(e,r){r&&t.DEBUG("render errors:","errors",r)})}),n.then(function(e){s&&t.trigger("changed",e)}),n},l.prototype.calculate=function(t){function a(){if(!t)return n.DEBUG("Form data is required.","error"),o.reject("error"),!1;t.push({name:"response",value:"json"}),n.DEBUG("Form data:","info"),n.DEBUG(t),n.calculate_xhr=e.post(n.urls.calculate,t,"json").done(function(e){if("ok"===e.status){var t=r(e.data);n.DEBUG("API received:","info"),n.DEBUG(t),o.resolve(t)}else n.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),o.reject("fail",e)}).fail(function(e,r){"abort"===r?a():(n.DEBUG("Getting API aborted.","error",r),o.reject(r))})}var n=this;if(n.calculate_promise)return n.calculate_xhr&&n.calculate_xhr.abort(),n.calculate_promise;var o=e.Deferred();return n.calculate_promise=o.promise(),n.calculate_promise.then(function(){n.calculate_promise=null,n.calculate_xhr=null},function(){n.calculate_promise=null,n.calculate_xhr=null}),a(),n.calculate_promise},l.prototype.create=function(t){var a=this;if(a.create_promise)return a.create_xhr&&a.create_xhr.abort(),a.create_promise;var n=e.Deferred();return a.create_promise=n.promise(),a.create_promise.then(function(){a.create_promise=null,a.create_xhr=null},function(){a.create_promise=null,a.create_xhr=null}),function(){if(!t)return a.DEBUG("Form data is required.","error"),n.reject("error"),!1;t.push({name:"response",value:"json"}),a.DEBUG("Form data for create:","info"),a.DEBUG(t),a.create_xhr=e.post(a.urls.create,t,"json").done(function(e){if("ok"===e.status){var t=r(e.data);a.DEBUG("API received:","info"),a.DEBUG(t),n.resolve(t)}else a.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),n.reject("fail",e)}).fail(function(e,r){a.DEBUG("Getting API aborted.","error",r),n.reject(r)})}(),a.create_promise},l.prototype.reload=function(){var r=this,t=e.Deferred();if(!r.reload_xhr){r.calculate_xhr&&(r.calculate_xhr.abort(),r.calculate_xhr=!1),r.lock(!0);var a=r.getFormData({only_api:!0});r.options&&(a.push({name:"opts[DEBUG]",value:r.options.DEBUG?1:0}),a.push({name:"opts[wrapper]",value:r.options.wrapper}),void 0===r.options.adaptive||r.options.adaptive&&"false"!==r.options.adaptive||a.push({name:"opts[adaptive]",value:"false"})),a.push({name:"response",value:"html"}),r.DEBUG("Form is reloading...","info",a),r.trigger("before_reload",r),r.reload_xhr=e.post(r.urls.calculate,a).done(function(e){r.$outer_wrapper.one("wa_order_form_ready",function(){var e=r.$outer_wrapper.data("controller");t.resolve(e)}),r.$wrapper.replaceWith(e),r.DEBUG("Form reloaded.","info"),r.trigger("reloaded",r)}).fail(function(e,a){r.DEBUG("Reload is failed.","error",a),t.reject(a)}).always(function(){r.lock(!1),r.reload_xhr=!1})}return t.promise()},l.prototype.lock=function(e){var r=this;e?r.$wrapper.addClass("is-locked"):r.$wrapper.removeClass("is-locked")},l}(e);window.waOrder=window.waOrder||{},window.waOrder.Form=l}(jQuery);
//# sourceMappingURL=form.min.js.map
