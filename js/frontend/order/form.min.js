!function(e){"use strict";var r=function(e){return r=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.templates=e.templates,r.errors=e.errors,r.scope=e.scope,r.reload=!1,r.initClass()},r.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(t){var o=e(this),a=!!o.data("affects-rate")||!!o.data("reload"),n=o.closest(".wa-field-wrapper");n.length||(n=o.parent()),r.scope.validate(n,!0).length||a&&r.update({reload:!0})}),r.initType(),r.initLogin(),r.initDatepicker()},r.prototype.initLogin=function(){var e=this;e.$wrapper.on("click",".js-show-login-dialog",function(e){}),e.$wrapper.on("click",".js-show-logout-dialog",function(e){})},r.prototype.initType=function(){var r=this,t=r.$wrapper.find(".js-type-toggle").first(),o=r.$wrapper.find(".js-type-field");new window.waOrder.ui.Toggle({$wrapper:t,change:function(t,a,n){var i=e(a).data("id");i&&(r.reload=!0,o.val(i),r.scope.update())}})},r.prototype.initDatepicker=function(){this.$wrapper.find(".js-datepicker").each(function(){var r=e(this),t={},o=r.data("alt");if(o){var a=r.closest(".wa-field-wrapper").find(o);a.length&&(t.altField=a,t.altFormat="yy-mm-dd")}r.datepicker(t),r.on("keydown keypress keyup",function(e){13===e.which&&e.preventDefault()})})},r.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"auth[html]",value:1});else{var o=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),r.reload&&t.push({name:"auth[html]",value:1});var a=r.scope.validate(r.$form,o);a.length&&(t.errors=a)}return t},r.prototype.render=function(e){var r=this,t=!1;return e.auth&&e.auth.html&&(r.$wrapper.replaceWith(e.auth.html),t=!0),t},r.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},r.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},r}(e),t=function(e){return t=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},t.prototype.initClass=function(){function r(r,a){r.length&&(r.on("keydown",function(){t(r)}),r.on("change",function(){a&&a.length&&e.each(a,function(e,r){r.length&&r.attr("disabled",!0)}),o(r)}))}function t(e){clearTimeout(n),n=setTimeout(function(){e.trigger("change")},i)}function o(e){clearTimeout(n),a.scope.trigger("region_change")}var a=this,n=0,i=2e3;"object"==typeof a.errors&&Object.keys(a.errors).length&&a.scope.DEBUG("Errors:","error",a.errors),a.$form.on("submit",function(e){e.preventDefault()});var s=a.$form.find(".js-location-field"),l=a.$form.find(".js-country-field"),p=a.$form.find(".js-region-field"),c=a.$form.find(".js-city-field"),u=a.$form.find(".js-zip-field");r(l,[p,c,u]),r(p,[c,u]),r(c,[u]),r(s),r(u)},t.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"region[html]",value:"only"});else{var o=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),r.reload&&t.push({name:"region[html]",value:"only"});var a=r.scope.validate(r.$form,o);a.length&&(t.errors=a)}return t},t.prototype.render=function(e){var r=this,t=!1;return e.region&&e.region.html&&(r.$wrapper.replaceWith(e.region.html),t=!0),t},t.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},t.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},t}(e),o=function(e){var r=function(e){return r=function(e){var r=this;r.$wrapper=e.$wrapper,r.active_class="is-active",r.onChange="function"==typeof e.onChange?e.onChange:function(){},r.$active=r.$wrapper.find(".wa-type-wrapper."+r.active_class),r.initClass()},r.prototype.initClass=function(){var r=this;r.$wrapper.on("click",".wa-type-wrapper",function(t){t.preventDefault(),r.changeType(e(this))})},r.prototype.changeType=function(e){var r=this;if(e.hasClass(r.active_class))return!1;var t=e.data("id");t&&(r.$active.length&&r.$active.removeClass(r.active_class),r.$active=e.addClass(r.active_class),r.onChange(t))},r}(jQuery);return o=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},o.prototype.initClass=function(){var t=this;"object"==typeof t.errors&&Object.keys(t.errors).length&&t.scope.DEBUG("Errors:","error",t.errors),t.$form.on("submit",function(e){e.preventDefault()});var o=null,a=t.$wrapper.find("#js-delivery-types-section");if(a.length){var n=a.find(".js-type-field");new r({$wrapper:a,onChange:function(e){n.val(e),t.scope.DEBUG("Delivery type changed â€” "+e,"info"),o&&o.val(""),t.update({reload:!0})}})}var i=t.$wrapper.find("#js-delivery-variants-section");i.length&&(o=i.find(".js-variant-field"),new window.waOrder.ui.Dropdown({$wrapper:i.find(".js-variants-select"),hover:!1,change_title:!1,change_selector:".wa-dropdown-item",change:function(r,a,n){var i=e(a),s=i.data("id"),l=i.find(".wa-name").data("name");o.val(s),n.setTitle(l),t.update({region:!0})}}))},o.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"shipping[html]",value:"only"});else{var o=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),r.reload&&t.push({name:"shipping[html]",value:"only"});var a=r.scope.validate(r.$form,o);a.length&&(t.errors=a)}return t},o.prototype.render=function(e){var r=this,t=!1;return e.shipping&&e.shipping.html&&(r.$wrapper.replaceWith(e.shipping.html),t=!0),t},o.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},o.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},o}(e),a=function(e){return a=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},a.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(t){var o=e(this),a=!!o.data("affects-rate")||!!o.data("reload"),n=o.closest(".wa-field-wrapper");n.length||(n=o.parent()),r.scope.validate(n,!0).length||a&&r.update({reload:!0})});var t=r.$wrapper.find(".wa-photos-section");t.length&&t.on("click",".js-show-photo",function(e){e.preventDefault(),window.open(this.href)})},a.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"details[html]",value:"only"});else{var o=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),r.reload&&t.push({name:"details[html]",value:"only"});var a=r.scope.validate(r.$form,o);a.length&&(t.errors=a)}return t},a.prototype.render=function(e){var r=this,t=!1;return e.details&&e.details.html&&(r.$wrapper.replaceWith(e.details.html),t=!0),t},a.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},a.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},a}(e),n=function(e){return n=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.errors=e.errors,r.scope=e.scope,r.locales=e.locales,r.reload=!0,r.initClass()},n.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(t){var o=e(this),a=!!o.data("affects-rate")||!!o.data("reload"),n=o.closest(".wa-field-wrapper");n.length||(n=o.parent()),r.scope.validate(n,!0).length||a&&r.update({reload:!0})}),r.initMethods()},n.prototype.initMethods=function(){function r(e){var r=e.find(".js-method-field");n.length&&n.removeClass(a),n=e.addClass(a),r.attr("checked",!0).trigger("change")}var t=this,o=t.$wrapper.find(".js-methods-list");if(!o.length)return!1;var a="is-active",n=o.find(".wa-method-wrapper."+a);o.on("click",".wa-method-wrapper",function(t){t.preventDefault();var o=e(this);n.length?n[0]!==o[0]&&r(o):r(o)})},n.prototype.getData=function(r){var t=this,o=[];if(r.clean)o.push({name:"payment[html]",value:"only"});else{var a=!1!==r.render_errors;t.$form.length&&(o=t.$form.serializeArray()),t.reload&&o.push({name:"payment[html]",value:1});var n=t.scope.validate(t.$wrapper,a),i=t.$wrapper.find(".js-methods-list");if(i.length){var s=i.find(".js-method-field:checked");if(s.length)o.push({name:s.attr("name"),value:s.val()});else if(n.push({$wrapper:i,id:"method_required",value:t.locales.method_required}),a){if(!i.hasClass("wa-error")){var l=e('<div class="wa-error-text" />').text(t.locales.method_required).insertAfter(i);i.addClass("wa-error").one("change",function(){i.removeClass("wa-error"),l.remove()})}}}n.length&&(o.errors=n)}return o},n.prototype.render=function(e){var r=this,t=!1;return e.payment&&e.payment.html&&(r.$wrapper.replaceWith(e.payment.html),t=!0),t},n.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},n.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},n}(e),i=function(e){return i=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.errors=e.errors,r.scope=e.scope,r.templates=e.templates,r.reload=!0,r.initClass()},i.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, input, textarea",function(t){var o=e(this),a=o.closest(".wa-field-wrapper");o.data("reload")?r.update({reload:!0}):a.length&&r.scope.validate(a,!0)});var t=r.$wrapper.find(".wa-comment-section");if(t.length){t.on("click"," .js-open-section",function(e){e.preventDefault(),t.toggleClass("is-opened")})}r.$wrapper.on("click",".js-show-terms-dialog",function(t){t.preventDefault(),r.templates.terms_dialog&&new r.scope.ui.Dialog({$wrapper:e(r.templates.terms_dialog)})}),r.$wrapper.on("click",".js-submit-order-button",function(e){e.preventDefault(),r.create()})},i.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"confirm[html]",value:"only"});else{var o=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),r.reload&&t.push({name:"confirm[html]",value:1});var a=r.scope.validate(r.$wrapper,o);a.length&&(t.errors=a)}return t},i.prototype.render=function(e){var r=this,t=!1;return e.confirm&&e.confirm.html&&(r.$wrapper.replaceWith(e.confirm.html),t=!0),t},i.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},i.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},i.prototype.create=function(){function r(r){var t=0;r.$field&&r.$field.length&&(t=r.$field.offset().top-40,r.$field.focus()),r.$wrapper&&r.$wrapper.length&&(t=r.$wrapper.offset().top-40),e("html, body").scrollTop(t)}var t=this,o=t.scope.validate(t.scope.$wrapper,!0);o.length?(t.scope.DEBUG("Errors:","error",o),r(o[0])):t.scope.update({create:!0,render_errors:!0}).then(function(e){if(e.order_id){t.scope.trigger("created",e);try{location.href=t.scope.urls.success}catch(e){t.scope.DEBUG(e.message,"error")}}else{var o=t.scope.renderErrors(e);o.length&&r(o[0])}},function(e,t){"front_errors"===e&&t.length&&r(t[0])})},i}(e),s=function(e){function l(r){return r.errors&&(Array.isArray(r.errors)||(r.errors=function(r){var t=[];return r&&e.each(r,function(e,r){t.push({name:e,value:r})}),t}(r.errors))),r}return s=function(r){var t=this;if(!(r.outer_options&&"string"==typeof r.outer_options.wrapper&&r.outer_options.wrapper.length>0))throw new Error("Checkout wrapper element not specified.");var o=e(r.outer_options.wrapper);if(1!==o.length)throw new Error("Error: Checkout form wrapper element must be exactly one on page (found "+o.length+")");if(!r.urls.calculate)throw new Error("Must specify url_calculate");if(!r.urls.create)throw new Error("Must specify url_create_order");t.$outer_wrapper=o,t.$wrapper=r.$wrapper,t.options=r.outer_options,t.locales=r.locales,t.urls=r.urls,t.ui=window.waOrder.ui,t.sections={},t.render_scheduled=!1,t.calculate_promise=null,t.create_promise=null,t.calculate_xhr=null,t.reload_xhr=null,t.create_xhr=null,t.initClass()},s.prototype.initClass=function(){function r(){var e=o.getFormData({sections:["auth","region","confirm"]});o.update({data:e}).then()}function t(){e.contains(document,o.$wrapper[0])?o.update().then():e(document).off("click",t)}var o=this;o.$wrapper.removeAttr("style").removeClass("is-not-ready"),o.$outer_wrapper.data("controller",o).trigger("wa_order_form_ready"),o.$wrapper.data("ready").resolve(o),o.$wrapper.on("region_change",r),e(document).on("wa_order_cart_changed",t)},s.prototype.DEBUG=function(){var e=this,r=console.log,t={hint:"font-weight: bold; color: #666;",info:"font-weight: bold; font-size: 1.25em; color: blue;",warn:"font-weight: bold; font-size: 1.25em;",error:"font-weight: bold; font-size: 1.25em;"};if(e.options&&e.options.DEBUG){if(t[arguments[1]]){switch(arguments[0]="string"==typeof arguments[0]?"%c"+arguments[0]:arguments[0],arguments[1]){case"info":r=console.info;break;case"error":r=console.error;break;case"warn":r=console.warn}arguments[1]=t[arguments[1]]}return r.apply(console,arguments)}},s.prototype.initAuth=function(e){var t=this;e.scope=t,t.sections.auth=new r(e),t.DEBUG("Auth initialized","info",t.sections.auth)},s.prototype.initRegion=function(e){var r=this;e.scope=r,r.sections.region=new t(e),r.DEBUG("Region initialized","info",r.sections.region)},s.prototype.initShipping=function(e){var r=this;e.scope=r,r.sections.shipping=new o(e),r.DEBUG("Shipping initialized","info",r.sections.shipping)},s.prototype.initDetails=function(e){var r=this;e.scope=r,r.sections.details=new a(e),r.DEBUG("Details initialized","info",r.sections.details)},s.prototype.initPayment=function(e){var r=this;e.scope=r,r.sections.payment=new n(e),r.DEBUG("Payment initialized","info",r.sections.payment)},s.prototype.initConfirm=function(e){var r=this;e.scope=r,r.sections.confirm=new i(e),r.DEBUG("Confirm initialized","info",r.sections.confirm)},s.prototype.trigger=function(e,r){var t=this,o="wa_order_form_"+e;t.$wrapper.triggerHandler(e,r||null),t.$outer_wrapper.trigger(o,r||null)},s.prototype.validate=function(r,t){function o(r){function t(){n.removeClass(a),o.remove(),n.off("change",t)}var o=e('<div class="wa-error-text" />').text(r.value),a="wa-error";if(r.$field){var n=r.$field;if(!n.hasClass(a)){n.addClass(a);var i=n.closest(".wa-field-wrapper");i.length?i.append(o):o.insertAfter(n),n.on("change keyup",t)}}}var a=this,n=[];return r.find(".wa-input").each(function(){var r=e(this),t=r.attr("name"),o=r.val().trim();if(r.is(":disabled"))return!0;if(o.length){if(!t)return!0;if(r.hasClass("wa-email")){a.ui.validate.email(o)||n.push({$field:r,name:t,value:a.locales.invalid})}else if(r.hasClass("wa-phone")){var i=a.ui.validate.phone(o);i||n.push({$field:r,name:t,value:a.locales.invalid})}else if(r.hasClass("wa-url")){var s=a.ui.validate.url(o);s||n.push({$field:r,name:t,value:a.locales.invalid})}else if(r.hasClass("wa-number")){var l=a.ui.validate.number(o);l||n.push({$field:r,name:t,value:a.locales.invalid})}}else{!!r.attr("required")&&n.push({$field:r,name:t,value:a.locales.required})}}),r.find(".wa-checkbox").each(function(){var r=e(this),t=r.attr("name"),o=r.is(":checked");if(r.is(":disabled"))return!0;if(o){if(!t)return!0}else{!!r.attr("required")&&n.push({$field:r,name:t,value:a.locales.required})}}),r.find(".wa-select, wa-textarea").each(function(){var r=e(this),t=r.attr("name"),o=e.trim(r.val());if(r.is(":disabled"))return!0;if(o.length){if(!t)return!0}else{!!r.attr("required")&&n.push({$field:r,name:t,value:a.locales.required})}}),t&&n.length&&e.each(n,function(e,r){o(r)}),n},s.prototype.renderErrors=function(r){var t=this,o=[];return r.error_step_id&&r.errors&&e.each(t.sections,function(e,t){if(r.error_step_id===e&&"function"==typeof t.renderErrors){var a=t.renderErrors(r.errors);a.length&&(o=o.concat(a))}}),o},s.prototype.getFormData=function(r){r=r||{};var t=this,o=[],a=[],n=!!r.render_errors;return e.each(t.sections,function(e,t){var i=!1;if(r.sections&&Array.isArray(r.sections)&&(r.sections.indexOf(e)>=0||(i=!0)),"function"==typeof t.getData){var s=n&&!a.length,l=t.getData({render_errors:s,clean:i});l.length&&(o=o.concat(l)),l.errors&&(a=a.concat(l.errors))}}),a.length&&(o.errors=a,t.DEBUG("Errors:","warn",a)),o},s.prototype.update=function(r){r=r||{};var t=this,o=e.Deferred(),a=o.promise(),n=[],i=!!r.render_errors,s=!1;if(n=r.data?r.data:t.getFormData({render_errors:i}),i&&n.errors)return o.reject("front_errors",n.errors),a;a=r.create?t.create(n):t.calculate(n);return e.each(t.sections,function(e,r){r.$wrapper.addClass("is-locked"),a.always(function(){r.$wrapper.removeClass("is-locked")}).then(function(o){if("function"==typeof r.render){r.render(o)&&(s=!0,t.trigger(e+"_changed",o))}},function(e,r){r&&t.DEBUG("render errors:","errors",r)})}),a.then(function(e){s&&t.trigger("changed",e)}),a},s.prototype.calculate=function(r){function t(){if(!r)return o.DEBUG("Form data is required.","error"),a.reject("error"),!1;r.push({name:"response",value:"json"}),o.DEBUG("Form data:","info"),o.DEBUG(r),o.calculate_xhr=e.post(o.urls.calculate,r,"json").done(function(e){if("ok"===e.status){var r=l(e.data);o.DEBUG("API received:","info"),o.DEBUG(r),a.resolve(r)}else o.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),a.reject("fail",e)}).fail(function(e,r){"abort"===r?t():(o.DEBUG("Getting API aborted.","error",r),a.reject(r))})}var o=this;if(o.calculate_promise)return o.calculate_xhr&&o.calculate_xhr.abort(),o.calculate_promise;var a=e.Deferred();return o.calculate_promise=a.promise(),o.calculate_promise.then(function(){o.calculate_promise=null,o.calculate_xhr=null},function(){o.calculate_promise=null,o.calculate_xhr=null}),t(),o.calculate_promise},s.prototype.create=function(r){var t=this;if(t.create_promise)return t.create_xhr&&t.create_xhr.abort(),t.create_promise;var o=e.Deferred();return t.create_promise=o.promise(),t.create_promise.then(function(){t.create_promise=null,t.create_xhr=null},function(){t.create_promise=null,t.create_xhr=null}),function(){if(!r)return t.DEBUG("Form data is required.","error"),o.reject("error"),!1;r.push({name:"response",value:"json"}),t.DEBUG("Form data for create:","info"),t.DEBUG(r),t.create_xhr=e.post(t.urls.create,r,"json").done(function(e){if("ok"===e.status){var r=l(e.data);t.DEBUG("API received:","info"),t.DEBUG(r),o.resolve(r)}else t.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),o.reject("fail",e)}).fail(function(e,r){t.DEBUG("Getting API aborted.","error",r),o.reject(r)})}(),t.create_promise},s.prototype.reload=function(){var r=this,t=e.Deferred();if(!r.reload_xhr){r.calculate_xhr&&(r.calculate_xhr.abort(),r.calculate_xhr=!1),r.$wrapper.addClass("is-locked");var o=r.getFormData();r.options&&(o.push({name:"opts[DEBUG]",value:r.options.DEBUG?1:0}),o.push({name:"opts[wrapper]",value:r.options.wrapper})),o.push({name:"response",value:"html"}),r.DEBUG("Form is reloading...","info",o),r.trigger("before_reload",r),r.reload_xhr=e.post(r.urls.calculate,o).done(function(e){r.$outer_wrapper.one("wa_order_form_ready",function(){var e=r.$outer_wrapper.data("controller");t.resolve(e)}),r.$wrapper.replaceWith(e),r.DEBUG("Form reloaded.","info"),r.trigger("reloaded",r)}).fail(function(e,o){r.DEBUG("Reload is failed.","error",o),t.reject(o)}).always(function(){r.$wrapper.removeClass("is-locked"),r.reload_xhr=!1})}return t.promise()},s}(e);window.waOrder=window.waOrder||{},window.waOrder.Form=s}(jQuery);
//# sourceMappingURL=form.min.js.map
