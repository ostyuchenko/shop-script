(function(a){function b(b){return a.data(b,"tooltip")}function c(c){b(this).delay?m=setTimeout(f,b(this).delay):f();u=!!b(this).track;a(document.body).bind("mousemove",d);d(c)}function e(){if(!a.tooltip.blocked&&this!=k&&(this.tooltipText||b(this).bodyHandler)){k=this;q=this.tooltipText;if(b(this).bodyHandler){g.title.hide();var d=b(this).bodyHandler.call(this);d.nodeType||d.jquery?g.body.empty().append(d):g.body.html(d);g.body.show()}else if(b(this).showBody){d=q.split(b(this).showBody);g.title.html(d.shift()).show();
g.body.empty();for(var e=0,f;f=d[e];e++)0<e&&g.body.append("<br/>"),g.body.append(f);g.body.hideWhenEmpty()}else g.title.html(q).show(),g.body.hide();b(this).showURL&&a(this).url()?g.url.html(a(this).url().replace("http://","")).show():g.url.hide();g.parent.addClass(b(this).extraClass);b(this).fixPNG&&g.parent.fixPNG();c.apply(this,arguments)}}function f(){m=null;l&&a.fn.bgiframe||!b(k).fade?g.parent.show():g.parent.is(":animated")?g.parent.stop().show().fadeTo(b(k).fade,k.tOpacity):g.parent.is(":visible")?
g.parent.fadeTo(b(k).fade,k.tOpacity):g.parent.fadeIn(b(k).fade);d()}function d(c){if(!(a.tooltip.blocked||c&&"OPTION"==c.target.tagName))if(!u&&g.parent.is(":visible")&&a(document.body).unbind("mousemove",d),null==k)a(document.body).unbind("mousemove",d);else{g.parent.removeClass("viewport-right").removeClass("viewport-bottom");var e=g.parent[0].offsetLeft,f=g.parent[0].offsetTop;c&&(e=c.pageX+b(k).left,f=c.pageY+b(k).top,c="auto",b(k).positionLeft&&(c=a(window).width()-e,e="auto"),g.parent.css({left:e,
right:c,top:f}));c=a(window).scrollLeft();var h=a(window).scrollTop(),q=a(window).width(),m=a(window).height(),l=g.parent[0];c+q<l.offsetLeft+l.offsetWidth&&(e-=l.offsetWidth+20+b(k).left,g.parent.css({left:e+"px"}).addClass("viewport-right"));h+m<l.offsetTop+l.offsetHeight&&(f-=l.offsetHeight+20+b(k).top,g.parent.css({top:f+"px"}).addClass("viewport-bottom"))}}function h(d){function c(){g.parent.removeClass(e.extraClass).hide().css("opacity","")}if(!a.tooltip.blocked){m&&clearTimeout(m);k=null;var e=
b(this);l&&a.fn.bgiframe||!e.fade?c():g.parent.is(":animated")?g.parent.stop().fadeTo(e.fade,0,c):g.parent.stop().fadeOut(e.fade,c);b(this).fixPNG&&g.parent.unfixPNG()}}var g={},k,q,m,l=a.browser.msie&&/MSIE\s(5\.5|6\.)/.test(navigator.userAgent),u=!1;a.tooltip={blocked:!1,defaults:{delay:200,fade:!1,showURL:!0,extraClass:"",noHideOnClick:!1,top:15,left:15,id:"tooltip"},block:function(){a.tooltip.blocked=!a.tooltip.blocked}};a.fn.extend({tooltip:function(b){b=a.extend({},a.tooltip.defaults,b);g.parent||
(g.parent=a('<div id="'+b.id+'"><h3></h3><div class="body"></div><div class="url"></div></div>').appendTo(document.body).hide(),a.fn.bgiframe&&g.parent.bgiframe(),g.title=a("h3",g.parent),g.body=a("div.body",g.parent),g.url=a("div.url",g.parent));var c=this.each(function(){a.data(this,"tooltip",b);this.tOpacity=g.parent.css("opacity");this.tooltipText=this.title;a(this).removeAttr("title");this.alt=""}).mouseover(e).mouseout(h);b.noHideOnClick||c.click(h);return c},fixPNG:l?function(){return this.each(function(){var b=
a(this).css("backgroundImage");b.match(/^url\(["']?(.*\.png)["']?\)$/i)&&(b=RegExp.$1,a(this).css({backgroundImage:"none",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+b+"')"}).each(function(){var b=a(this).css("position");"absolute"!=b&&"relative"!=b&&a(this).css("position","relative")}))})}:function(){return this},unfixPNG:l?function(){return this.each(function(){a(this).css({filter:"",backgroundImage:""})})}:function(){return this},hideWhenEmpty:function(){return this.each(function(){a(this)[a(this).html()?
"show":"hide"]()})},url:function(){return this.attr("href")||this.attr("src")}})})(jQuery);(function(a){var b=function(a,e,f){var d=/[^\w\-\.:]/.test(a)?new Function(b.arg+",tmpl","var _e=tmpl.encode"+b.helper+",_s='"+a.replace(b.regexp,b.func)+"';return _s;"):f?b.cache[a]=b(b.load(a)):b.cache[a]=b.cache[a]||b(b.load(a));return e?d(e,b):function(a){return d(a,b)}};b.cache={};b.load=function(a){var b=document.getElementById(a),f=/<\\\/(\w+)/g;if(!b&&console)throw{message:"template with id="+a+" not found"};return b?("textarea"==b.tagName.toLowerCase()?b.value:document.getElementById(a).innerHTML).replace(f,
"</$1"):null};b.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;b.func=function(a,b,f,d,h,g){if(b)return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[a]||"\\"+a;if(f)return"="===f?"'+_e("+d+")+'":"'+("+d+"||'')+'";if(h)return"';";if(g)return"_s+='"};b.encReg=/[<>&"'\x00]/g;b.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};b.encode=function(a){return String(a||"").replace(b.encReg,function(a){return b.encMap[a]||""})};b.arg="o";b.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}";
"function"===typeof define&&define.amd?define(function(){return b}):a.tmpl=b})(this);(function(a){a.fn.lazyLoad=function(b,c){function e(){if(d.stopped)this.onscroll=null;else if(!d.stopped&&!d.loading&&k(g,h)<=d.distance){if(null!==d.hash){var a=location.hash.replace(/^[^#]*#\/*/,"").split("/")[0];if(-1===d.hash.indexOf(a)){this.onscroll=null;return}}d.load()}}function f(){var a=setTimeout(function(){if(d.stopped)clearTimeout(a);else{if(null!==d.hash){var b=location.hash.replace(/^[^#]*#\/*/,"").split("/")[0];if(-1===d.hash.indexOf(b)){clearTimeout(a);return}}d.loading?a=setTimeout(arguments.callee,
350):(k(g,h),k(g,h)<=d.distance?(d.load(),a=setTimeout(arguments.callee,350)):(h.get(0).onscroll=e,clearTimeout(a)))}},350)}if("stop"==b){var d=this.data("lazyLoadSettings");d&&(d.stopped=!0)}else if("reload"==b){if(d=this.data("lazyLoadSettings"))d.stopped=!1,d.loading=!1,this.get(0).onscroll=null,this.lazyLoad(d)}else if("sleep"==b){if(d=this.data("lazyLoadSettings"))d.loading=!0}else if("wake"==b){if(d=this.data("lazyLoadSettings"))d.loading=!1}else if("force"==b)(d=this.data("lazyLoadSettings"))&&
(d.loading||d.load());else{this.data("lazyLoadSettings",a.extend({distance:50,load:function(){},container:g,state:"wake",hash:location.hash.replace(/^[^#]*#\/*/,"").split("/")[0]||null,distanceBetweenBottoms:null},b||{}));d=this.data("lazyLoadSettings");d.loading=!1;d.stopped=!1;var h=this,g=d.container;null===d.hash||a.isArray(d.hash)||(d.hash=[d.hash]);a.fn.lazyLoad.call(h,d.state);f();var k="function"===typeof d.distanceBetweenBottoms?d.distanceBetweenBottoms:function(b,d,c){b="string"===typeof b?
a(b):b;c=c||0;return b.position().top+b.outerHeight()-c-(d.scrollTop()+d.height())}}}})(jQuery);(function(a){a.storage=new a.store;a.orders={options:{view:"table"},init:function(b){var c=this;c.options=b;"undefined"!=typeof a.History&&a.History.bind(function(){c.dispatch()});a.wa.errorHandler=function(b){return 403===b.status||404===b.status?(b=a(b.responseText),b=b.find(".dialog-content").length?a('<div class="block double-padded"></div>').append(b.find(".dialog-content *")):a('<div class="block double-padded"></div>').append(b.find(":not(style)")),a("#s-content").empty().append(b),a.orders.onPageNotFound(),
!1):!0};b=window.location.hash;"#/"!==b&&b?a.wa.setHash(b):this.dispatch();this.initSearch();a(document).bind("wa.appcount",function(b,c){var d=parseInt(c.shop,10);a("#s-pending-orders .small").text(d?"+"+d:"");var h=document.title.match(/\(\d+\) /);h?document.title=document.title.replace(h[0],d?"("+d+") ":""):d&&(document.title="("+d+") "+document.title)})},onPageNotFound:function(){a.order_list&&a.order_list.finit()},initSearch:function(){var b=a("#s-orders-search"),c=[],e=function(c){switch(c.autocomplete_item_type){case "order":a.wa.setHash("#/order/"+
c.id+"/");b.val(c.value);break;case "contact":a.wa.setHash("#/orders/contact_id="+c.id+"/");b.val(c.value);break;case "product":a.wa.setHash("#/orders/product_id="+c.id+"/");b.val(c.value);break;case "coupon":a.wa.setHash("#/orders/coupon_id="+c.id+"/");break;case "shipping":a.wa.setHash("#/orders/shipping_id="+c.id+"/");break;case "payment":a.wa.setHash("#/orders/payment_id="+c.id+"/");break;case "city":a.wa.setHash("#/orders/city="+c.value+"/");break;case "region":a.wa.setHash("#/orders/region="+
((c.value||"").split(":")[1]||"")+"/");break;case "country":a.wa.setHash("#/orders/country="+c.value+"/")}};b.unbind("keydown").bind("keydown",function(b){if(13==b.keyCode||10==b.keyCode){var d=a(this);if(!a(this).val())return location.hash="#/orders/all/",d.autocomplete("close"),!1;if(c&&a.isArray(c)&&c.length)return e(c[0]),setTimeout(function(){d.autocomplete("close")},150),!1}});b.autocomplete({minLength:1,delay:300,html:!0,select:function(a,b){e(b.item);return!1},source:function(b,d){a.getJSON("?action=autocomplete&type=order",
b,function(a){c=a;d(a)})}})},prevHash:null,hash:null,skipDispatch:0,stopDispatch:function(a){this.skipDispatch=a},dispatch:function(b){if(0<this.skipDispatch)return this.skipDispatch--,!1;if(void 0===b||null===b)b=window.location.hash;b=b.replace(/(^[^#]*#\/*|\/$)/g,"");null!==this.hash&&(this.prevHash=this.hash);if(this.hash=b)if(b=b.split("/"),b[0]){for(var c="",e=b.length,f=null,d=null,e=0;e<b.length;e++){var h=b[e];if(2>e){if(0===e)c=h;else if(parseInt(h,10)!=h&&-1==h.indexOf("="))c+=h.substr(0,
1).toUpperCase()+h.substr(1);else break;"function"==typeof this[c+"Action"]&&(f=c,d=e+1)}else break}"function"!==typeof this[c+"Action"]&&f&&(c=f,e=d);b=b.slice(e);this.preExecute(c);"function"==typeof this[c+"Action"]?(a.shop.trace("$.orders.dispatch",[c+"Action",b]),this[c+"Action"].apply(this,b)):a.shop.error("Invalid action name:",c+"Action");this.postExecute(c)}else this.preExecute(),this.defaultAction(),this.postExecute();else this.preExecute(),this.defaultAction(),this.postExecute()},back:function(){var b=
a.orders.prevHash||"";location.hash=b?b+"/":""},preExecute:function(a,c){},postExecute:function(a,c){this.actionName=a},defaultAction:function(){this.ordersAction()},couponsAction:function(){a.order_list&&a.order_list.finit();this.load("?module=coupons")},ordersEditAction:function(b){this.load("?module=order&action=edit&id="+b,function(){a.order_list&&a.order_list.finit()})},ordersNewAction:function(){this.load("?module=order&action=edit",function(){a.order_list&&a.order_list.finit()})},ordersAction:function(b){if("hash"===
b)b={hash:Array.prototype.slice.call(arguments,1).join("/")};else{var c="";"search"===b&&(c=Array.prototype.slice.call(arguments,1));1<arguments.length&&(b=Array.prototype.join.call(arguments,"/"));b?"all"===b&&(b=""):b="state_id=new|processing|paid";b=a.shop.helper.parseParams(b||"");b.view||(b.view=a.storage.get("shop/orders/view")||this.options.view);a.storage.set("shop/orders/view",b.view);a.order_edit&&a.order_edit.slideBack();c&&(b.search=c)}"orders"===this.actionName&&a.order_list?a.order_list.dispatch(b):
(a.order_list&&a.order_list.finit(),this.load("?module=orders&"+this.buildOrdersUrlComponent(b),function(){a.order_list&&a.order_list.dispatch(b)}))},orderAction:function(b,c){c=a.shop.helper.parseParams(c||"");c.view||(c.view=a.storage.get("shop/orders/view")||this.options.view);a.storage.set("shop/orders/view",c.view);a.order_edit&&a.order_edit.slideBack();this.load("?module=order&id="+encodeURIComponent(b)+"&"+this.buildOrdersUrlComponent(c),function(){a("#s-content").find("h1 .back.order-list").show()});
a.order_list&&a.order_list.finit()},buildOrdersUrlComponent:function(a){var c="",e;for(e in a)a.hasOwnProperty(e)&&"view"!==e&&(c+="&"+e+"="+a[e]);return"view="+(a.view||this.options.view)+c},load:function(b,c,e){"function"===typeof c?(e=c,c={}):c=c||{};var f=Math.random();this.random=f;var d=this;return a.get(b,function(b){if("undefined"!==typeof c.check&&!c.check||d.random==f)(c.content||a("#s-content")).removeClass("bordered-left").html(b),"function"===typeof e&&e.call(this),a("html, body").animate({scrollTop:0},
200),a(".level2").show(),a("#s-sidebar").width(200).show()})}}})(jQuery);$.order_list={id:0,options:{},container:null,sidebar:null,select_all_input:null,filter_params:{},filter_params_str:"",params:null,timer_id:0,lazy_load_win:null,xhrs:{lazy_load:null,update_load:null},init:function(a){this.options=a=a||{};this.filter_params=a.filter_params||{};this.filter_params_str=a.filter_params_str||"";this.container=$("#order-list");"table"==a.view&&(this.select_all_input=this.container.find(".s-select-all"),this.container=$("#order-list").find("tbody:first"));this.sidebar=$("#s-sidebar");
this.id=a.id||0;if(a.orders&&a.orders.length&&a.view){try{this.container.append(tmpl("template-order-list-"+this.options.view,{orders:a.orders},!0)),this.container.trigger("append_order_list",[a.orders])}catch(b){return console&&console.log(b.stack),this}delete a.orders;delete this.options.orders}a.lazy_loading&&this.initLazyLoad(a.lazy_loading);a.counters&&this.updateCounters(a.counters);a.update_process&&a.count&&this.updateProcess("run",a.update_process);this.initView()},initLazyLoad:function(a){var b=
this,c=b.options.count,e=b.options.total_count,f=$(window);f.lazyLoad("stop");c<e&&(f.lazyLoad({container:this.options.view?b.container:f,state:"undefined"===typeof a.auto||a.auto?"wake":"stop",hash:["orders",""],load:function(){f.lazyLoad("sleep");$(".lazyloading-link").hide();$(".lazyloading-progress").show();var a=b.container.find(".order:last"),c=parseInt(a.attr("data-order-id"),10);if(c){var g=function(){return $.getJSON(b.buildLoadListUrl(c),function(a){if("ok"==a.status){try{b.container.append(tmpl("template-order-list-"+
b.options.view,{orders:a.data.orders,check_all:"table"==b.options.view?b.select_all_input.attr("checked"):!1})),b.container.trigger("append_order_list",[a.data.orders]),b.container.find("[data-order-id="+b.options.id+"]").length&&(b.container.find(".selected").removeClass("selected"),b.container.find("[data-order-id="+b.options.id+"]").addClass("selected"))}catch(c){console&&console.log(c.stack);f.lazyLoad("stop");return}$(".lazyloading-progress-string").text(a.data.progress.loaded+" "+a.data.progress.of);
$(".lazyloading-progress").hide();$(".lazyloading-chunk").text(a.data.progress.chunk);a.data.loaded>=a.data.total_count?(f.lazyLoad("stop"),$(".lazyloading-link").hide()):($(".lazyloading-link").show(),f.lazyLoad("wake"))}else console&&console.log("Error when loading orders: "+a.errors),f.lazyLoad("stop")}).error(function(a){console&&(a&&a.errors?console.log("Error when loading orders: "+a.errors):a?console.log(a):console.log("Error when loading orders"));f.lazyLoad("stop")})};null===b.xhrs.update_load?
b.xhrs.lazy_load=g():b.xhrs.update_load.then(function(){b.xhrs.lazy_load=g()})}else console.log("Unkown last item"),f.lazyLoad("stop")}}),$("#s-orders").off("click",".lazyloading-link").on("click",".lazyloading-link",function(){f.lazyLoad("force");return!1}),this.lazy_load_win=f)},initView:function(){this.initSidebar();"table"==this.options.view&&this.initSelecting();this.options.id&&this.loadOrder(this.options.id);var a=$("#s-orders-views");a.find("li.selected").removeClass("selected");a.find("li[data-view="+
this.options.view+"]").addClass("selected");a.find("li a").each(function(){var a=$(this),b=$(this).parents("li:first");a.attr("href","#/orders/view="+b.attr("data-view")+($.order_list.options.filter_params_str?"&"+$.order_list.options.filter_params_str:"")+"/")});var b=function(a,b){var f=function(a,b){$.order_list.updateCounters({state_counters:a.data.state_counters,common_counters:{pending:a.data.pending_count}});$.isEmptyObject(a.data.orders)||$.order_list.updateListItems(a.data.orders);$.order_list.select_all_input.trigger("select",
!1);var c=[],d=$.order_list.filter_params;if(!$.isEmptyObject(a.data.orders))for(var e=0,f=a.data.orders.length;e<f;e++)!$.isEmptyObject(d)&&d.state_id&&("string"===$.type(d.state_id)&&d.state_id!==a.data.orders[e].state_id?c.push(a.data.orders[e].id):"array"===$.type(d.state_id)&&-1!==d.state_id.indexOf(a.data.orders[e].state_id)&&c.push(a.data.orders[e].id));$.isEmptyObject(c)||$.order_list.hideListItems(c).done(function(){if(!$.order_list.container.find(".order:not(:hidden):first").length){var a=
'<div class="block double-padded align-center blank"><br><br><br><br><span class="gray large">'+$_("There are no orders in this view.")+'</span><div class="clear-left"></div></div></div>';$("#s-content").html(a)}});b instanceof Function&&b(a)},d=function(h,g){$.shop.jsonPost("?module=orders&action=performAction&id="+a+"&offset="+(h||0)+"&"+$.order_list.options.filter_params_str,b,function(a){"ok"==a.status?a.data.offset<a.data.total_count?d(a.data.offset,f):f(a,g):f(a,g)})};d(0,function(){$.orders.dispatch()})};
$("#order-list").find(".wf-actions a").click(function(){var a=$(this).attr("data-action-id");if(a){var e=$.order_list.getSelectedOrders();e.order_id?b(a,e):confirm($_("Perform action to all selected orders?"))&&b(a,e)}return!1})},loadOrder:function(a){this.container.find(".selected").removeClass("selected");this.container.find("[data-order-id="+a+"]").addClass("selected");$("#s-order-title").find(".loading").show();$.orders.load("?module=order&id= "+a+"&"+this.filter_params_str,{content:$("#s-order")},
function(){this.id=a})},getSelectedOrders:function(a){a=a||!1;var b={count:0};if(this.select_all_input.attr("checked")){var c=$.order_list.filter_params;if(a)if(b.serialized=[],$.isEmptyObject(c))b.serialized.push({name:"filter_params",value:""});else{a=0;for(var e=hash.length;a<e;a+=1)b.serialized.push({name:"filter_params[]",value:c[a]})}else b.filter_params=$.isEmptyObject(c)?"":c;b.count=this.options.total_count}else a?b.serialized=$.order_list.container.find(".order.selected").map(function(){b.count+=
1;return{name:"order_id[]",value:$(this).attr("data-order-id")}}).toArray():b.order_id=$.order_list.container.find(".order.selected").map(function(){b.count+=1;return $(this).attr("data-order-id")}).toArray();return b},initSidebar:function(){var a=this.sidebar,b=this.options.view;a.find("li.list a").each(function(){var a=$(this),c=a.attr("href"),d=c.match(/view=((.*)&|(.*)\/|(.*))/);d?a.attr("href",c.replace("view="+(d[2]||d[3]||d[4]),"view="+b)):(d=c.match(/^#\/orders\/hash\/(.*?)\/?$/))?a.attr("href",
"#/orders/view="+b+"&hash="+encodeURIComponent(d[1])+"/"):(d=c.match(/orders\/((.*)\/|(.*))/),c="",d&&(d[1]?(c=d[2]||d[3],c+="&view="+b):c="view="+b,a.attr("href","#/orders/"+c+"/")))});var c=a.find("li.selected").removeClass("selected");this.filter_params.state_id?$.isArray(this.filter_params.state_id)?$("#s-pending-orders").addClass("selected"):a.find('li[data-state-id="'+this.filter_params.state_id+'"]').addClass("selected"):this.filter_params.contact_id?a.find("li[data-contact-id="+this.filter_params.contact_id+
"]").addClass("selected"):this.filter_params.storefront?(c=decodeURIComponent(this.filter_params.storefront),"/"===c.slice(-1)&&(c=c.slice(0,-1)),a.find('li[data-storefront="'+c+'"]').addClass("selected")):$.order_list.filter_params_str?a.find('[href="'+window.location.hash+'"]:first').closest("li").addClass("selected").length||c.addClass("selected"):$("#s-all-orders").addClass("selected");a.find("li.list a").unbind("click.order_list").bind("click.order_list",function(){a.find("li.selected").removeClass("selected");
$(this).closest("li").addClass("selected");if($(this).attr("href").replace(/(^[^#]*#\/*|\/$)/g,"")==$.orders.hash){var b=$.orders.hash.replace("orders/","");$.order_list.dispatch(b,!0)}})},initSelecting:function(){var a=this.container,b=this.select_all_input;b.click(function(){$(this).trigger("select",this.checked)});$(document).keydown(function(a){16==a.keyCode&&(document.body.onselectstart=function(){return!1})}).keyup(function(a){16==a.keyCode&&(document.body.onselectstart=null)});var c=function(){if($.order_list.filter_params&&
!$.order_list.filter_params.length){var a=$("#order-list");b.attr("checked")?a.find(".s-with-selected").show():a.find(".order.selected:first").length?a.find(".s-with-selected").show():a.find(".s-with-selected").hide()}};a.off("select",".order").on("select",".order",function(a,f){(void 0!==f?f:1)?$(this).addClass("selected").find("input:first").attr("checked",!0):($(this).removeClass("selected").find("input:first").attr("checked",!1),b.is(":checked")&&b.attr("checked",!1));c();return!1});b.unbind("select").bind("select",
function(b,c){c=void 0!==c?c:!0;var d=$(this);c?(d.attr("checked",!0),a.find(".order").trigger("select",!0,!1)):(d.attr("checked",!1),a.find(".order").trigger("select",!1,!1))});a.off("click",".order input").on("click",".order input",function(e){var f=e.shiftKey;e=this.checked;var d=$(this).parents(".order:first");e?d.addClass("selected"):(b.is(":checked")&&b.attr("checked",!1),d.removeClass("selected"));if(f&&e){(f=a.data("last_checked"))||(f=a.find(".order:first").trigger("select",!0));var h=d.prevAll(".selected[data-order-id="+
f.attr("data-order-id")+"]"),g;if(h.length)for(g=d.prev(),f=f.get(0);g.length&&f!=g.get(0);)g.addClass("selected").find("input").attr("checked",!0),g=g.prev();else if(h=d.nextAll(".selected[data-order-id="+f.attr("data-order-id")+"]"),h.length)for(g=d.next(),f=f.get(0);g.length&&f!=g.get(0);)g.addClass("selected").find("input").attr("checked",!0),g=g.next();a.data("last_checked")||h.length||f.trigger("selected",!1)}e&&a.data("last_checked",d);c()})},updateTitle:function(a,b){b=parseInt(b,10)||0;var c=
"";this.options.state_names&&(this.filter_params.state_id?"string"===typeof this.filter_params.state_id?c=this.options.state_names[this.filter_params.state_id]:$.isArray(this.filter_params.state_id)&&(c=$_("Processing")):c=$_("All orders"));document.title=b?"("+b+") "+c+(a||""):c+a},updateCounters:function(a){var b=this.sidebar;b||(b=$("#s-sidebar"));var c=$("#s-pending-orders .small"),e;for(e in a)if(a.hasOwnProperty(e)){var f=a[e],d;for(d in f)if(f.hasOwnProperty(d)){var h;h="common_counters"==
e?$("#s-"+d+"-orders .count"):"storefront_counters"!==e?b.find("li[data-"+e.replace("_counters","")+"-id="+d+"] .count"):b.find("li[data-"+e.replace("_counters","")+'="'+d+'"] .count');var g=parseInt(h.text(),10)||0,k=0;f[d]=""+f[d];"+"==f[d].substr(0,1)?k=g+(parseInt(f[d].substr(1),10)||0):"-"==f[d].substr(0,1)?(k=g-(parseInt(f[d].substr(1),10)||0),k=0>k?0:k):k=parseInt(f[d],10)||0;h.text(k);"new"==d&&(c.text(k?"+"+k:""),$.shop.updateAppCounter(k),this.updateTitle(this.options.title_suffix,parseInt(k,
10)))}}},updateListItems:function(a){var b="template-order-list-"+this.options.view;if(document.getElementById(b)){var c=this.container;$.isArray(a)||(a=[a]);var b=$("<div></div>").append(tmpl(b,{orders:a,check_all:"table"==this.options.view?this.select_all_input.attr("checked"):!1})),e=$(".order",c);$(".order",b).each(function(){var a=$(this);e.filter("[data-order-id="+a.attr("data-order-id")+"]").replaceWith(a)});b.remove();this.container.trigger("append_order_list",[a])}},hideListItems:function(a){var b=
$.Deferred();setTimeout(function(){if($.order_list&&$.order_list.container&&$.order_list.container.length){if($.isArray(a))for(var c=$.order_list.container.find(".order"),e=$(),f=0;f<a.length;f++)var d=c.filter("[data-order-id="+a[f]+"]"),e=e.add(d);else var e=$.order_list.container.find(".order[data-order-id="+a+"]");var h=e.length,g=0;e.slideUp(450,function(){g++;g>=h&&b.resolve()})}},1E3);return b.promise()},dispatch:function(a,b){"string"===typeof a&&(a=$.shop.helper.parseParams(a));var c={list:function(){$.order_list.finit();
$.orders.load("?module=orders&"+$.orders.buildOrdersUrlComponent(a),function(){$.order_list.dispatch(a)})},order:function(){$.order_list.loadOrder(a.id)}};null===this.params?(this.params=a,b&&c.list()):a.id&&(b||a.id!=this.params.id)?(c.order(),this.params=a):(b||this.diff(a,this.params)||this.diff(this.params,a))&&c.list()},diff:function(a,b){for(var c in a)if(a.hasOwnProperty(c)&&"id"!=c&&a[c]!==b[c])return!0;return!1},buildLoadListUrl:function(a,b,c){return"?module=orders&action=loadList&id="+
a+(this.filter_params_str?"&"+this.filter_params_str:"")+(b?"&lt=1":"")+(c?"&counters=1":"")+(this.options.view?"&view="+this.options.view:"")},updateProcess:function(a,b){a=a||"run";b=b||{};timeout=b.timeout||6E4;var c=this,e=function(){null!==c.timer_id&&(clearTimeout(c.timer_id),c.timer_id=null);null!==c.xhrs.update_load&&(c.xhrs.update_load.abort(),c.xhrs.update_load=null)};e();if("run"==a){var f=function(a,b){var d=c.container.find(".order:first"),d=parseInt(d.attr("data-order-id"),10)||0;return $.getJSON(c.buildLoadListUrl(d,
!0,!0),function(d){if("ok"==d.status){$.isEmptyObject(d.data.counters)||c.updateCounters(d.data.counters);if(d.data.count)try{c.container.prepend(tmpl("template-order-list-"+c.options.view,{orders:d.data.orders,check_all:"table"==c.options.view?c.select_all_input.attr("checked"):!1})),$(".lazyloading-progress-string").text(d.data.progress.loaded+" "+d.data.progress.of),c.container.trigger("append_order_list",[d.data.orders])}catch(e){console&&(console.log("Error: "+e.message),b());return}"function"===
typeof a&&a(d)}else console&&console.log("Error when loading new orders: "+d.errors),"function"===typeof b&&b()}).error(function(a){console&&(a&&a.errors?console.log("Error when loading new orders: "+a.errors):console.log(["Error when loading new orders",a]));"function"===typeof b&&b()})},d=function(){c.timer_id=setTimeout(function(){null===c.xhrs.lazy_load?c.xhrs.update_load=f(d,e):c.xhrs.lazy_load.then(function(){c.xhrs.update_load=f(d,e)})},timeout)};d()}},finit:function(a){a=this.xhrs;var b=this.lazy_load_win,
c;for(c in a)a.hasOwnProperty(c)&&null!==a[c]&&a[c].abort();this.updateProcess("kill");b&&b.lazyLoad("stop");this.params=null}};$.order_edit={id:0,container:null,form:null,customer_fields:null,customer_inputs:null,stocks:[],slide_on:!1,options:{},init:function(a){this.options=a;a.id&&(this.id=a.id);this.container="string"===typeof a.container?$(a.container):a.container;this.form="string"===typeof a.form?$(a.form):a.form;this.customer_fields=$("#s-order-edit-customer");this.customer_inputs=this.customer_fields.find(":input");a.stocks.sort(function(a,c){return a.sort-c.sort});this.stocks=a.stocks;a.title&&(document.title=title);
a.float_delimeter||(a.float_delimeter=".");this.float_delimeter=a.float_delimeter;this.initView()},initView:function(){var a=this.options;this.initCustomerForm(this.id?"edit":"add");var b=function(a){var b=a.find(".s-orders-stock").find("option:selected"),c=a.find(".s-orders-skus").find("input[type=radio]:checked").parents("li:first");a.find(".s-orders-stock-icon-aggregate").show();a.find(".s-orders-stock-icon").html("").hide();a=c.length?c:a;b.attr("data-icon")&&(a.find(".s-orders-stock-icon-aggregate").hide(),
a.find(".s-orders-stock-icon").html(b.attr("data-icon")).show())};$.order_edit.slide(!0,"add"==a.mode);this.container.find(".back").click(function(){$.order_edit.id?$.order_edit.slide(!1):$.order_edit.slide(!1,!0);$.orders.back();return!1});this.updateTotal(!1);$(".s-order-item").each(function(){var a=$(this);b(a)});$("#order-currency").change(function(){$("#order-items .currency").html($(this).val());$.order_edit.options.currency=$(this).val()});var c=a.price_edit||!1,e=$("#orders-add-autocomplete");
e.autocomplete({source:"?action=autocomplete&with_counts=1&with_sku_name=1",minLength:3,delay:300,select:function(a,f){$(".s-order-errors").empty();$.getJSON("?module=orders&action=getProduct&product_id="+f.item.id+($.order_edit.id?"&order_id="+$.order_edit.id:"&currency="+$.order_edit.options.currency),function(a){var d=$("#order-items"),d=parseInt(d.find(".s-order-item:last").attr("data-index"),10)+1||1,e=a.data.product;e.sku_id&&e.skus[e.sku_id]&&(e.skus[e.sku_id].checked=!0);$("#order-currency").length&&
!$("#order-currency").attr("disabled")&&($('<input type="hidden" name="currency">').val($("#order-currency").val()).insertAfter($("#order-currency")),$("#order-currency").attr("disabled","disabled"));e=$("#s-orders-add-row");e.before(tmpl("template-order",{data:a.data,options:{index:d,currency:$.order_edit.options.currency,stocks:$.order_edit.stocks,price_edit:c}}));a=e.prev();$("#s-order-comment-edit").show();$.order_edit.updateTotal();b(a)});e.val("");return!1}});this.container.off("change",".s-orders-skus input[type=radio]").on("change",
".s-orders-skus input[type=radio]",function(){var a=$(this),e=a.parents("tr:first"),g=this.value,f=e.attr("data-product-id"),q=e.attr("data-index"),m=null;"edit"==($.order_edit.id?"edit":"add")&&(m=parseInt(a.attr("name").replace("sku[edit][",""),10));$.getJSON("?module=orders&action=getProduct&product_id="+f+"&sku_id="+g+($.order_edit.id?"&order_id="+$.order_edit.id:"&currency="+$.order_edit.options.currency),function(a){e.find(".s-orders-services").replaceWith(tmpl("template-order-services",{services:a.data.sku.services,
service_ids:a.data.service_ids,product_id:f,options:{price_edit:c,index:q,currency:$.order_edit.options.currency,stocks:$.order_edit.stocks}}));e.find(".s-orders-product-price").find("input").val(a.data.sku.price);var d;d=-1!==e.find("input:first").attr("name").indexOf("add")?"add":"edit";e.find(".s-orders-product-stocks").replaceWith(tmpl("template-order-stocks-"+d,{sku:a.data.sku,index:q,stocks:$.order_edit.stocks,item_id:m}));b(e);$.order_edit.updateTotal(e)})});this.container.off("change",".s-orders-stock").on("change",
".s-orders-stock",function(){var a=$(this).parents("tr.s-order-item:first");b(a)});var f=function(a,b,c){var e=a.attr("data-price");a=a.attr("data-percent-price");c&&b.val(e);b.attr("data-price",e);b.attr("data-percent-price",a)};this.container.off("change",".s-orders-service-variant").on("change",".s-orders-service-variant",function(){var a=$(this),b=a.find("option:selected"),a=a.parents("li:first");f(b,a.find(".s-orders-service-price"),!0)});this.container.find(".s-orders-service-variant").each(function(){var a=
$(this),b=a.find("option:selected"),a=a.parents("li:first");f(b,a.find(".s-orders-service-price"),!1)});this.container.off("click",".s-order-item-delete").on("click",".s-order-item-delete",function(){var a=$(this);a.parents("tr:first").remove();a.parents("table:first").find("tr.s-order-item:first").length||$("#s-order-comment-edit").hide();$.order_edit.updateTotal();return!1});this.container.off("change",".s-orders-services input").on("change",".s-orders-services input",$.order_edit.updateTotal);
this.container.off("change",".s-orders-product-price input").on("change",".s-orders-product-price input",function(){var a=$.order_edit.parseFloat($(this).val());$.order_edit.container.find(".s-orders-service-price").each(function(){var b=$(this);if("%"===b.data("currency")&&b.attr("data-price")===b.val()){var c=a*(b.data("percentPrice")/100);b.val($.order_edit.formatFloat(c));b.attr("data-price",c)}});$.order_edit.updateTotal.apply(this)});this.container.off("change",".s-orders-services .s-orders-service-variant").on("change",
".s-orders-services .s-orders-service-variant",$.order_edit.updateTotal);$(".s-order-customer-details").on("change","input[type=text],select",function(){$(this).attr("name").indexOf("address")&&$.order_edit.updateTotal()});$("#shipping_methods").change(function(a){var b=$(this).children(":selected"),c=b.data("rate")||0;$("#shipping-rate").val($.order_edit.formatFloat(c));c=[];b.data("error")&&c.push('<span class="error">'+b.data("error")+"</span>");b.data("est_delivery")&&c.push('<span class="hint est_delivery">'+
b.data("est_delivery")+"</span>");b.data("comment")&&c.push('<span class="hint">'+b.data("comment")+"</span>");c?(b.data("error")?$("#shipping-rate").addClass("error"):$("#shipping-rate").removeClass("error"),$("#shipping-info").html(c.join("<br>")).show()):($("#shipping-rate").removeClass("error"),$("#shipping-info").empty().hide());$.order_edit.updateTotal(!1);b.data("external")&&!a.triggered_by_updateTotal&&$.order_edit.updateTotal()});$("#payment_methods").change(function(){var a=$(this).val();
$("#payment-info > div").hide();$("#payment-custom-"+a).length&&$("#payment-custom-"+a).show()});$("#discount,#shipping-rate").change(function(){$.order_edit.updateTotal(!1)});this.container.off("keydown",".s-orders-quantity").on("keydown",".s-orders-quantity",function(){var a=$(this),b=a.data("timer_id");b&&clearTimeout(b);a.data("timer_id",setTimeout(function(){$.order_edit.updateTotal()},450))});this.form&&this.form.length&&this.form.unbind("sumbit").bind("submit",function(){$.order_edit.showValidateErrors();
$(".s-orders-services input[name^=service]:not(:checked)",this.form).each(function(){$(this).closest("li").find(":input").attr("disabled",!0)});$.order_edit.container.find(".error").length||($(".s-order-items-edit td.save i.loading").css("display","inline-block"),$.order_edit.id?$.order_edit.editSubmit():$.order_edit.addSubmit());return!1});this.initDiscountControl()},initDiscountControl:function(){function a(){0<b.val()?f.stop().show():f.stop().hide()}var b=$("#discount"),c=$("#discount-description"),
e=$("#update-discount"),f=$("#discount-tooltip-icon");$(document).tooltip;f.tooltip({bodyHandler:function(){return c.val()||c.data("updated-manually-msg")}});e.tooltip({bodyHandler:function(){return e.data("description")||c.data("updated-manually-msg")}});f.hide();$("#order-edit-form").on("order_total_updated",function(a,c){c.discount&&(e.data("value",c.discount).data("description",c.discount_description),e.data("just-recalculated")?c.discount+""!=b.val()&&e.click():e.show())});e.click(function(){c.val(e.data("description")||
"");b.val(e.data("value")||0).change();e.hide().data("just-recalculated",!0);a();f.is(":visible")&&f.fadeOut(50,function(){f.fadeIn(50,function(){f.fadeOut(50,function(){f.fadeIn(50,function(){f.fadeOut(50,function(){f.fadeIn(50,function(){f.fadeOut(50,function(){f.fadeIn(50,function(){})})})})})})})});return!1});b.on("keyup",function(){c.val("");e.show().data("just-recalculated",!1);a()})},updateTotal:function(a){a=void 0===a?!0:a;var b=$.order_edit.container;if(b.find(".s-order-item").length){for(var c=
0,e=$("#discount"),f={},d=$("#s-order-edit-customer").find('[name^="customer["]').serializeArray(),h=0;h<d.length;h++)f[d[h].name]=d[h].value;f.items=[];b.find(".s-order-item").each(function(){var a=$(this),b=a.find('input[name^="product"]').val(),d=[],e=$.order_edit.parseFloat(a.find(".s-orders-product-price input").val()),h=$.order_edit.parseFloat(a.find("input.s-orders-quantity").val());c+=e*h;a.find(".s-orders-services").length&&a.find(".s-orders-services input:checkbox:checked").each(function(){var a=
$(this).closest("li"),a=$.order_edit.parseFloat(a.find("input.s-orders-service-price").val());d.push({id:$(this).val(),price:a});c+=a*h});a=a.find("input[name^=sku]:not(:radio)").add(a.find("input[name^=sku]:checked")).first().val()||0;f.items.push({product_id:b,quantity:h,price:e,sku_id:a,services:d})});f.subtotal=c;b=$.order_edit.parseFloat(e.val()||0);f.discount=b;$.order_edit.id?f.order_id=$.order_edit.id:f.currency=$("#order-edit-form input[name=currency]").val();f.shipping_id=($("#shipping_methods").val()||
"").split(".")[0];f["customer[id]"]=$("#s-customer-id").val();a&&$.post("?module=order&action=total",f,function(a){if("ok"==a.status){var b=$("#shipping_methods"),c=b.val();b.empty();for(var d=a.data.shipping_method_ids,e=a.data.shipping_methods,h=-1!==d.indexOf(c),r=0;r<d.length;r+=1){var t=d[r],n=e[t],p=$("<option></option>");p.html(n.name).attr("value",t).data("rate",n.rate);p.data("error",n.error||void 0);p.data("est_delivery",n.est_delivery||void 0);p.data("comment",n.comment||void 0);p.data("external",
n.external||!1);b.append(p);h||(n=(""+t).split("."),p=c.split("."),void 0!==n[0]&&void 0!==p[0]&&n[0]==p[0]&&(h=!0,c=t))}h&&(b.val(c),c+="",e[c].external&&f.shipping_id!=c.split(".")[0]||b.trigger($.Event("change",{triggered_by_updateTotal:1})));$("#order-edit-form").trigger("order_total_updated",a.data)}},"json");$("#subtotal").text($.order_edit.formatFloat(Math.round(100*c)/100));a=$.order_edit.parseFloat($("#shipping-rate").val().replace(",","."))||0;a=c+a;0>b?(b=0,e.val("")):(0>a-b&&(b=a),e.val($.order_edit.formatFloat(Math.round(100*
b)/100)));e=a-b;$("#total").text($.order_edit.formatFloat(Math.round(100*e)/100))}else $("#subtotal").text(0),$("#total").text(0)},editSubmit:function(){var a=this.form;$.shop.jsonPost(a.attr("action"),a.serialize(),function(a){$.order_edit.container.find(".back").click()},function(a){$.shop.trace("editSubmit",a);$(".s-order-items-edit td.save i.loading").hide();if(a&&a.errors&&!$.isEmptyObject(a.errors))return $.order_edit.showValidateErrors(a.errors),$(".s-orders-services input:disabled",this.form).attr("disabled",
!1),!1})},addSubmit:function(){var a=this.form;$.shop.trace("addSubmit",$(a));$.shop.jsonPost(a.attr("action"),a.serialize(),function(a){$.order_edit.slide(!1,!0)&&(location.href="#/orders/state_id=new&view=split&id="+a.data.order.id+"/")},function(a){$.shop.trace("addSubmit",a);$(".s-order-items-edit td.save i.loading").hide();if(a&&a.errors&&!$.isEmptyObject(a.errors))return $.order_edit.showValidateErrors(a.errors),$(".s-orders-services input:disabled",this.form).attr("disabled",!1),!1})},formatFloat:function(a){return","===
this.float_delimeter?(""+a).replace(".",","):""+a},parseFloat:function(a){return a?parseFloat((""+a).replace(",",".")):0},slideBack:function(){this.slide(!1,"add"==this.options.mode)},slide:function(a,b,c){if(0==arguments.length)this.slide(!0,"add"==this.options.mode);else{a="undefined"===typeof a?!0:a;b="undefined"===typeof b?!1:b;var e=this.options.duration||200,f=this.options.view,d=[];return!this.slide_on&&a?(d.push($("#s-sidebar").animate({width:0},e,function(){$(this).hide()})),$(".s-level2").hide(),
d.push($("#maincontent").animate({"margin-top":45},e)),d.push($("#s-content").animate({"margin-left":0},e)),d.push($("#s-orders").animate({width:0},e,function(){$(this).hide()})),d.push($("#s-order").animate({"margin-left":0},e).find(">div:first").removeClass("double-padded, bordered-left").find("h1 .back.order-list").hide().end().find("h1 .back.read-mode").show()),this.slide_on=!0,$(".s-order-readable").hide(),$(".s-order-editable").show(),$.when(d).done(function(){$.order_list.lazy_load_win&&$.order_list.lazy_load_win.lazyLoad("sleep");
"function"===typeof c&&c.call(this)}),!0):this.slide_on&&!a?(d.push($("#s-order").animate({"margin-left":"table"==f||b?200:300},e).find(">div:first").addClass("double-padded, bordered-left").find("h1 .back.order-list").show().end().find("h1 .back.read-mode").hide()),d.push($("#s-orders").animate({width:300},e).show()),d.push($("#s-content").animate({"margin-left":200},e)),d.push($("#maincontent").animate({"margin-top":84},e)),$(".s-level2").show(),d.push($("#s-sidebar").animate({width:200},e).show()),
this.slide_on=!1,$(".s-order-editable").hide(),$(".s-order-readable").show(),$.when(d).done(function(){$.order_list.lazy_load_win&&$.order_list.lazy_load_win.lazyLoad("wake");"function"===typeof c&&c.call(this)}),!0):!1}},showValidateErrors:function(a){$(".error").removeClass("error");$("#s-order-edit-customer .errormsg").empty();if(a&&a.customer){var b=a.customer;$.order_edit.customer_fields.find(".field-group:first").html(b.html);delete b.html;for(var c in b)$.order_edit.customer_fields.find(".s-error-customer-"+
c).each(function(){var a=$(this);"EM"==this.tagName?a.text(b[c]):a.addClass("error")})}var e=[];$(".s-order-errors").empty();if(a&&a.order){if(!$.isEmptyObject(a.order.items))for(var f in a.order.items){var d=$(".s-order-item[data-index="+f+"]"),b=a.order.items[f];for(c in b)d.find(".s-error-item-"+c).text(b[c]);delete a.order.items[f]}if(!$.isEmptyObject(a.order.product)){var h=a.order.product,g;for(g in h)h.hasOwnProperty(g)&&"quantity"in h[g]&&$(".s-order-item[data-product-id="+g+"]").each(function(){$(this).find("ul.s-orders-skus input:radio:checked").val()!=
""+h[g].sku_id&&$(this).find("ul.s-orders-skus").length||($(this).find(".s-orders-quantity").addClass("error"),e.push(h[g].quantity))})}a.order.common&&e.push(a.order.common);e.length&&$(".s-order-errors").html(e.join("<br>"))}},bindValidateErrorPlaceholders:function(){for(var a=["firstname","middlename","lastname"],b=0,c=a.length;b<c;b+=1)$.order_edit.customer_inputs.filter("[name="+$.order_edit.inputName(a[b])+"]").addClass("s-error-customer-name");$.order_edit.customer_fields.find(".s-error-customer-name:last").after('<em class="errormsg s-error-customer-name"></em>')},
initCustomerForm:function(a){a="undefined"===typeof a?"add":a;$.order_edit.bindValidateErrorPlaceholders();if("add"===a){var b=$("#customer-autocomplete"),c=function(a){a="undefined"===typeof a?!0:a;$("#s-customer-id").attr("disabled",a);a?$("#s-order-edit-customer").addClass("s-opaque"):$("#s-order-edit-customer").removeClass("s-opaque")},e=function(a){"undefined"===typeof a||a?(c(!1),b.val("").hide(200)):(c(),d(),b.val("").show())},f=function(a){return parseInt(a,10)||"+"==a.substr(0,1)||-1!==a.indexOf("(")},
d=function(){var a={};$.order_edit.customer_inputs.each(function(){var b=$(this);a[b.attr("name")]=b.val()});return function(){$.order_edit.customer_inputs.each(function(){var b=$(this);b.val(a[b.attr("name")]||"")})}};e(!1);$.order_edit.customer_fields.off("focus",":input").on("focus",":input",function(){c(!1)});$("#s-order-new-customer").click(function(){d();e();$.order_edit.customer_inputs.first().focus();$("#s-customer-id").val(0);return!1});var h="";b.autocomplete({source:function(a,b){h=a.term;
$.getJSON($.order_edit.options.autocomplete_url,a,function(a){(a=a||[]).push({label:$_("New customer"),name:$_("New customer"),value:0});b(a)})},delay:300,minLength:3,select:function(a,b){var c=b.item,d=function(){var a=!1;$.order_edit.customer_inputs.filter("input[type=text], textarea").each(function(){var b=$(this);if(b.is(":not(:hidden)")&&!this.value)return a=!0,b.focus(),!1});a||$.order_edit.customer_inputs.first().focus()};if(c.value)$.get("?action=contactForm&id="+c.value,function(a){$.order_edit.customer_fields.find(".field-group:first").html(a);
$.order_edit.customer_inputs=$.order_edit.customer_fields.find(":input");$("#s-customer-id").val(c.value);e();setTimeout(function(){d()},200)});else{var l="[name="+$.order_edit.inputName(f(h)?"phone":-1!==h.indexOf("@")?"email":"firstname")+"]";$.order_edit.customer_inputs.filter(l).val(h);$("#s-customer-id").val(0);e();setTimeout(function(){d()},200)}return!1},focus:function(a,b){this.value=b.item.name;return!1}});$("#order-add-form").submit(function(){c(!1)})}},inputName:function(a){return'"customer['+
a+']"'},getPercentSymbol:function(){return"%"}};
//# sourceMappingURL=order.min.js.map