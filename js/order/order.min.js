(function(a){function b(b){return a.data(b,"tooltip")}function d(c){b(this).delay?l=setTimeout(e,b(this).delay):e();q=!!b(this).track;a(document.body).bind("mousemove",f);f(c)}function c(){if(!a.tooltip.blocked&&!(this==i||!this.tooltipText&&!b(this).bodyHandler)){i=this;k=this.tooltipText;if(b(this).bodyHandler){g.title.hide();var c=b(this).bodyHandler.call(this);c.nodeType||c.jquery?g.body.empty().append(c):g.body.html(c);g.body.show()}else if(b(this).showBody){c=k.split(b(this).showBody);g.title.html(c.shift()).show();
g.body.empty();for(var f=0,e;e=c[f];f++)0<f&&g.body.append("<br/>"),g.body.append(e);g.body.hideWhenEmpty()}else g.title.html(k).show(),g.body.hide();b(this).showURL&&a(this).url()?g.url.html(a(this).url().replace("http://","")).show():g.url.hide();g.parent.addClass(b(this).extraClass);b(this).fixPNG&&g.parent.fixPNG();d.apply(this,arguments)}}function e(){l=null;(!j||!a.fn.bgiframe)&&b(i).fade?g.parent.is(":animated")?g.parent.stop().show().fadeTo(b(i).fade,i.tOpacity):g.parent.is(":visible")?g.parent.fadeTo(b(i).fade,
i.tOpacity):g.parent.fadeIn(b(i).fade):g.parent.show();f()}function f(c){if(!a.tooltip.blocked&&!(c&&"OPTION"==c.target.tagName))if(!q&&g.parent.is(":visible")&&a(document.body).unbind("mousemove",f),null==i)a(document.body).unbind("mousemove",f);else{g.parent.removeClass("viewport-right").removeClass("viewport-bottom");var d=g.parent[0].offsetLeft,e=g.parent[0].offsetTop;c&&(d=c.pageX+b(i).left,e=c.pageY+b(i).top,c="auto",b(i).positionLeft&&(c=a(window).width()-d,d="auto"),g.parent.css({left:d,right:c,
top:e}));var c=a(window).scrollLeft(),h=a(window).scrollTop(),k=a(window).width(),l=a(window).height(),j=g.parent[0];c+k<j.offsetLeft+j.offsetWidth&&(d-=j.offsetWidth+20+b(i).left,g.parent.css({left:d+"px"}).addClass("viewport-right"));h+l<j.offsetTop+j.offsetHeight&&(e-=j.offsetHeight+20+b(i).top,g.parent.css({top:e+"px"}).addClass("viewport-bottom"))}}function h(){function c(){g.parent.removeClass(d.extraClass).hide().css("opacity","")}if(!a.tooltip.blocked){l&&clearTimeout(l);i=null;var d=b(this);
(!j||!a.fn.bgiframe)&&d.fade?g.parent.is(":animated")?g.parent.stop().fadeTo(d.fade,0,c):g.parent.stop().fadeOut(d.fade,c):c();b(this).fixPNG&&g.parent.unfixPNG()}}var g={},i,k,l,j=a.browser.msie&&/MSIE\s(5\.5|6\.)/.test(navigator.userAgent),q=!1;a.tooltip={blocked:!1,defaults:{delay:200,fade:!1,showURL:!0,extraClass:"",noHideOnClick:!1,top:15,left:15,id:"tooltip"},block:function(){a.tooltip.blocked=!a.tooltip.blocked}};a.fn.extend({tooltip:function(b){b=a.extend({},a.tooltip.defaults,b);g.parent||
(g.parent=a('<div id="'+b.id+'"><h3></h3><div class="body"></div><div class="url"></div></div>').appendTo(document.body).hide(),a.fn.bgiframe&&g.parent.bgiframe(),g.title=a("h3",g.parent),g.body=a("div.body",g.parent),g.url=a("div.url",g.parent));var d=this.each(function(){a.data(this,"tooltip",b);this.tOpacity=g.parent.css("opacity");this.tooltipText=this.title;a(this).removeAttr("title");this.alt=""}).mouseover(c).mouseout(h);b.noHideOnClick||d.click(h);return d},fixPNG:j?function(){return this.each(function(){var b=
a(this).css("backgroundImage");b.match(/^url\(["']?(.*\.png)["']?\)$/i)&&(b=RegExp.$1,a(this).css({backgroundImage:"none",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+b+"')"}).each(function(){var b=a(this).css("position");"absolute"!=b&&"relative"!=b&&a(this).css("position","relative")}))})}:function(){return this},unfixPNG:j?function(){return this.each(function(){a(this).css({filter:"",backgroundImage:""})})}:function(){return this},hideWhenEmpty:function(){return this.each(function(){a(this)[a(this).html()?
"show":"hide"]()})},url:function(){return this.attr("href")||this.attr("src")}})})(jQuery);(function(a){var b=function(a,c,e){var f=!/[^\w\-\.:]/.test(a)?!e?b.cache[a]=b.cache[a]||b(b.load(a)):b.cache[a]=b(b.load(a)):new Function(b.arg+",tmpl","var _e=tmpl.encode"+b.helper+",_s='"+a.replace(b.regexp,b.func)+"';return _s;");return c?f(c,b):function(a){return f(a,b)}};b.cache={};b.load=function(a){var b=document.getElementById(a),e=/<\\\/(\w+)/g;if(!b&&console)throw{message:"template with id="+a+" not found"};return b?("textarea"==b.tagName.toLowerCase()?b.value:document.getElementById(a).innerHTML).replace(e,
"</$1"):null};b.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;b.func=function(a,b,e,f,h,g){if(b)return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[a]||"\\"+a;if(e)return"="===e?"'+_e("+f+")+'":"'+("+f+"||'')+'";if(h)return"';";if(g)return"_s+='"};b.encReg=/[<>&"'\x00]/g;b.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};b.encode=function(a){return String(a||"").replace(b.encReg,function(a){return b.encMap[a]||""})};b.arg="o";b.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}";
"function"===typeof define&&define.amd?define(function(){return b}):a.tmpl=b})(this);(function(a){a.fn.lazyLoad=function(b){function d(){if(c.stopped)this.onscroll=null;else if(!c.stopped&&!c.loading&&g(f,e)<=c.distance){if(null!==c.hash){var a=location.hash.replace(/^[^#]*#\/*/,"").split("/")[0];if(-1===c.hash.indexOf(a)){this.onscroll=null;return}}c.load()}}if("stop"==b){var c=this.data("lazyLoadSettings");c&&(c.stopped=!0)}else if("reload"==b){if(c=this.data("lazyLoadSettings"))c.stopped=!1,c.loading=!1,this.get(0).onscroll=null,this.lazyLoad(c)}else if("sleep"==b){if(c=this.data("lazyLoadSettings"))c.loading=
!0}else if("wake"==b){if(c=this.data("lazyLoadSettings"))c.loading=!1}else if("force"==b)(c=this.data("lazyLoadSettings"))&&(c.loading||c.load());else{this.data("lazyLoadSettings",a.extend({distance:50,load:function(){},container:f,state:"wake",hash:location.hash.replace(/^[^#]*#\/*/,"").split("/")[0]||null,distanceBetweenBottoms:null},b||{}));c=this.data("lazyLoadSettings");c.loading=!1;c.stopped=!1;var e=this,f=c.container;null!==c.hash&&!a.isArray(c.hash)&&(c.hash=[c.hash]);a.fn.lazyLoad.call(e,
c.state);var h=setTimeout(function(){if(c.stopped)clearTimeout(h);else{if(c.hash!==null){var a=location.hash.replace(/^[^#]*#\/*/,"").split("/")[0];if(c.hash.indexOf(a)===-1){clearTimeout(h);return}}if(c.loading)h=setTimeout(arguments.callee,350);else{g(f,e);if(g(f,e)<=c.distance){c.load();h=setTimeout(arguments.callee,350)}else{e.get(0).onscroll=d;clearTimeout(h)}}}},350),g="function"===typeof c.distanceBetweenBottoms?c.distanceBetweenBottoms:function(b,c,d){b=typeof b==="string"?a(b):b;return b.position().top+
b.outerHeight()-(d||0)-(c.scrollTop()+c.height())}}}})(jQuery);(function(a){a.storage=new a.store;a.orders={options:{view:"table"},init:function(b){var d=this;d.options=b;"undefined"!=typeof a.History&&a.History.bind(function(){d.dispatch()});a.wa.errorHandler=function(b){return 403===b.status||404===b.status?(b=a(b.responseText),b=b.find(".dialog-content").length?a('<div class="block double-padded"></div>').append(b.find(".dialog-content *")):a('<div class="block double-padded"></div>').append(b.find(":not(style)")),a("#s-content").empty().append(b),a.orders.onPageNotFound(),
!1):!0};b=window.location.hash;"#/"===b||!b?this.dispatch():a.wa.setHash(b);this.initSearch();a(document).bind("wa.appcount",function(b,d){var f=parseInt(d.shop,10);a("#s-pending-orders .small").text(f?"+"+f:"");var h=document.title.match(/\(\d+\) /);h?document.title=document.title.replace(h[0],f?"("+f+") ":""):f&&(document.title="("+f+") "+document.title)})},onPageNotFound:function(){a.order_list&&a.order_list.finit()},initSearch:function(){var b=a("#s-orders-search"),d=[],c=function(c){switch(c.autocomplete_item_type){case "order":a.wa.setHash("#/order/"+
c.id+"/");b.val(c.value);break;case "contact":a.wa.setHash("#/orders/contact_id="+c.id+"/");b.val(c.value);break;case "product":a.wa.setHash("#/orders/product_id="+c.id+"/");b.val(c.value);break;case "coupon":a.wa.setHash("#/orders/coupon_id="+c.id+"/");break;case "shipping":a.wa.setHash("#/orders/shipping_id="+c.id+"/");break;case "payment":a.wa.setHash("#/orders/payment_id="+c.id+"/");break;case "city":a.wa.setHash("#/orders/city="+c.value+"/");break;case "region":a.wa.setHash("#/orders/region="+
((c.value||"").split(":")[1]||"")+"/");break;case "country":a.wa.setHash("#/orders/country="+c.value+"/")}};b.unbind("keydown").bind("keydown",function(b){if(13==b.keyCode||10==b.keyCode){var f=a(this);if(a(this).val()){if(d&&a.isArray(d)&&d.length)return c(d[0]),setTimeout(function(){f.autocomplete("close")},150),!1}else return location.hash="#/orders/all/",f.autocomplete("close"),!1}});b.autocomplete({minLength:1,delay:300,html:!0,select:function(a,b){c(b.item);return!1},source:function(b,c){a.getJSON("?action=autocomplete&type=order",
b,function(a){d=a;c(a)})}})},prevHash:null,hash:null,skipDispatch:0,stopDispatch:function(a){this.skipDispatch=a},dispatch:function(b){if(0<this.skipDispatch)return this.skipDispatch--,!1;if(void 0===b||null===b)b=window.location.hash;b=b.replace(/(^[^#]*#\/*|\/$)/g,"");null!==this.hash&&(this.prevHash=this.hash);if(this.hash=b)if(b=b.split("/"),b[0]){for(var d="",c=b.length,e=null,f=null,c=0;c<b.length;c++){var h=b[c];if(2>c){if(0===c)d=h;else if(parseInt(h,10)!=h&&-1==h.indexOf("="))d+=h.substr(0,
1).toUpperCase()+h.substr(1);else break;"function"==typeof this[d+"Action"]&&(e=d,f=c+1)}else break}"function"!==typeof this[d+"Action"]&&e&&(d=e,c=f);b=b.slice(c);this.preExecute(d);"function"==typeof this[d+"Action"]?(a.shop.trace("$.orders.dispatch",[d+"Action",b]),this[d+"Action"].apply(this,b)):a.shop.error("Invalid action name:",d+"Action");this.postExecute(d)}else this.preExecute(),this.defaultAction(),this.postExecute();else this.preExecute(),this.defaultAction(),this.postExecute()},back:function(){var b=
a.orders.prevHash||"";location.hash=b?b+"/":""},preExecute:function(){},postExecute:function(a){this.actionName=a},defaultAction:function(){this.ordersAction()},couponsAction:function(){a.order_list&&a.order_list.finit();this.load("?module=coupons")},ordersEditAction:function(b){this.load("?module=order&action=edit&id="+b,function(){a.order_list&&a.order_list.finit()})},ordersNewAction:function(){this.load("?module=order&action=edit",function(){a.order_list&&a.order_list.finit()})},ordersAction:function(b){if("hash"===
b)b={hash:Array.prototype.slice.call(arguments,1).join("/")};else{var d="";"search"===b&&(d=Array.prototype.slice.call(arguments,1));1<arguments.length&&(b=Array.prototype.join.call(arguments,"/"));b?"all"===b&&(b=""):b="state_id=new|processing|paid";b=a.shop.helper.parseParams(b||"");b.view||(b.view=a.storage.get("shop/orders/view")||this.options.view);a.storage.set("shop/orders/view",b.view);a.order_edit&&a.order_edit.slideBack();d&&(b.search=d)}"orders"!==this.actionName||!a.order_list?(a.order_list&&
a.order_list.finit(),this.load("?module=orders&"+this.buildOrdersUrlComponent(b),function(){a.order_list&&a.order_list.dispatch(b)})):a.order_list.dispatch(b)},orderAction:function(b,d){d=a.shop.helper.parseParams(d||"");d.view||(d.view=a.storage.get("shop/orders/view")||this.options.view);a.storage.set("shop/orders/view",d.view);a.order_edit&&a.order_edit.slideBack();this.load("?module=order&id="+encodeURIComponent(b)+"&"+this.buildOrdersUrlComponent(d),function(){a("#s-content").find("h1 .back.order-list").show()});
a.order_list&&a.order_list.finit()},buildOrdersUrlComponent:function(a){var d="",c;for(c in a)a.hasOwnProperty(c)&&"view"!==c&&(d+="&"+c+"="+a[c]);return"view="+(a.view||this.options.view)+d},load:function(b,d,c){"function"===typeof d?(c=d,d={}):d=d||{};var e=Math.random();this.random=e;var f=this;return a.get(b,function(b){if(!((typeof d.check==="undefined"||d.check)&&f.random!=e)){(d.content||a("#s-content")).removeClass("bordered-left").html(b);typeof c==="function"&&c.call(this);a("html, body").animate({scrollTop:0},
200);a(".level2").show();a("#s-sidebar").width(200).show()}})}}})(jQuery);$.order_list={id:0,options:{},container:null,sidebar:null,select_all_input:null,filter_params:{},filter_params_str:"",params:null,timer_id:0,lazy_load_win:null,xhrs:{lazy_load:null,update_load:null},init:function(a){this.options=a=a||{};this.filter_params=a.filter_params||{};this.filter_params_str=a.filter_params_str||"";this.container=$("#order-list");"table"==a.view&&(this.select_all_input=this.container.find(".s-select-all"),this.container=$("#order-list").find("tbody:first"));this.sidebar=$("#s-sidebar");
this.id=a.id||0;if(a.orders&&a.orders.length&&a.view){try{this.container.append(tmpl("template-order-list-"+this.options.view,{orders:a.orders},!0)),this.container.trigger("append_order_list",[a.orders])}catch(b){return console&&console.log(b.stack),this}delete a.orders;delete this.options.orders}a.lazy_loading&&this.initLazyLoad(a.lazy_loading);a.counters&&this.updateCounters(a.counters);a.update_process&&a.count&&this.updateProcess("run",a.update_process);this.initView()},initLazyLoad:function(a){var b=
this,d=b.options.count,c=b.options.total_count,e=$(window);e.lazyLoad("stop");d<c&&(e.lazyLoad({container:this.options.view?b.container:e,state:"undefined"===typeof a.auto||a.auto?"wake":"stop",hash:["orders",""],load:function(){e.lazyLoad("sleep");$(".lazyloading-link").hide();$(".lazyloading-progress").show();var a=b.container.find(".order:last"),c=parseInt(a.attr("data-order-id"),10);if(c){var d=function(){return $.getJSON(b.buildLoadListUrl(c),function(a){if("ok"==a.status){try{b.container.append(tmpl("template-order-list-"+
b.options.view,{orders:a.data.orders,check_all:"table"==b.options.view?b.select_all_input.attr("checked"):!1})),b.container.trigger("append_order_list",[a.data.orders]),b.container.find("[data-order-id="+b.options.id+"]").length&&(b.container.find(".selected").removeClass("selected"),b.container.find("[data-order-id="+b.options.id+"]").addClass("selected"))}catch(c){console&&console.log(c.stack);e.lazyLoad("stop");return}$(".lazyloading-progress-string").text(a.data.progress.loaded+" "+a.data.progress.of);
$(".lazyloading-progress").hide();$(".lazyloading-chunk").text(a.data.progress.chunk);a.data.loaded>=a.data.total_count?(e.lazyLoad("stop"),$(".lazyloading-link").hide()):($(".lazyloading-link").show(),e.lazyLoad("wake"))}else console&&console.log("Error when loading orders: "+a.errors),e.lazyLoad("stop")}).error(function(a){console&&(a&&a.errors?console.log("Error when loading orders: "+a.errors):a?console.log(a):console.log("Error when loading orders"));e.lazyLoad("stop")})};null===b.xhrs.update_load?
b.xhrs.lazy_load=d():b.xhrs.update_load.then(function(){b.xhrs.lazy_load=d()})}else console.log("Unkown last item"),e.lazyLoad("stop")}}),$("#s-orders").off("click",".lazyloading-link").on("click",".lazyloading-link",function(){e.lazyLoad("force");return!1}),this.lazy_load_win=e)},initView:function(){this.initSidebar();"table"==this.options.view&&this.initSelecting();this.options.id&&this.loadOrder(this.options.id);var a=$("#s-orders-views");a.find("li.selected").removeClass("selected");a.find("li[data-view="+
this.options.view+"]").addClass("selected");a.find("li a").each(function(){var a=$(this),b=$(this).parents("li:first");a.attr("href","#/orders/view="+b.attr("data-view")+($.order_list.options.filter_params_str?"&"+$.order_list.options.filter_params_str:"")+"/")});var b=function(a,b){var e=function(a,b){$.order_list.updateCounters({state_counters:a.data.state_counters,common_counters:{pending:a.data.pending_count}});$.isEmptyObject(a.data.orders)||$.order_list.updateListItems(a.data.orders);$.order_list.select_all_input.trigger("select",
!1);var c=[],d=$.order_list.filter_params;if(!$.isEmptyObject(a.data.orders))for(var f=0,e=a.data.orders.length;f<e;f++)!$.isEmptyObject(d)&&d.state_id&&("string"===$.type(d.state_id)&&d.state_id!==a.data.orders[f].state_id?c.push(a.data.orders[f].id):"array"===$.type(d.state_id)&&-1!==d.state_id.indexOf(a.data.orders[f].state_id)&&c.push(a.data.orders[f].id));$.isEmptyObject(c)||$.order_list.hideListItems(c).done(function(){if(!$.order_list.container.find(".order:not(:hidden):first").length){var a=
'<div class="block double-padded align-center blank"><br><br><br><br><span class="gray large">'+$_("There are no orders in this view.")+'</span><div class="clear-left"></div></div></div>';$("#s-content").html(a)}});b instanceof Function&&b(a)},f=function(h,g){$.shop.jsonPost("?module=orders&action=performAction&id="+a+"&offset="+(h||0)+"&"+$.order_list.options.filter_params_str,b,function(a){"ok"==a.status?a.data.offset<a.data.total_count?f(a.data.offset,e):e(a,g):e(a,g)})};f(0,function(){$.orders.dispatch()})};
$("#order-list").find(".wf-actions a").click(function(){var a=$(this).attr("data-action-id");if(a){var c=$.order_list.getSelectedOrders();c.order_id?b(a,c):confirm($_("Perform action to all selected orders?"))&&b(a,c)}return!1})},loadOrder:function(a){this.container.find(".selected").removeClass("selected");this.container.find("[data-order-id="+a+"]").addClass("selected");$("#s-order-title").find(".loading").show();$.orders.load("?module=order&id= "+a+"&"+this.filter_params_str,{content:$("#s-order")},
function(){this.id=a})},getSelectedOrders:function(a){var a=a||!1,b={count:0};if(this.select_all_input.attr("checked")){var d=$.order_list.filter_params;if(a)if(b.serialized=[],$.isEmptyObject(d))b.serialized.push({name:"filter_params",value:""});else for(var a=0,c=hash.length;a<c;a+=1)b.serialized.push({name:"filter_params[]",value:d[a]});else b.filter_params=$.isEmptyObject(d)?"":d;b.count=this.options.total_count}else a?b.serialized=$.order_list.container.find(".order.selected").map(function(){b.count+=
1;return{name:"order_id[]",value:$(this).attr("data-order-id")}}).toArray():b.order_id=$.order_list.container.find(".order.selected").map(function(){b.count+=1;return $(this).attr("data-order-id")}).toArray();return b},initSidebar:function(){var a=this.sidebar,b=this.options.view;a.find("li.list a").each(function(){var a=$(this),d=a.attr("href"),f=d.match(/view=((.*)&|(.*)\/|(.*))/);f?a.attr("href",d.replace("view="+(f[2]||f[3]||f[4]),"view="+b)):(f=d.match(/^#\/orders\/hash\/(.*?)\/?$/))?a.attr("href",
"#/orders/view="+b+"&hash="+encodeURIComponent(f[1])+"/"):(f=d.match(/orders\/((.*)\/|(.*))/),d="",f&&(f[1]?(d=f[2]||f[3],d+="&view="+b):d="view="+b,a.attr("href","#/orders/"+d+"/")))});var d=a.find("li.selected").removeClass("selected");this.filter_params.state_id?$.isArray(this.filter_params.state_id)?$("#s-pending-orders").addClass("selected"):a.find('li[data-state-id="'+this.filter_params.state_id+'"]').addClass("selected"):this.filter_params.contact_id?a.find("li[data-contact-id="+this.filter_params.contact_id+
"]").addClass("selected"):this.filter_params.storefront?(d=decodeURIComponent(this.filter_params.storefront),"/"===d.slice(-1)&&(d=d.slice(0,-1)),a.find('li[data-storefront="'+d+'"]').addClass("selected")):$.order_list.filter_params_str?a.find('[href="'+window.location.hash+'"]:first').closest("li").addClass("selected").length||d.addClass("selected"):$("#s-all-orders").addClass("selected");a.find("li.list a").unbind("click.order_list").bind("click.order_list",function(){a.find("li.selected").removeClass("selected");
$(this).closest("li").addClass("selected");if($(this).attr("href").replace(/(^[^#]*#\/*|\/$)/g,"")==$.orders.hash){var b=$.orders.hash.replace("orders/","");$.order_list.dispatch(b,true)}})},initSelecting:function(){var a=this.container,b=this.select_all_input;b.click(function(){$(this).trigger("select",this.checked)});$(document).keydown(function(a){16==a.keyCode&&(document.body.onselectstart=function(){return!1})}).keyup(function(a){16==a.keyCode&&(document.body.onselectstart=null)});var d=function(){if($.order_list.filter_params&&
!$.order_list.filter_params.length){var a=$("#order-list");b.attr("checked")?a.find(".s-with-selected").show():a.find(".order.selected:first").length?a.find(".s-with-selected").show():a.find(".s-with-selected").hide()}};a.off("select",".order").on("select",".order",function(a,e){(void 0!==e?e:1)?$(this).addClass("selected").find("input:first").attr("checked",!0):($(this).removeClass("selected").find("input:first").attr("checked",!1),b.is(":checked")&&b.attr("checked",!1));d();return!1});b.unbind("select").bind("select",
function(b,d){var d=void 0!==d?d:!0,f=$(this);d?(f.attr("checked",!0),a.find(".order").trigger("select",!0,!1)):(f.attr("checked",!1),a.find(".order").trigger("select",!1,!1))});a.off("click",".order input").on("click",".order input",function(c){var e=c.shiftKey,c=this.checked,f=$(this).parents(".order:first");c?f.addClass("selected"):(b.is(":checked")&&b.attr("checked",!1),f.removeClass("selected"));if(e&&c){(e=a.data("last_checked"))||(e=a.find(".order:first").trigger("select",!0));var h=f.prevAll(".selected[data-order-id="+
e.attr("data-order-id")+"]"),g;if(h.length){g=f.prev();for(e=e.get(0);g.length&&e!=g.get(0);)g.addClass("selected").find("input").attr("checked",!0),g=g.prev()}else if(h=f.nextAll(".selected[data-order-id="+e.attr("data-order-id")+"]"),h.length){g=f.next();for(e=e.get(0);g.length&&e!=g.get(0);)g.addClass("selected").find("input").attr("checked",!0),g=g.next()}!a.data("last_checked")&&!h.length&&e.trigger("selected",!1)}c&&a.data("last_checked",f);d()})},updateTitle:function(a,b){var b=parseInt(b,
10)||0,d="";this.options.state_names&&(this.filter_params.state_id?"string"===typeof this.filter_params.state_id?d=this.options.state_names[this.filter_params.state_id]:$.isArray(this.filter_params.state_id)&&(d=$_("Processing")):d=$_("All orders"));document.title=b?"("+b+") "+d+(a||""):d+a},updateCounters:function(a){var b=this.sidebar;b||(b=$("#s-sidebar"));var d=$("#s-pending-orders .small"),c;for(c in a)if(a.hasOwnProperty(c)){var e=a[c],f;for(f in e)if(e.hasOwnProperty(f)){var h;h="common_counters"==
c?$("#s-"+f+"-orders .count"):"storefront_counters"!==c?b.find("li[data-"+c.replace("_counters","")+"-id="+f+"] .count"):b.find("li[data-"+c.replace("_counters","")+'="'+f+'"] .count');var g=parseInt(h.text(),10)||0,i=0;e[f]=""+e[f];"+"==e[f].substr(0,1)?i=g+(parseInt(e[f].substr(1),10)||0):"-"==e[f].substr(0,1)?(i=g-(parseInt(e[f].substr(1),10)||0),i=0>i?0:i):i=parseInt(e[f],10)||0;h.text(i);"new"==f&&(d.text(i?"+"+i:""),$.shop.updateAppCounter(i),this.updateTitle(this.options.title_suffix,parseInt(i,
10)))}}},updateListItems:function(a){var b="template-order-list-"+this.options.view;if(document.getElementById(b)){var d=this.container;$.isArray(a)||(a=[a]);var b=$("<div></div>").append(tmpl(b,{orders:a,check_all:"table"==this.options.view?this.select_all_input.attr("checked"):!1})),c=$(".order",d);$(".order",b).each(function(){var a=$(this);c.filter("[data-order-id="+a.attr("data-order-id")+"]").replaceWith(a)});b.remove();this.container.trigger("append_order_list",[a])}},hideListItems:function(a){var b=
$.Deferred();setTimeout(function(){if($.order_list&&$.order_list.container&&$.order_list.container.length){if($.isArray(a))for(var d=$.order_list.container.find(".order"),c=$(),e=0;e<a.length;e++)var f=d.filter("[data-order-id="+a[e]+"]"),c=c.add(f);else var c=$.order_list.container.find(".order[data-order-id="+a+"]");var h=c.length,g=0;c.slideUp(450,function(){g++;g>=h&&b.resolve()})}},1E3);return b.promise()},dispatch:function(a,b){"string"===typeof a&&(a=$.shop.helper.parseParams(a));var d={list:function(){$.order_list.finit();
$.orders.load("?module=orders&"+$.orders.buildOrdersUrlComponent(a),function(){$.order_list.dispatch(a)})},order:function(){$.order_list.loadOrder(a.id)}};null===this.params?(this.params=a,b&&d.list()):a.id&&(b||a.id!=this.params.id)?(d.order(),this.params=a):(b||this.diff(a,this.params)||this.diff(this.params,a))&&d.list()},diff:function(a,b){for(var d in a)if(a.hasOwnProperty(d)&&"id"!=d&&a[d]!==b[d])return!0;return!1},buildLoadListUrl:function(a,b,d){return"?module=orders&action=loadList&id="+
a+(this.filter_params_str?"&"+this.filter_params_str:"")+(b?"&lt=1":"")+(d?"&counters=1":"")+(this.options.view?"&view="+this.options.view:"")},updateProcess:function(a,b){a=a||"run";b=b||{};timeout=b.timeout||6E4;var d=this,c=function(){null!==d.timer_id&&(clearTimeout(d.timer_id),d.timer_id=null);null!==d.xhrs.update_load&&(d.xhrs.update_load.abort(),d.xhrs.update_load=null)};c();if("run"==a){var e=function(a,b){var c=d.container.find(".order:first"),c=parseInt(c.attr("data-order-id"),10)||0;return $.getJSON(d.buildLoadListUrl(c,
!0,!0),function(c){if("ok"==c.status){$.isEmptyObject(c.data.counters)||d.updateCounters(c.data.counters);if(c.data.count)try{d.container.prepend(tmpl("template-order-list-"+d.options.view,{orders:c.data.orders,check_all:"table"==d.options.view?d.select_all_input.attr("checked"):!1})),$(".lazyloading-progress-string").text(c.data.progress.loaded+" "+c.data.progress.of),d.container.trigger("append_order_list",[c.data.orders])}catch(f){console&&(console.log("Error: "+f.message),b());return}"function"===
typeof a&&a(c)}else console&&console.log("Error when loading new orders: "+c.errors),"function"===typeof b&&b()}).error(function(a){console&&(a&&a.errors?console.log("Error when loading new orders: "+a.errors):console.log(["Error when loading new orders",a]));"function"===typeof b&&b()})},f=function(){d.timer_id=setTimeout(function(){null===d.xhrs.lazy_load?d.xhrs.update_load=e(f,c):d.xhrs.lazy_load.then(function(){d.xhrs.update_load=e(f,c)})},timeout)};f()}},finit:function(){var a=this.xhrs,b=this.lazy_load_win,
d;for(d in a)a.hasOwnProperty(d)&&null!==a[d]&&a[d].abort();this.updateProcess("kill");b&&b.lazyLoad("stop");this.params=null}};$.order_edit={id:0,container:null,form:null,customer_fields:null,customer_inputs:null,stocks:[],slide_on:!1,options:{},init:function(a){this.options=a;a.id&&(this.id=a.id);this.container="string"===typeof a.container?$(a.container):a.container;this.form="string"===typeof a.form?$(a.form):a.form;this.customer_fields=$("#s-order-edit-customer");this.customer_inputs=this.customer_fields.find(":input");a.stocks.sort(function(a,d){return a.sort-d.sort});this.stocks=a.stocks;a.title&&(document.title=title);
a.float_delimeter||(a.float_delimeter=".");this.float_delimeter=a.float_delimeter;this.initView()},initView:function(){var a=this.options;this.initCustomerForm(this.id?"edit":"add");var b=function(a){var b=a.find(".s-orders-stock").find("option:selected"),c=a.find(".s-orders-skus").find("input[type=radio]:checked").parents("li:first");a.find(".s-orders-stock-icon-aggregate").show();a.find(".s-orders-stock-icon").html("").hide();a=c.length?c:a;b.attr("data-icon")&&(a.find(".s-orders-stock-icon-aggregate").hide(),
a.find(".s-orders-stock-icon").html(b.attr("data-icon")).show())};$.order_edit.slide(!0,"add"==a.mode);this.container.find(".back").click(function(){$.order_edit.id?$.order_edit.slide(!1):$.order_edit.slide(!1,!0);$.orders.back();return!1});this.updateTotal(!1);$(".s-order-item").each(function(){var a=$(this);b(a)});$("#order-currency").change(function(){$("#order-items .currency").html($(this).val());$.order_edit.options.currency=$(this).val()});var d=a.price_edit||!1,c=$("#orders-add-autocomplete");
c.autocomplete({source:"?action=autocomplete&with_counts=1&with_sku_name=1",minLength:3,delay:300,select:function(a,e){$(".s-order-errors").empty();$.getJSON("?module=orders&action=getProduct&product_id="+e.item.id+($.order_edit.id?"&order_id="+$.order_edit.id:"&currency="+$.order_edit.options.currency),function(a){var c=$("#order-items"),c=parseInt(c.find(".s-order-item:last").attr("data-index"),10)+1||1,f=a.data.product;f.sku_id&&f.skus[f.sku_id]&&(f.skus[f.sku_id].checked=!0);$("#order-currency").length&&
!$("#order-currency").attr("disabled")&&($('<input type="hidden" name="currency">').val($("#order-currency").val()).insertAfter($("#order-currency")),$("#order-currency").attr("disabled","disabled"));f=$("#s-orders-add-row");f.before(tmpl("template-order",{data:a.data,options:{index:c,currency:$.order_edit.options.currency,stocks:$.order_edit.stocks,price_edit:d}}));a=f.prev();$("#s-order-comment-edit").show();$.order_edit.updateTotal();b(a)});c.val("");return!1}});this.container.off("change",".s-orders-skus input[type=radio]").on("change",
".s-orders-skus input[type=radio]",function(){var a=$(this),c=a.parents("tr:first"),e=this.value,i=c.attr("data-product-id"),k=c.attr("data-index"),l=null;if("edit"==($.order_edit.id?"edit":"add"))l=parseInt(a.attr("name").replace("sku[edit][",""),10);$.getJSON("?module=orders&action=getProduct&product_id="+i+"&sku_id="+e+($.order_edit.id?"&order_id="+$.order_edit.id:"&currency="+$.order_edit.options.currency),function(a){c.find(".s-orders-services").replaceWith(tmpl("template-order-services",{services:a.data.sku.services,
service_ids:a.data.service_ids,product_id:i,options:{price_edit:d,index:k,currency:$.order_edit.options.currency,stocks:$.order_edit.stocks}}));c.find(".s-orders-product-price").find("input").val(a.data.sku.price);var f;f=-1!==c.find("input:first").attr("name").indexOf("add")?"add":"edit";c.find(".s-orders-product-stocks").replaceWith(tmpl("template-order-stocks-"+f,{sku:a.data.sku,index:k,stocks:$.order_edit.stocks,item_id:l}));b(c);$.order_edit.updateTotal(c)})});this.container.off("change",".s-orders-stock").on("change",
".s-orders-stock",function(){var a=$(this).parents("tr.s-order-item:first");b(a)});var e=function(a,b,c){var d=a.attr("data-price"),a=a.attr("data-percent-price");c&&b.val(d);b.attr("data-price",d);b.attr("data-percent-price",a)};this.container.off("change",".s-orders-service-variant").on("change",".s-orders-service-variant",function(){var a=$(this),b=a.find("option:selected"),a=a.parents("li:first");e(b,a.find(".s-orders-service-price"),!0)});this.container.find(".s-orders-service-variant").each(function(){var a=
$(this),b=a.find("option:selected"),a=a.parents("li:first");e(b,a.find(".s-orders-service-price"),!1)});this.container.off("click",".s-order-item-delete").on("click",".s-order-item-delete",function(){var a=$(this);a.parents("tr:first").remove();a.parents("table:first").find("tr.s-order-item:first").length||$("#s-order-comment-edit").hide();$.order_edit.updateTotal();return!1});this.container.off("change",".s-orders-services input").on("change",".s-orders-services input",$.order_edit.updateTotal);
this.container.off("change",".s-orders-product-price input").on("change",".s-orders-product-price input",function(){var a=$.order_edit.parseFloat($(this).val());$.order_edit.container.find(".s-orders-service-price").each(function(){var b=$(this);if("%"===b.data("currency")&&b.attr("data-price")===b.val()){var c=a*(b.data("percentPrice")/100);b.val($.order_edit.formatFloat(c));b.attr("data-price",c)}});$.order_edit.updateTotal.apply(this)});this.container.off("change",".s-orders-services .s-orders-service-variant").on("change",
".s-orders-services .s-orders-service-variant",$.order_edit.updateTotal);$(".s-order-customer-details").on("change","input[type=text],select",function(){$(this).attr("name").indexOf("address")&&$.order_edit.updateTotal()});$("#shipping_methods").change(function(a){var b=$(this).children(":selected"),c=b.data("rate")||0;$("#shipping-rate").val($.order_edit.formatFloat(c));c=[];b.data("error")&&c.push('<span class="error">'+b.data("error")+"</span>");b.data("est_delivery")&&c.push('<span class="hint est_delivery">'+
b.data("est_delivery")+"</span>");b.data("comment")&&c.push('<span class="hint">'+b.data("comment")+"</span>");c?(b.data("error")?$("#shipping-rate").addClass("error"):$("#shipping-rate").removeClass("error"),$("#shipping-info").html(c.join("<br>")).show()):($("#shipping-rate").removeClass("error"),$("#shipping-info").empty().hide());$.order_edit.updateTotal(!1);b.data("external")&&!a.triggered_by_updateTotal&&$.order_edit.updateTotal()});$("#payment_methods").change(function(){var a=$(this).val();
$("#payment-info > div").hide();$("#payment-custom-"+a).length&&$("#payment-custom-"+a).show()});$("#discount,#shipping-rate").change(function(){$.order_edit.updateTotal(!1)});this.container.off("keydown",".s-orders-quantity").on("keydown",".s-orders-quantity",function(){var a=$(this),b=a.data("timer_id");b&&clearTimeout(b);a.data("timer_id",setTimeout(function(){$.order_edit.updateTotal()},450))});this.form&&this.form.length&&this.form.unbind("sumbit").bind("submit",function(){$.order_edit.showValidateErrors();
$(".s-orders-services input[name^=service]:not(:checked)",this.form).each(function(){$(this).closest("li").find(":input").attr("disabled",!0)});$.order_edit.container.find(".error").length||($(".s-order-items-edit td.save i.loading").css("display","inline-block"),$.order_edit.id?$.order_edit.editSubmit():$.order_edit.addSubmit());return!1});this.initDiscountControl()},initDiscountControl:function(){function a(){0<b.val()?e.stop().show():e.stop().hide()}var b=$("#discount"),d=$("#discount-description"),
c=$("#update-discount"),e=$("#discount-tooltip-icon");$(document).tooltip;e.tooltip({bodyHandler:function(){return d.val()||d.data("updated-manually-msg")}});c.tooltip({bodyHandler:function(){return c.data("description")||d.data("updated-manually-msg")}});e.hide();$("#order-edit-form").on("order_total_updated",function(a,d){d.discount&&(c.data("value",d.discount).data("description",d.discount_description),c.data("just-recalculated")?d.discount+""!=b.val()&&c.click():c.show())});c.click(function(){d.val(c.data("description")||
"");b.val(c.data("value")||0).change();c.hide().data("just-recalculated",!0);a();e.is(":visible")&&e.fadeOut(50,function(){e.fadeIn(50,function(){e.fadeOut(50,function(){e.fadeIn(50,function(){e.fadeOut(50,function(){e.fadeIn(50,function(){e.fadeOut(50,function(){e.fadeIn(50,function(){})})})})})})})});return!1});b.on("keyup",function(){d.val("");c.show().data("just-recalculated",!1);a()})},updateTotal:function(a){var a=void 0===a?!0:a,b=$.order_edit.container;if(b.find(".s-order-item").length){for(var d=
0,c=$("#discount"),e={},f=$("#s-order-edit-customer").find('[name^="customer["]').serializeArray(),h=0;h<f.length;h++)e[f[h].name]=f[h].value;e.items=[];b.find(".s-order-item").each(function(){var a=$(this),b=a.find('input[name^="product"]').val(),c=[],f=$.order_edit.parseFloat(a.find(".s-orders-product-price input").val()),h=$.order_edit.parseFloat(a.find("input.s-orders-quantity").val());d+=f*h;a.find(".s-orders-services").length&&a.find(".s-orders-services input:checkbox:checked").each(function(){var a=
$(this).closest("li"),a=$.order_edit.parseFloat(a.find("input.s-orders-service-price").val());c.push({id:$(this).val(),price:a});d+=a*h});a=a.find("input[name^=sku]:not(:radio)").add(a.find("input[name^=sku]:checked")).first().val()||0;e.items.push({product_id:b,quantity:h,price:f,sku_id:a,services:c})});e.subtotal=d;b=$.order_edit.parseFloat(c.val()||0);e.discount=b;$.order_edit.id?e.order_id=$.order_edit.id:e.currency=$("#order-edit-form input[name=currency]").val();e.shipping_id=($("#shipping_methods").val()||
"").split(".")[0];e["customer[id]"]=$("#s-customer-id").val();a&&$.post("?module=order&action=total",e,function(a){if("ok"==a.status){var b=$("#shipping_methods"),c=b.val();b.empty();for(var d=a.data.shipping_method_ids,f=a.data.shipping_methods,h=-1!==d.indexOf(c),o=0;o<d.length;o+=1){var p=d[o],m=f[p],n=$("<option></option>");n.html(m.name).attr("value",p).data("rate",m.rate);n.data("error",m.error||void 0);n.data("est_delivery",m.est_delivery||void 0);n.data("comment",m.comment||void 0);n.data("external",
m.external||!1);b.append(n);h||(m=(""+p).split("."),n=c.split("."),void 0!==m[0]&&(void 0!==n[0]&&m[0]==n[0])&&(h=!0,c=p))}h&&(b.val(c),(!f[c].external||e.shipping_id==c.split(".")[0])&&b.trigger($.Event("change",{triggered_by_updateTotal:1})));$("#order-edit-form").trigger("order_total_updated",a.data)}},"json");$("#subtotal").text($.order_edit.formatFloat(Math.round(100*d)/100));a=$.order_edit.parseFloat($("#shipping-rate").val().replace(",","."))||0;a=d+a;0>b?(b=0,c.val("")):(0>a-b&&(b=a),c.val($.order_edit.formatFloat(Math.round(100*
b)/100)));c=a-b;$("#total").text($.order_edit.formatFloat(Math.round(100*c)/100))}else $("#subtotal").text(0),$("#total").text(0)},editSubmit:function(){var a=this.form;$.shop.jsonPost(a.attr("action"),a.serialize(),function(){$.order_edit.container.find(".back").click()},function(a){$.shop.trace("editSubmit",a);$(".s-order-items-edit td.save i.loading").hide();if(a&&a.errors&&!$.isEmptyObject(a.errors))return $.order_edit.showValidateErrors(a.errors),$(".s-orders-services input:disabled",this.form).attr("disabled",
!1),!1})},addSubmit:function(){var a=this.form;$.shop.trace("addSubmit",$(a));$.shop.jsonPost(a.attr("action"),a.serialize(),function(a){$.order_edit.slide(!1,!0)&&(location.href="#/orders/state_id=new&view=split&id="+a.data.order.id+"/")},function(a){$.shop.trace("addSubmit",a);$(".s-order-items-edit td.save i.loading").hide();if(a&&a.errors&&!$.isEmptyObject(a.errors))return $.order_edit.showValidateErrors(a.errors),$(".s-orders-services input:disabled",this.form).attr("disabled",!1),!1})},formatFloat:function(a){return","===
this.float_delimeter?(""+a).replace(".",","):""+a},parseFloat:function(a){return a?parseFloat((""+a).replace(",",".")):0},slideBack:function(){this.slide(!1,"add"==this.options.mode)},slide:function(a,b,d){if(0==arguments.length)this.slide(!0,"add"==this.options.mode);else{var a="undefined"===typeof a?!0:a,b="undefined"===typeof b?!1:b,c=this.options.duration||200,e=this.options.view,f=[];return!this.slide_on&&a?(f.push($("#s-sidebar").animate({width:0},c,function(){$(this).hide()})),$(".s-level2").hide(),
f.push($("#maincontent").animate({"margin-top":45},c)),f.push($("#s-content").animate({"margin-left":0},c)),f.push($("#s-orders").animate({width:0},c,function(){$(this).hide()})),f.push($("#s-order").animate({"margin-left":0},c).find(">div:first").removeClass("double-padded, bordered-left").find("h1 .back.order-list").hide().end().find("h1 .back.read-mode").show()),this.slide_on=!0,$(".s-order-readable").hide(),$(".s-order-editable").show(),$.when(f).done(function(){$.order_list.lazy_load_win&&$.order_list.lazy_load_win.lazyLoad("sleep");
"function"===typeof d&&d.call(this)}),!0):this.slide_on&&!a?(f.push($("#s-order").animate({"margin-left":"table"!=e&&!b?300:200},c).find(">div:first").addClass("double-padded, bordered-left").find("h1 .back.order-list").show().end().find("h1 .back.read-mode").hide()),f.push($("#s-orders").animate({width:300},c).show()),f.push($("#s-content").animate({"margin-left":200},c)),f.push($("#maincontent").animate({"margin-top":84},c)),$(".s-level2").show(),f.push($("#s-sidebar").animate({width:200},c).show()),
this.slide_on=!1,$(".s-order-editable").hide(),$(".s-order-readable").show(),$.when(f).done(function(){$.order_list.lazy_load_win&&$.order_list.lazy_load_win.lazyLoad("wake");"function"===typeof d&&d.call(this)}),!0):!1}},showValidateErrors:function(a){$(".error").removeClass("error");$("#s-order-edit-customer .errormsg").empty();if(a&&a.customer){var b=a.customer;$.order_edit.customer_fields.find(".field-group:first").html(b.html);delete b.html;for(var d in b)$.order_edit.customer_fields.find(".s-error-customer-"+
d).each(function(){var a=$(this);"EM"==this.tagName?a.text(b[d]):a.addClass("error")})}var c=[];$(".s-order-errors").empty();if(a&&a.order){if(!$.isEmptyObject(a.order.items))for(var e in a.order.items){var f=$(".s-order-item[data-index="+e+"]"),b=a.order.items[e];for(d in b)f.find(".s-error-item-"+d).text(b[d]);delete a.order.items[e]}if(!$.isEmptyObject(a.order.product)){var h=a.order.product,g;for(g in h)h.hasOwnProperty(g)&&"quantity"in h[g]&&$(".s-order-item[data-product-id="+g+"]").each(function(){if($(this).find("ul.s-orders-skus input:radio:checked").val()==
""+h[g].sku_id||!$(this).find("ul.s-orders-skus").length)$(this).find(".s-orders-quantity").addClass("error"),c.push(h[g].quantity)})}a.order.common&&c.push(a.order.common);c.length&&$(".s-order-errors").html(c.join("<br>"))}},bindValidateErrorPlaceholders:function(){for(var a=["firstname","middlename","lastname"],b=0,d=a.length;b<d;b+=1)$.order_edit.customer_inputs.filter("[name="+$.order_edit.inputName(a[b])+"]").addClass("s-error-customer-name");$.order_edit.customer_fields.find(".s-error-customer-name:last").after('<em class="errormsg s-error-customer-name"></em>')},
initCustomerForm:function(a){a="undefined"===typeof a?"add":a;if("add"!==a)$.order_edit.bindValidateErrorPlaceholders();else{var b=$("#customer-autocomplete"),d=function(a){a="undefined"===typeof a?!0:a;$("#s-customer-id").attr("disabled",a);a?$("#s-order-edit-customer").addClass("s-opaque"):$("#s-order-edit-customer").removeClass("s-opaque")},c=function(a){"undefined"===typeof a||a?(d(!1),b.val("").hide(200)):(d(),$.order_edit.customer_inputs.val(""),b.val("").show())};$.order_edit.bindValidateErrorPlaceholders();
c(!1);$.order_edit.customer_fields.off("focus",":input").on("focus",":input",function(){d(!1)});"add"==a&&$("#s-order-new-customer").click(function(){$.order_edit.customer_fields.find(".field-group:first").find(":input").val("");c();$.order_edit.customer_inputs.first().focus();$("#s-customer-id").val(0);return!1});var e="";b.autocomplete({source:function(a,b){e=a.term;$.getJSON($.order_edit.options.autocomplete_url,a,function(a){(a=a||[]).push({label:$_("New customer"),name:$_("New customer"),value:0});
b(a)})},delay:300,minLength:3,select:function(a,b){var d=b.item,i=function(){var a=!1;$.order_edit.customer_inputs.filter("input[type=text], textarea").each(function(){var b=$(this);if(b.is(":not(:hidden)")&&!this.value)return a=!0,b.focus(),!1});a||$.order_edit.customer_inputs.first().focus()};if(d.value)$.get("?action=contactForm&id="+d.value,function(a){$.order_edit.customer_fields.find(".field-group:first").html(a);$.order_edit.customer_inputs=$.order_edit.customer_fields.find(":input");$("#s-customer-id").val(d.value);
c();setTimeout(function(){i()},200)});else{var k="[name="+$.order_edit.inputName(parseInt(e,10)||"+"==e.substr(0,1)||-1!==e.indexOf("(")?"phone":-1!==e.indexOf("@")?"email":"firstname")+"]";$.order_edit.customer_inputs.filter(k).val(e);$("#s-customer-id").val(0);c();setTimeout(function(){i()},200)}return!1},focus:function(a,b){this.value=b.item.name;return!1}});$("#order-add-form").submit(function(){d(!1)})}},inputName:function(a){return'"customer['+a+']"'},getPercentSymbol:function(){return"%"}};
